<!DOCTYPE html>
<html lang="tr" data-lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BAZ AI Cover Designer - Nano Banana</title>
    <link rel="icon" type="image/png" href="/baz-logo.png">
    <link rel="apple-touch-icon" href="/baz-logo.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #000000; --bg-secondary: #0a0a0a; --bg-tertiary: #111111;
            --bg-card: #161616; --bg-input: #1a1a1a; --bg-hover: #222222;
            --text-primary: #ffffff; --text-secondary: #a0a0a0; --text-muted: #555555;
            --accent: #2596be; --accent-light: #3ab4e0; --accent-dark: #1d7a9c;
            --border: #262626; --border-focus: #2596be; --success: #22c55e; --error: #ef4444;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
            background: var(--bg-primary); 
            color: var(--text-primary); 
            min-height: 100vh; 
            line-height: 1.4; 
        }
        
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 8px 20px; 
            background: var(--bg-secondary); 
            border-bottom: 1px solid var(--border); 
            position: sticky; 
            top: 0; 
            z-index: 100; 
        }
        .logo { display: flex; align-items: center; gap: 8px; font-size: 1.1rem; font-weight: 700; color: var(--text-primary); }
        .logo-icon { width: 28px; height: 28px; background: var(--accent); border-radius: 6px; display: flex; align-items: center; justify-content: center; }
        .header-right { display: flex; align-items: center; gap: 10px; }
        
        /* Kredi Sistemi Stilleri */
        .credit-display {
            display: flex; align-items: center; gap: 12px; padding: 6px 14px;
            background: linear-gradient(135deg, rgba(37, 150, 190, 0.2), rgba(37, 150, 190, 0.05));
            border: 1px solid rgba(37, 150, 190, 0.4); border-radius: 10px; margin-right: 12px;
        }
        .credit-info { display: flex; align-items: center; gap: 6px; }
        .credit-icon { font-size: 18px; }
        .credit-count { font-size: 20px; font-weight: 700; color: #2596be; min-width: 30px; text-align: center; }
        .credit-label { font-size: 10px; color: #a0a0a0; text-transform: uppercase; }
        .credit-details { display: flex; flex-direction: column; align-items: flex-start; gap: 2px; }
        .plan-badge { font-size: 9px; font-weight: 600; padding: 2px 8px; background: #6b7280; color: white; border-radius: 4px; text-transform: uppercase; }
        .plan-badge.temel { background: linear-gradient(135deg, #22c55e, #16a34a); }
        .plan-badge.uzman { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .plan-badge.pro { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .plan-badge.deneme { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .days-left { font-size: 9px; color: #6b7280; }
        .change-plan-btn { display: flex; align-items: center; gap: 4px; padding: 6px 10px; background: rgba(37, 150, 190, 0.2); border: 1px solid rgba(37, 150, 190, 0.4); color: #2596be; border-radius: 6px; font-size: 10px; font-weight: 500; text-decoration: none; transition: all 0.2s; margin-left: 8px; }
        .change-plan-btn:hover { background: #2596be; color: white; }
        
        .login-btn { display: flex; align-items: center; gap: 6px; padding: 8px 16px; background: linear-gradient(135deg, #2596be, #1d7a9c); color: white; border: none; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s; margin-right: 10px; }
        .login-btn:hover { background: linear-gradient(135deg, #3ab4e0, #2596be); }
        
        .user-menu { position: relative; }
        .user-btn { display: flex; align-items: center; gap: 8px; padding: 6px 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); cursor: pointer; }
        .user-avatar { width: 28px; height: 28px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; }
        .user-dropdown { position: absolute; top: 100%; right: 0; margin-top: 8px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; min-width: 200px; display: none; z-index: 1000; overflow: hidden; }
        .user-dropdown.active { display: block; }
        .user-dropdown-item { display: flex; align-items: center; gap: 10px; padding: 12px 16px; color: var(--text-primary); text-decoration: none; font-size: 13px; cursor: pointer; border: none; background: none; width: 100%; text-align: left; }
        .user-dropdown-item:hover { background: var(--bg-hover); }
        .user-dropdown-divider { height: 1px; background: var(--border); margin: 4px 0; }
        
        .lang-switcher { display: flex; background: var(--bg-tertiary); border-radius: 6px; padding: 2px; border: 1px solid var(--border); }
        .lang-btn { padding: 4px 10px; border: none; background: transparent; color: var(--text-secondary); cursor: pointer; border-radius: 4px; font-size: 11px; font-weight: 500; transition: all 0.2s; }
        .lang-btn.active { background: var(--accent); color: var(--text-primary); }
        
        /* Main Layout */
        .main-container { display: flex; min-height: calc(100vh - 50px); }
        @media (max-width: 768px) { .main-container { flex-direction: column; } }
        
        .sidebar { 
            width: 380px; 
            background: var(--bg-secondary); 
            border-right: 1px solid var(--border); 
            padding: 20px; 
            overflow-y: auto; 
            flex-shrink: 0; 
        }
        @media (max-width: 768px) { .sidebar { width: 100%; border-right: none; border-bottom: 1px solid var(--border); } }
        
        .preview-area { 
            flex: 1; 
            background: #050505; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            padding: 40px; 
            min-height: 500px;
            position: relative;
        }
        
        /* Loading Container */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            width: 100%;
            height: 100%;
        }
        
        /* Form Elements */
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 10px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
        .form-input, .form-select, .form-textarea { 
            width: 100%; padding: 12px 14px; background: var(--bg-input); border: 1px solid var(--border); 
            border-radius: 10px; color: var(--text-primary); font-size: 13px; font-family: inherit; transition: all 0.2s; 
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--accent); }
        .form-textarea { resize: none; min-height: 80px; }
        .form-select { appearance: none; cursor: pointer; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23555555' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 10px center; background-size: 16px; padding-right: 36px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        
        /* Mode Tabs */
        .mode-tabs { display: flex; gap: 8px; margin-bottom: 20px; }
        .mode-tab { 
            flex: 1; padding: 10px 16px; border: 1px solid var(--border); background: transparent; 
            color: var(--text-secondary); cursor: pointer; border-radius: 10px; font-size: 11px; 
            font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; transition: all 0.2s; 
        }
        .mode-tab.active { background: var(--accent); border-color: var(--accent); color: white; }
        .mode-tab:hover:not(.active) { background: var(--bg-hover); color: var(--text-primary); }
        
        /* Font Options */
        .font-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .font-option { 
            padding: 10px; border: 1px solid var(--border); background: var(--bg-input); 
            border-radius: 8px; cursor: pointer; text-align: center; font-size: 11px; transition: all 0.2s; 
        }
        .font-option.active { border-color: var(--accent); background: rgba(37, 150, 190, 0.1); }
        .font-option:hover:not(.active) { border-color: var(--text-muted); }
        
        /* Reference Image */
        .ref-section { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
        .ref-preview { display: flex; align-items: center; gap: 8px; }
        .ref-thumb { width: 40px; height: 40px; object-fit: cover; border-radius: 6px; border: 1px solid var(--accent); }
        .ref-remove { color: var(--error); cursor: pointer; padding: 4px; }
        .ref-upload-btn { padding: 8px 16px; background: var(--bg-input); border: 1px dashed var(--border); border-radius: 8px; cursor: pointer; font-size: 11px; color: var(--text-secondary); transition: all 0.2s; }
        .ref-upload-btn:hover { border-color: var(--accent); color: var(--accent); }
        
        /* Generate Button */
        .generate-btn { 
            width: 100%; padding: 14px 20px; background: var(--accent); color: white; border: none; 
            border-radius: 12px; font-size: 12px; font-weight: 700; text-transform: uppercase; 
            letter-spacing: 1px; cursor: pointer; transition: all 0.2s; display: flex; 
            align-items: center; justify-content: center; gap: 8px; margin-top: 20px;
        }
        .generate-btn:hover { background: var(--accent-light); }
        .generate-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-credit-info { font-size: 10px; opacity: 0.8; padding: 2px 8px; background: rgba(255,255,255,0.2); border-radius: 4px; }
        
        /* Credit Warning */
        .credit-warning { 
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(239, 68, 68, 0.05)); 
            border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 10px; padding: 14px; 
            margin-bottom: 16px; display: none; 
        }
        .credit-warning.active { display: block; }
        .credit-warning h4 { color: #ef4444; font-size: 13px; font-weight: 600; margin-bottom: 4px; }
        .credit-warning p { color: #a0a0a0; font-size: 11px; }
        .credit-warning-btn { display: inline-block; margin-top: 10px; padding: 8px 16px; background: #ef4444; color: white; text-decoration: none; border-radius: 6px; font-size: 12px; font-weight: 500; }
        
        /* Preview */
        .preview-placeholder { text-align: center; color: var(--text-muted); }
        .preview-placeholder p { font-size: 13px; font-style: italic; max-width: 300px; }
        .preview-image { max-width: 100%; max-height: 70vh; object-fit: contain; border-radius: 4px; box-shadow: 0 20px 60px rgba(0,0,0,0.5); cursor: zoom-in; }
        
        /* Loading */
        .loading-spinner { 
            width: 60px; height: 60px; border: 3px solid var(--border); 
            border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; 
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { margin-top: 16px; font-size: 14px; color: var(--accent); text-transform: uppercase; letter-spacing: 2px; font-weight: 600; }
        .loading-sub { margin-top: 8px; font-size: 12px; color: var(--text-secondary); }
        .loading-time { margin-top: 12px; font-size: 11px; color: var(--text-muted); }
        .loading-progress {
            width: 200px;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            margin-top: 16px;
            overflow: hidden;
        }
        .loading-progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--accent), var(--accent-light));
            border-radius: 2px;
            transition: width 0.5s ease;
        }
        .loading-elapsed {
            margin-top: 8px;
            font-size: 18px;
            font-weight: 700;
            color: var(--accent);
            font-family: monospace;
        }
        
        /* Download Button */
        .download-btn { 
            position: absolute; top: 20px; left: 20px; padding: 10px 20px; 
            background: rgba(0,0,0,0.7); border: 1px solid var(--border); color: white; 
            border-radius: 20px; font-size: 11px; font-weight: 600; cursor: pointer; 
            backdrop-filter: blur(10px); transition: all 0.2s; text-transform: uppercase; letter-spacing: 1px;
        }
        .download-btn:hover { background: white; color: black; }
        .download-btn:disabled { opacity: 0; pointer-events: none; }
        
        /* Gallery Styles */
        .gallery-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .gallery-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 0 16px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 16px;
            flex-shrink: 0;
        }
        .gallery-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .gallery-count {
            font-size: 11px;
            color: var(--text-muted);
        }
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 16px;
            overflow-y: auto;
            padding-right: 8px;
            flex: 1;
        }
        .gallery-grid::-webkit-scrollbar { width: 6px; }
        .gallery-grid::-webkit-scrollbar-track { background: transparent; }
        .gallery-grid::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 3px; }
        
        .gallery-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            background: var(--bg-card);
        }
        .gallery-item:hover {
            border-color: var(--accent);
            transform: scale(1.02);
        }
        .gallery-item.latest {
            border-color: var(--accent);
            box-shadow: 0 0 20px rgba(37, 150, 190, 0.3);
        }
        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .gallery-item-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, transparent 50%);
            opacity: 0;
            transition: opacity 0.3s;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 12px;
        }
        .gallery-item:hover .gallery-item-overlay {
            opacity: 1;
        }
        .gallery-item-actions {
            display: flex;
            gap: 8px;
        }
        .gallery-action-btn {
            flex: 1;
            padding: 8px;
            background: rgba(255,255,255,0.15);
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            backdrop-filter: blur(10px);
            transition: all 0.2s;
            text-transform: uppercase;
        }
        .gallery-action-btn:hover {
            background: var(--accent);
        }
        .gallery-item-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            padding: 4px 8px;
            background: var(--accent);
            color: white;
            font-size: 9px;
            font-weight: 700;
            border-radius: 4px;
            text-transform: uppercase;
        }
        .gallery-delete-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            background: rgba(239, 68, 68, 0.9);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        .gallery-item:hover .gallery-delete-btn {
            opacity: 1;
        }
        .gallery-delete-btn:hover {
            background: #dc2626;
            transform: scale(1.1);
        }
        
        /* Clear Gallery Button */
        .clear-gallery-btn {
            padding: 6px 12px;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            border-radius: 6px;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .clear-gallery-btn:hover {
            border-color: var(--error);
            color: var(--error);
        }
        
        /* Fullscreen Modal */
        .fullscreen-modal { 
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); 
            z-index: 5000; align-items: center; justify-content: center; padding: 20px; 
        }
        .fullscreen-modal.active { display: flex; }
        .fullscreen-modal img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .fullscreen-close { position: absolute; top: 20px; right: 20px; color: white; font-size: 32px; cursor: pointer; opacity: 0.5; }
        .fullscreen-close:hover { opacity: 1; }
        
        /* Login Modal */
        .login-modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(10px); z-index: 5000; align-items: center; justify-content: center; }
        .login-modal-overlay.active { display: flex; }
        .login-modal { background: var(--bg-card); border: 1px solid var(--border); border-radius: 20px; padding: 40px; max-width: 420px; width: 90%; text-align: center; }
        .login-modal h2 { font-size: 24px; font-weight: 700; margin-bottom: 8px; background: linear-gradient(135deg, #2596be, #3ab4e0); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .login-modal p { color: var(--text-secondary); margin-bottom: 24px; font-size: 14px; }
        .login-modal-btn { width: 100%; padding: 14px 24px; background: linear-gradient(135deg, #2596be, #1d7a9c); color: white; border: none; border-radius: 10px; font-size: 15px; font-weight: 600; cursor: pointer; margin-bottom: 12px; }
        .login-modal-close { background: transparent; border: 1px solid var(--border); color: var(--text-secondary); padding: 10px 24px; border-radius: 8px; cursor: pointer; font-size: 13px; }
        
        /* Messages */
        .message { padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; font-size: 13px; display: none; }
        .message.error { display: block; background: rgba(239, 68, 68, 0.15); border: 1px solid var(--error); color: #ff6b6b; }
        .message.success { display: block; background: rgba(34, 197, 94, 0.15); border: 1px solid var(--success); color: #4ade80; }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 3px; }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">
            <img src="/baz-logo.png" alt="BAZ" style="width: 36px; height: 36px; border-radius: 50%;">
        </div>
        <div class="header-right">
            <!-- Kredi GÃ¶stergesi -->
            <div class="credit-display" id="creditDisplay" style="display: none;">
                <div class="credit-info">
                    <span class="credit-icon">K</span>
                    <span class="credit-count" id="creditCount">0</span>
                    <span class="credit-label">Kredi</span>
                </div>
                <div class="credit-details">
                    <span class="plan-badge" id="planBadge">-</span>
                    <span class="days-left" id="daysLeft"></span>
                </div>
                <a href="https://www.burakayaz.com/abonelik-sat%C4%B1n-al" class="change-plan-btn" id="changePlanBtn" title="PlanÄ± DeÄŸiÅŸtir">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                        <path d="M2 17l10 5 10-5"/>
                        <path d="M2 12l10 5 10-5"/>
                    </svg>
                    PlanÄ± DeÄŸiÅŸtir
                </a>
            </div>
            
            <!-- Login Butonu -->
            <button class="login-btn" id="loginBtn" onclick="showLoginModal()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                </svg>
                <span id="loginBtnText">GiriÅŸ Yap</span>
            </button>
            
            <!-- KullanÄ±cÄ± MenÃ¼sÃ¼ -->
            <div class="user-menu" id="userMenu" style="display: none;">
                <button class="user-btn" onclick="toggleUserDropdown()">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <span id="userName">KullanÄ±cÄ±</span>
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                </button>
                <div class="user-dropdown" id="userDropdown">
                    <button class="user-dropdown-item" onclick="showAccountInfo()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg>
                        Hesap Bilgileri
                    </button>
                    <div class="user-dropdown-divider"></div>
                    <button class="user-dropdown-item" onclick="logout()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                        Ã‡Ä±kÄ±ÅŸ Yap
                    </button>
                </div>
            </div>
            
            <div class="lang-switcher">
                <button class="lang-btn active" id="langTR" onclick="setLanguage('tr')">TR</button>
                <button class="lang-btn" id="langEN" onclick="setLanguage('en')">EN</button>
            </div>
        </div>
    </header>

    <div class="main-container">
        <aside class="sidebar">
            <!-- Kredi UyarÄ±sÄ± -->
            <div class="credit-warning" id="creditWarning">
                <h4 id="creditWarningTitle">Krediniz Yetersiz</h4>
                <p id="creditWarningMsg">GÃ¶rsel oluÅŸturmak iÃ§in giriÅŸ yapÄ±n veya paket satÄ±n alÄ±n.</p>
                <a href="#" class="credit-warning-btn" id="creditWarningBtn" onclick="handleCreditWarningClick(); return false;">Paket SatÄ±n Al â†’</a>
            </div>
            
            <div class="message" id="errorMsg"></div>
            <div class="message" id="successMsg"></div>
            
            <!-- Mode Tabs -->
            <div class="mode-tabs">
                <button class="mode-tab active" id="tabCover" onclick="switchMode('COVER')">
                    <span id="tabCoverText">AlbÃ¼m KapaÄŸÄ±</span>
                </button>
                <button class="mode-tab" id="tabPhoto" onclick="switchMode('PHOTO')">
                    <span id="tabPhotoText">SanatÃ§Ä± Fotosu</span>
                </button>
            </div>
            
            <!-- Reference Image -->
            <div class="ref-section">
                <label class="form-label" style="margin-bottom: 0; color: var(--accent);" id="labelReference">Referans Foto</label>
                <div class="ref-preview" id="refPreview" style="display: none;">
                    <img src="" alt="Ref" class="ref-thumb" id="refThumb">
                    <span class="ref-remove" onclick="removeReference()">âœ•</span>
                </div>
                <label class="ref-upload-btn" id="refUploadBtn">
                    <input type="file" accept="image/*" style="display: none;" onchange="handleFileUpload(event)">
                    <span id="uploadBtnText">+ YÃ¼kle</span>
                </label>
            </div>
            
            <!-- Text on Image (COVER only) -->
            <div class="form-group" id="textOnImageGroup">
                <label class="form-label" id="labelTextOnImage">GÃ¶rsel Ãœzerindeki YazÄ±</label>
                <input type="text" class="form-input" id="textOnImage" placeholder="Ã–rn: AÅŸkÄ±n AteÅŸi - Hasan">
            </div>
            
            <!-- Prompt -->
            <div class="form-group">
                <label class="form-label" id="labelPrompt">Kapak Konsepti / Tema</label>
                <textarea class="form-textarea" id="promptInput" placeholder="Ã–rn: Gece yarÄ±sÄ± sisli bir ÅŸehirde yalnÄ±z bir radyo kulesi..."></textarea>
            </div>
            
            <!-- Font Style (COVER only) -->
            <div class="form-group" id="fontStyleGroup">
                <label class="form-label" id="labelFontStyle">Font Stili</label>
                <div class="font-grid" id="fontGrid">
                    <div class="font-option active" data-font="Modern Sans" style="font-family: sans-serif; font-weight: bold;">Modern Sans</div>
                    <div class="font-option" data-font="Classic Serif" style="font-family: serif; font-style: italic;">Classic Serif</div>
                    <div class="font-option" data-font="Handwritten" style="font-family: cursive;">Handwritten</div>
                    <div class="font-option" data-font="Cyber/Futuristic" style="font-family: monospace; text-transform: uppercase; letter-spacing: 1px;">Cyber</div>
                    <div class="font-option" data-font="Gothic/Metal" style="font-family: serif; font-weight: 900; text-transform: uppercase;">Gothic</div>
                    <div class="font-option" data-font="Minimalist" style="font-family: sans-serif; font-weight: 100; letter-spacing: 2px;">Minimalist</div>
                </div>
            </div>
            
            <!-- Style & Color -->
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" id="labelStyle">Stil</label>
                    <select class="form-select" id="styleSelect">
                        <option value="Hiper Realistik">Hiper Realistik</option>
                        <option value="Arabesk">Arabesk</option>
                        <option value="Pop">Pop</option>
                        <option value="Minimalist">Minimalist</option>
                        <option value="Futuristik">Futuristik</option>
                        <option value="Retro">Retro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" id="labelColor">Renk</label>
                    <select class="form-select" id="colorSelect">
                        <option value="Orijinal">Orijinal</option>
                        <option value="Monokrom">Monokrom</option>
                        <option value="Pastel">Pastel</option>
                        <option value="Neon">Neon</option>
                        <option value="Noir">Noir</option>
                    </select>
                </div>
            </div>
            
            <!-- Aspect Ratio - Nano Banana supports: 1:1, 9:16, 16:9, 3:4, 4:3, 3:2, 2:3, 5:4, 4:5, 21:9, auto -->
            <div class="form-group">
                <label class="form-label" id="labelAspectRatio">En Boy OranÄ±</label>
                <select class="form-select" id="aspectRatio">
                    <option value="1:1">1:1 (Kare)</option>
                    <option value="3:4">3:4 (Portre)</option>
                    <option value="4:3">4:3 (Yatay)</option>
                    <option value="9:16">9:16 (Dikey Story)</option>
                    <option value="16:9">16:9 (GeniÅŸ Ekran)</option>
                    <option value="3:2">3:2 (FotoÄŸraf)</option>
                    <option value="2:3">2:3 (Portre FotoÄŸraf)</option>
                    <option value="auto">Otomatik</option>
                </select>
            </div>
            
            <!-- Generate Button -->
            <button class="generate-btn" id="generateBtn" onclick="handleGenerate()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
                </svg>
                <span id="generateBtnText">TasarÄ±mÄ± OluÅŸtur</span>
                <span class="btn-credit-info">1 Kredi</span>
            </button>
        </aside>
        
        <main class="preview-area" id="previewArea">
            <button class="download-btn" id="downloadBtn" onclick="downloadImage()" disabled>
                GÃ¶rseli Ä°ndir
            </button>
            
            <div id="previewContent" style="width: 100%; height: 100%;">
                <div class="gallery-container" id="galleryContainer">
                    <div class="gallery-header">
                        <span class="gallery-title" id="galleryTitle">OluÅŸturulan GÃ¶rseller</span>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span class="gallery-count" id="galleryCount">0 gÃ¶rsel</span>
                            <button class="clear-gallery-btn" id="clearGalleryBtn" onclick="clearGallery()" style="display: none;">Temizle</button>
                        </div>
                    </div>
                    <div class="gallery-grid" id="galleryGrid">
                        <!-- GÃ¶rseller buraya gelecek -->
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Fullscreen Modal -->
    <div class="fullscreen-modal" id="fullscreenModal" onclick="closeFullscreen()">
        <span class="fullscreen-close">&times;</span>
        <img src="" alt="Fullscreen" id="fullscreenImage" onclick="event.stopPropagation()">
    </div>
    
    <!-- Login Modal -->
    <div class="login-modal-overlay" id="loginModal">
        <div class="login-modal">
            <img src="/baz-logo.png" alt="BAZ" style="width: 80px; height: 80px; border-radius: 50%; margin-bottom: 16px;">
            <h2>BAZ AI Cover Designer</h2>
            <p id="loginModalText">GÃ¶rsel oluÅŸturmak iÃ§in hesabÄ±nÄ±za giriÅŸ yapmanÄ±z gerekiyor.</p>
            <button class="login-modal-btn" onclick="redirectToWixLogin()">
                <span id="loginModalBtnText">GiriÅŸ Yap / KayÄ±t Ol</span>
            </button>
            <button class="login-modal-close" onclick="closeLoginModal()">
                <span id="loginModalCloseText">Kapat</span>
            </button>
        </div>
    </div>

    <script>
        // ==================== STATE ====================
        let currentMode = 'COVER';
        let currentLang = 'tr';
        let selectedFont = 'Modern Sans';
        let referenceImage = null;
        let generatedImageUrl = null;
        let isGenerating = false;
        let generatedImages = []; // Galeri iÃ§in tÃ¼m gÃ¶rseller
        
        // ==================== TRANSLATIONS ====================
        const translations = {
            tr: {
                tabCover: 'AlbÃ¼m KapaÄŸÄ±',
                tabPhoto: 'SanatÃ§Ä± Fotosu',
                labelReference: 'Referans Foto',
                uploadBtn: '+ YÃ¼kle',
                labelTextOnImage: 'GÃ¶rsel Ãœzerindeki YazÄ±',
                labelPrompt: 'Kapak Konsepti / Tema',
                labelPromptPhoto: 'GÃ¶rsel DetaylarÄ±',
                placeholderPrompt: 'Ã–rn: Gece yarÄ±sÄ± sisli bir ÅŸehirde yalnÄ±z bir radyo kulesi...',
                placeholderPromptPhoto: 'Ã–rn: Uzun saÃ§lÄ± mÃ¼zisyen, stÃ¼dyo ortamÄ±...',
                labelFontStyle: 'Font Stili',
                labelStyle: 'Stil',
                labelColor: 'Renk',
                labelAspectRatio: 'En Boy OranÄ±',
                generateBtn: 'TasarÄ±mÄ± OluÅŸtur',
                generatingBtn: 'TasarlanÄ±yor...',
                downloadBtn: 'GÃ¶rseli Ä°ndir',
                placeholder: 'AyarlarÄ± tamamlayÄ±p "TasarÄ±mÄ± OluÅŸtur" butonuna basÄ±n.',
                loadingText: 'GÃ¶rsel oluÅŸturuluyor',
                loadingSub: 'Yapay zeka fÄ±rÃ§alarÄ±nÄ± hazÄ±rlÄ±yor...',
                loadingTime: 'Tahmini sÃ¼re: 1-2 dakika',
                statusQueued: 'SÄ±raya alÄ±ndÄ±...',
                statusGenerating: 'GÃ¶rsel iÅŸleniyor...',
                statusFinalizing: 'TamamlanÄ±yor...',
                creditWarningTitle: 'Krediniz Yetersiz',
                creditWarningMsg: 'GÃ¶rsel oluÅŸturmak iÃ§in giriÅŸ yapÄ±n veya paket satÄ±n alÄ±n.',
                creditWarningBtn: 'Paket SatÄ±n Al â†’',
                galleryTitle: 'OluÅŸturulan GÃ¶rseller',
                galleryCount: 'gÃ¶rsel',
                galleryClear: 'Temizle',
                galleryNew: 'YENÄ°',
                galleryDownload: 'Ä°ndir',
                galleryView: 'GÃ¶rÃ¼ntÃ¼le',
                loginBtn: 'GiriÅŸ Yap',
                loginModalText: 'GÃ¶rsel oluÅŸturmak iÃ§in hesabÄ±nÄ±za giriÅŸ yapmanÄ±z gerekiyor.',
                loginModalBtn: 'GiriÅŸ Yap / KayÄ±t Ol',
                loginModalClose: 'Kapat',
                errorNoPrompt: 'LÃ¼tfen bir konsept/tema girin.',
                errorNoText: 'LÃ¼tfen gÃ¶rsel Ã¼zerindeki yazÄ±yÄ± girin.',
                errorApi: 'GÃ¶rsel oluÅŸturulurken bir hata oluÅŸtu.'
            },
            en: {
                tabCover: 'Album Cover',
                tabPhoto: 'Artist Photo',
                labelReference: 'Reference Photo',
                uploadBtn: '+ Upload',
                labelTextOnImage: 'Text on Image',
                labelPrompt: 'Cover Concept / Theme',
                labelPromptPhoto: 'Visual Details',
                placeholderPrompt: 'Ex: A lonely radio tower in a foggy city at midnight...',
                placeholderPromptPhoto: 'Ex: Long-haired musician, studio environment...',
                labelFontStyle: 'Font Style',
                labelStyle: 'Style',
                labelColor: 'Color',
                labelAspectRatio: 'Aspect Ratio',
                generateBtn: 'Create Design',
                generatingBtn: 'Designing...',
                downloadBtn: 'Download Image',
                placeholder: 'Complete the settings and click "Create Design".',
                loadingText: 'Generating image',
                loadingSub: 'AI is preparing brushes...',
                loadingTime: 'Estimated time: 1-2 minutes',
                statusQueued: 'Queued...',
                statusGenerating: 'Processing image...',
                statusFinalizing: 'Finalizing...',
                creditWarningTitle: 'Insufficient Credits',
                creditWarningMsg: 'Please login or purchase a package to create images.',
                creditWarningBtn: 'Buy Package â†’',
                galleryTitle: 'Generated Images',
                galleryCount: 'images',
                galleryClear: 'Clear',
                galleryNew: 'NEW',
                galleryDownload: 'Download',
                galleryView: 'View',
                loginBtn: 'Login',
                loginModalText: 'You need to login to create images.',
                loginModalBtn: 'Login / Register',
                loginModalClose: 'Close',
                errorNoPrompt: 'Please enter a concept/theme.',
                errorNoText: 'Please enter the text for the image.',
                errorApi: 'An error occurred while creating the image.'
            }
        };
        
        function setLanguage(lang) {
            currentLang = lang;
            const t = translations[lang];
            
            document.getElementById('langTR').classList.toggle('active', lang === 'tr');
            document.getElementById('langEN').classList.toggle('active', lang === 'en');
            
            document.getElementById('tabCoverText').textContent = t.tabCover;
            document.getElementById('tabPhotoText').textContent = t.tabPhoto;
            document.getElementById('labelReference').textContent = t.labelReference;
            document.getElementById('uploadBtnText').textContent = t.uploadBtn;
            document.getElementById('labelTextOnImage').textContent = t.labelTextOnImage;
            document.getElementById('labelFontStyle').textContent = t.labelFontStyle;
            document.getElementById('labelStyle').textContent = t.labelStyle;
            document.getElementById('labelColor').textContent = t.labelColor;
            document.getElementById('labelAspectRatio').textContent = t.labelAspectRatio;
            document.getElementById('generateBtnText').textContent = isGenerating ? t.generatingBtn : t.generateBtn;
            document.getElementById('downloadBtn').textContent = t.downloadBtn;
            document.getElementById('galleryTitle').textContent = t.galleryTitle;
            document.getElementById('clearGalleryBtn').textContent = t.galleryClear;
            updateGalleryCount();
            document.getElementById('creditWarningTitle').textContent = t.creditWarningTitle;
            document.getElementById('creditWarningMsg').textContent = t.creditWarningMsg;
            document.getElementById('creditWarningBtn').textContent = t.creditWarningBtn;
            document.getElementById('loginBtnText').textContent = t.loginBtn;
            document.getElementById('loginModalText').textContent = t.loginModalText;
            document.getElementById('loginModalBtnText').textContent = t.loginModalBtn;
            document.getElementById('loginModalCloseText').textContent = t.loginModalClose;
            
            updateModeUI();
        }
        
        function switchMode(mode) {
            currentMode = mode;
            document.getElementById('tabCover').classList.toggle('active', mode === 'COVER');
            document.getElementById('tabPhoto').classList.toggle('active', mode === 'PHOTO');
            updateModeUI();
        }
        
        function updateModeUI() {
            const t = translations[currentLang];
            const isCover = currentMode === 'COVER';
            
            document.getElementById('textOnImageGroup').style.display = isCover ? 'block' : 'none';
            document.getElementById('fontStyleGroup').style.display = isCover ? 'block' : 'none';
            
            document.getElementById('labelPrompt').textContent = isCover ? t.labelPrompt : t.labelPromptPhoto;
            document.getElementById('promptInput').placeholder = isCover ? t.placeholderPrompt : t.placeholderPromptPhoto;
        }
        
        // ==================== FONT SELECTION ====================
        document.querySelectorAll('.font-option').forEach(opt => {
            opt.addEventListener('click', function() {
                document.querySelectorAll('.font-option').forEach(o => o.classList.remove('active'));
                this.classList.add('active');
                selectedFont = this.dataset.font;
            });
        });
        
        // ==================== REFERENCE IMAGE ====================
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onloadend = () => {
                    referenceImage = reader.result;
                    document.getElementById('refThumb').src = referenceImage;
                    document.getElementById('refPreview').style.display = 'flex';
                    document.getElementById('refUploadBtn').style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        }
        
        function removeReference() {
            referenceImage = null;
            document.getElementById('refPreview').style.display = 'none';
            document.getElementById('refUploadBtn').style.display = 'block';
        }
        
        // ==================== MESSAGES ====================
        function showError(msg) {
            const el = document.getElementById('errorMsg');
            el.textContent = msg;
            el.classList.add('error');
            setTimeout(() => { el.classList.remove('error'); el.textContent = ''; }, 5000);
        }
        
        function showSuccess(msg) {
            const el = document.getElementById('successMsg');
            el.textContent = msg;
            el.classList.add('success');
            setTimeout(() => { el.classList.remove('success'); el.textContent = ''; }, 3000);
        }
        
        // ==================== GENERATE ====================
        async function handleGenerate() {
            const t = translations[currentLang];
            
            if (!canProcess()) return;
            
            const prompt = document.getElementById('promptInput').value.trim();
            const textOnImage = document.getElementById('textOnImage').value.trim();
            
            if (!prompt) {
                showError(t.errorNoPrompt);
                return;
            }
            
            if (currentMode === 'COVER' && !textOnImage) {
                showError(t.errorNoText);
                return;
            }
            
            const style = document.getElementById('styleSelect').value;
            const color = document.getElementById('colorSelect').value;
            const aspectRatio = document.getElementById('aspectRatio').value;
            
            // Build the full prompt
            let fullPrompt = '';
            const colorPrompt = color === 'Orijinal' ? 'natural and original colors, realistic lighting' : color;
            
            if (currentMode === 'COVER') {
                fullPrompt = `Professional album cover art. Artistic Style: ${style}. Typography/Font: ${selectedFont}. 
                Core Theme: ${prompt}. 
                STRICT TEXT RULE: Only include the exact text: "${textOnImage}". Do NOT add any other words, letters, dates, or placeholder text. 
                The text "${textOnImage}" should be prominent and follow the ${selectedFont} style. 
                Color Palette: ${colorPrompt}. High quality, artistic, 4k resolution.`;
            } else {
                fullPrompt = `Professional artist press photo/portrait. Style: ${style}. 
                Subject description: ${prompt}. 
                Cinematic, high-end photography, 8k resolution, realistic textures. Color Palette: ${colorPrompt}. No extra text.`;
            }
            
            if (referenceImage) {
                fullPrompt += ' Use the provided reference image as inspiration for composition and vibe.';
            }
            
            // Start loading - overlay olarak gÃ¶ster
            isGenerating = true;
            document.getElementById('generateBtn').disabled = true;
            document.getElementById('generateBtnText').textContent = t.generatingBtn;
            
            // Loading overlay ekle - geliÅŸmiÅŸ durum bilgisi ile
            const loadingOverlay = document.createElement('div');
            loadingOverlay.id = 'loadingOverlay';
            loadingOverlay.style.cssText = 'position: absolute; inset: 0; background: rgba(0,0,0,0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 50;';
            loadingOverlay.innerHTML = `
                <div class="loading-spinner"></div>
                <p class="loading-text" id="loadingStatusText">${t.loadingText}</p>
                <p class="loading-sub" id="loadingStatusSub">${t.statusQueued}</p>
                <p class="loading-time" id="loadingTime">${t.loadingTime}</p>
                <div class="loading-progress">
                    <div class="loading-progress-bar" id="loadingProgressBar"></div>
                </div>
                <p class="loading-elapsed" id="loadingElapsed">00:00</p>
            `;
            document.getElementById('previewArea').appendChild(loadingOverlay);
            
            // SÃ¼re sayacÄ± baÅŸlat
            const startTime = Date.now();
            window.loadingTimer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const mins = Math.floor(elapsed / 60).toString().padStart(2, '0');
                const secs = (elapsed % 60).toString().padStart(2, '0');
                const elapsedEl = document.getElementById('loadingElapsed');
                if (elapsedEl) elapsedEl.textContent = `${mins}:${secs}`;
            }, 1000);
            
            try {
                // Call Nano Banana API
                const response = await fetch('/api/generate-image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: fullPrompt,
                        aspectRatio: aspectRatio,
                        outputFormat: 'png'
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok || (data.code !== 200 && !data.taskId)) {
                    throw new Error(data.msg || data.error || data.details || 'API Error');
                }
                
                const taskId = data.data ? data.data.taskId : data.taskId;
                
                // Use credits
                await useCreditsForDesign();
                
                // Poll for result
                await pollImageStatus(taskId);
                
            } catch (error) {
                console.error('Generate error:', error);
                showError(t.errorApi + ' ' + error.message);
                resetGenerateButton();
            }
        }
        
  // ==================== GÃœNCELLENMÄ°Åž DURUM SORGULAMA (index.html script iÃ§ine) ====================
        
        async function pollImageStatus(taskId) {
            const t = translations[currentLang];
            let attempts = 0;
            // SÃ¼reyi kÄ±salttÄ±k ama kontrol sÄ±klÄ±ÄŸÄ±nÄ± artÄ±rdÄ±k (Daha seri tepki iÃ§in)
            const maxAttempts = 60; 
            
            console.log("ðŸ” Durum takibi baÅŸladÄ±. Task ID:", taskId);

            const interval = setInterval(async () => {
                attempts++;
                
                // Progress bar (Suni ilerleme)
                const progress = Math.min((attempts / 20) * 100, 95);
                const progressBar = document.getElementById('loadingProgressBar');
                if (progressBar) progressBar.style.width = `${progress}%`;
                
                if (attempts > maxAttempts) {
                    clearInterval(interval);
                    if (window.loadingTimer) clearInterval(window.loadingTimer);
                    showError('Zaman aÅŸÄ±mÄ±. Ä°ÅŸlem Ã§ok uzun sÃ¼rdÃ¼.');
                    resetGenerateButton();
                    return;
                }
                
                try {
                    const res = await fetch(`/api/image-status?taskId=${taskId}`);
                    const json = await res.json();
                    
                    // Konsola detaylÄ± log basalÄ±m ki ne dÃ¶ndÃ¼ÄŸÃ¼nÃ¼ gÃ¶relim
                    console.log(`Poll Deneme #${attempts}:`, json);
                    
                    if (json.code === 200 && json.data) {
                        const data = json.data;
                        
                        // Durumu kÃ¼Ã§Ã¼k harfe Ã§evirip temizleyelim
                        // Kie bazen 'waiting', 'running', 'succeeded', 'success', 'finished' dÃ¶nebilir.
                        const rawStatus = data.status || data.state || '';
                        const status = rawStatus.toLowerCase();
                        
                        console.log(`GÃ¼ncel Durum: [${status}]`);

                        // UI GÃ¼ncelleme
                        const statusSub = document.getElementById('loadingStatusSub');
                        if (statusSub) {
                            if (['queuing', 'queued', 'pending', 'waiting'].includes(status)) {
                                statusSub.textContent = t.statusQueued;
                            } else if (['generating', 'processing', 'running', 'working'].includes(status)) {
                                statusSub.textContent = t.statusGenerating;
                            }
                        }
                        
                        // === BAÅžARI KONTROLÃœ (GeniÅŸletilmiÅŸ) ===
                        // BurasÄ± kritik: 'succeeded' kelimesini de ekledik.
                        if (['success', 'completed', 'succeeded', 'finished', 'done'].includes(status)) {
                            
                            console.log("âœ… Ä°ÅžLEM BAÅžARILI! GÃ¶rsel alÄ±nÄ±yor...");
                            clearInterval(interval);
                            if (window.loadingTimer) clearInterval(window.loadingTimer);
                            if (progressBar) progressBar.style.width = '100%';
                            
                            // GÃ¶rsel URL'sini yakala
                            const imageUrl = data.response?.images?.[0] || 
                                           data.response?.imageUrl ||
                                           data.resultJson?.images?.[0] || // Kie bazen buraya atar
                                           data.output?.image_url ||
                                           (data.images && data.images[0]);
                            
                            if (imageUrl) {
                                console.log("GÃ¶rsel URL bulundu:", imageUrl);
                                generatedImageUrl = imageUrl;
                                
                                // 1. Ekrana Bas
                                displayResult(imageUrl, taskId);
                                
                                // 2. MongoDB'ye Kaydet (Kritik Nokta)
                                if (isLoggedIn) {
                                    console.log("ðŸ’¾ MongoDB KayÄ±t Ä°ÅŸlemi Tetikleniyor...");
                                    const prompt = document.getElementById('promptInput').value;
                                    // await kullanmÄ±yoruz, arka planda yapsÄ±n
                                    saveImageToServer(taskId, imageUrl, currentMode, prompt); 
                                } else {
                                    console.warn("KullanÄ±cÄ± giriÅŸ yapmamÄ±ÅŸ, kayÄ±t atlanÄ±yor.");
                                }
                                
                                resetGenerateButton();
                            } else {
                                console.error("Durum baÅŸarÄ±lÄ± ama URL bulunamadÄ±!", data);
                                showError("GÃ¶rsel oluÅŸturuldu ama URL alÄ±namadÄ±.");
                                resetGenerateButton();
                            }
                        } 
                        // HATA KONTROLÃœ
                        else if (['fail', 'failed', 'error'].includes(status)) {
                            clearInterval(interval);
                            if (window.loadingTimer) clearInterval(window.loadingTimer);
                            const errorMsg = data.failReason || data.error || 'Ä°ÅŸlem baÅŸarÄ±sÄ±z.';
                            console.error("Ä°ÅŸlem HatasÄ±:", errorMsg);
                            showError(errorMsg);
                            resetGenerateButton();
                        }
                    }
                } catch (e) {
                    console.error('Poll dÃ¶ngÃ¼sÃ¼nde hata:', e);
                }
            }, 2000); // 2 saniyede bir kontrol et (Daha hÄ±zlÄ±)
        }

        // ==================== GÃœNCELLENMÄ°Åž KAYIT FONKSÄ°YONU ====================
        
        async function saveImageToServer(taskId, imageUrl, mode, prompt) {
            console.log("ðŸš€ saveImageToServer Ã‡ALIÅžTI. Veriler:", { taskId, mode });
            
            if (!isLoggedIn || !authToken) {
                console.error("âŒ KayÄ±t baÅŸarÄ±sÄ±z: Token yok.");
                return;
            }
            
            try {
                const response = await fetch('/api/save-image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        taskId: taskId,
                        imageUrl: imageUrl,
                        mode: mode,
                        prompt: prompt
                    })
                });
                
                const data = await response.json();
                console.log('ðŸ“¡ MongoDB YanÄ±tÄ±:', data);
                
                if (data.success) {
                    console.log("âœ… GÃ¶rsel baÅŸarÄ±yla visuals dizisine eklendi!");
                    // KullanÄ±cÄ±ya bildirim verebiliriz (Opsiyonel)
                    // showSuccess("Otomatik kaydedildi");
                } else {
                    console.error("âš ï¸ MongoDB kaydettiÄŸini sÃ¶ylemedi:", data);
                }
            } catch (error) {
                console.error('âŒ Sunucuya kayÄ±t sÄ±rasÄ±nda hata:', error);
            }
        }
        function displayResult(imageUrl, taskId) {
            // GÃ¶rseli galeriye ekle (en baÅŸa)
            const imageData = {
                url: imageUrl,
                taskId: taskId || `local_${Date.now()}`,
                timestamp: Date.now(),
                mode: currentMode
            };
            
            generatedImages.unshift(imageData);
            
            // Galeriyi localStorage'a kaydet
            saveGalleryToStorage();
            
            // Sunucuya da kaydet (giriÅŸ yapÄ±lmÄ±ÅŸsa)
            if (isLoggedIn && taskId) {
                const prompt = document.getElementById('promptInput').value;
                saveImageToServer(taskId, imageUrl, currentMode, prompt);
            }
            
            // Galeriyi gÃ¼ncelle
            renderGallery();
            
            document.getElementById('downloadBtn').disabled = false;
        }
        
        // ==================== GALERÄ° FONKSÄ°YONLARI ====================
        function renderGallery() {
            const t = translations[currentLang];
            const grid = document.getElementById('galleryGrid');
            const clearBtn = document.getElementById('clearGalleryBtn');
            
            // GeÃ§ersiz gÃ¶rselleri filtrele
            generatedImages = generatedImages.filter(img => img && img.url && img.url.startsWith('http'));
            
            if (generatedImages.length === 0) {
                grid.innerHTML = ''; // BoÅŸ bÄ±rak - mesaj yok
                clearBtn.style.display = 'none';
            } else {
                clearBtn.style.display = 'block';
                grid.innerHTML = generatedImages.map((img, index) => `
                    <div class="gallery-item ${index === 0 ? 'latest' : ''}" onclick="selectGalleryImage(${index})">
                        ${index === 0 ? `<span class="gallery-item-badge">${t.galleryNew}</span>` : ''}
                        <button class="gallery-delete-btn" onclick="event.stopPropagation(); deleteSingleImage(${index})" title="${currentLang === 'tr' ? 'Sil' : 'Delete'}">Ã—</button>
                        <img src="${img.url}" alt="Generated ${index + 1}" loading="lazy" onerror="handleImageError(this, ${index})">
                        <div class="gallery-item-overlay">
                            <div class="gallery-item-actions">
                                <button class="gallery-action-btn" onclick="event.stopPropagation(); viewGalleryImage(${index})">${t.galleryView}</button>
                                <button class="gallery-action-btn" onclick="event.stopPropagation(); downloadGalleryImage(${index})">${t.galleryDownload}</button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            updateGalleryCount();
        }
        
        // GÃ¶rsel yÃ¼klenemezse taskId ile yeniden dene
        async function handleImageError(imgElement, index) {
            const imageData = generatedImages[index];
            if (!imageData || !imageData.taskId || imageData.taskId.startsWith('local_')) {
                imgElement.style.display = 'none';
                return;
            }
            
            try {
                // Kie.ai'den gÃ¼ncel URL'yi al
                const response = await fetch(`/api/get-image?taskId=${imageData.taskId}`);
                const data = await response.json();
                
                if (data.success && data.imageUrl) {
                    imgElement.src = data.imageUrl;
                    generatedImages[index].url = data.imageUrl;
                    saveGalleryToStorage();
                } else {
                    imgElement.style.display = 'none';
                }
            } catch (error) {
                console.error('Refresh image error:', error);
                imgElement.style.display = 'none';
            }
        }
        
        // Tek gÃ¶rsel sil
        async function deleteSingleImage(index) {
            const confirmMsg = currentLang === 'tr' ? 'Bu gÃ¶rsel silinecek. Emin misiniz?' : 'This image will be deleted. Are you sure?';
            if (!confirm(confirmMsg)) return;
            
            const imageData = generatedImages[index];
            
            // Sunucudan sil
            if (isLoggedIn && imageData.taskId) {
                await deleteImageFromServer(imageData.taskId);
            }
            
            // Listeden Ã§Ä±kar
            generatedImages.splice(index, 1);
            
            if (generatedImages.length > 0) {
                generatedImageUrl = generatedImages[0].url;
            } else {
                generatedImageUrl = null;
                document.getElementById('downloadBtn').disabled = true;
            }
            
            saveGalleryToStorage();
            renderGallery();
        }
        
        function updateGalleryCount() {
            const t = translations[currentLang];
            const count = generatedImages.length;
            document.getElementById('galleryCount').textContent = `${count} ${t.galleryCount}`;
        }
        
        function selectGalleryImage(index) {
            if (generatedImages[index]) {
                generatedImageUrl = generatedImages[index].url;
                document.getElementById('downloadBtn').disabled = false;
                viewGalleryImage(index);
            }
        }
        
        function viewGalleryImage(index) {
            if (generatedImages[index]) {
                generatedImageUrl = generatedImages[index].url;
                document.getElementById('fullscreenImage').src = generatedImages[index].url;
                document.getElementById('fullscreenModal').classList.add('active');
            }
        }
        
        function downloadGalleryImage(index) {
            if (generatedImages[index]) {
                const link = document.createElement('a');
                link.href = generatedImages[index].url;
                link.download = `baz-design-${generatedImages[index].timestamp}.png`;
                link.target = '_blank';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
        
        async function clearGallery() {
            const confirmMsg = currentLang === 'tr' ? 'TÃ¼m gÃ¶rseller silinecek. Emin misiniz?' : 'All images will be deleted. Are you sure?';
            if (!confirm(confirmMsg)) return;
            
            // Sunucudan tÃ¼m gÃ¶rselleri sil
            if (isLoggedIn) {
                for (const img of generatedImages) {
                    if (img.taskId) {
                        await deleteImageFromServer(img.taskId);
                    }
                }
            }
            
            generatedImages = [];
            generatedImageUrl = null;
            
            const storageKey = currentUser ? `baz_cover_gallery_${currentUser.wixUserId}` : 'baz_cover_gallery_guest';
            localStorage.removeItem(storageKey);
            
            renderGallery();
            document.getElementById('downloadBtn').disabled = true;
        }
        
        function saveGalleryToStorage() {
            // LocalStorage'a da kaydet (offline backup)
            const toSave = generatedImages.slice(0, 20);
            const storageKey = currentUser ? `baz_cover_gallery_${currentUser.wixUserId}` : 'baz_cover_gallery_guest';
            localStorage.setItem(storageKey, JSON.stringify(toSave));
        }
        
        // Sunucuya gÃ¶rsel kaydet (MongoDB visuals dizisine)
        async function saveImageToServer(taskId, imageUrl, mode, prompt) {
            console.log("ðŸš€ MongoDB visuals dizisine kaydediliyor:", { taskId, mode });
            
            if (!isLoggedIn || !authToken) {
                console.error("âŒ KayÄ±t baÅŸarÄ±sÄ±z: Token yok.");
                return;
            }
            
            try {
                const response = await fetch('/api/save-image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        taskId: taskId,
                        imageUrl: imageUrl,
                        mode: mode,
                        prompt: prompt
                    })
                });
                
                const data = await response.json();
                console.log('ðŸ“¡ MongoDB YanÄ±tÄ±:', data);
                
                if (data.success) {
                    console.log("âœ… GÃ¶rsel baÅŸarÄ±yla visuals dizisine eklendi!");
                } else {
                    console.error("âš ï¸ MongoDB kaydettiÄŸini sÃ¶ylemedi:", data);
                }
            } catch (error) {
                console.error('âŒ Sunucuya kayÄ±t sÄ±rasÄ±nda hata:', error);
            }
        }
        
        // Sunucudan gÃ¶rselleri yÃ¼kle (MongoDB visuals dizisinden)
        async function loadImagesFromServer() {
            if (!isLoggedIn || !authToken) {
                loadGalleryFromLocalStorage();
                return;
            }
            
            try {
                const response = await fetch('/api/list-images', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const data = await response.json();
                
                console.log('ðŸ“¥ MongoDB visuals dizisinden gÃ¶rseller yÃ¼klendi:', data);
                
                if (data.success && data.images && Array.isArray(data.images)) {
                    // Sadece geÃ§erli URL'leri olan gÃ¶rselleri al
                    generatedImages = data.images.filter(img => 
                        img && img.url && typeof img.url === 'string' && img.url.startsWith('http')
                    );
                    
                    console.log('Valid images loaded:', generatedImages.length);
                    
                    if (generatedImages.length > 0) {
                        generatedImageUrl = generatedImages[0].url;
                        document.getElementById('downloadBtn').disabled = false;
                    }
                    
                    // LocalStorage'a da kaydet
                    saveGalleryToStorage();
                    renderGallery();
                } else {
                    console.log('No images from server, loading from localStorage');
                    loadGalleryFromLocalStorage();
                }
            } catch (error) {
                console.error('Load from server error:', error);
                loadGalleryFromLocalStorage();
            }
        }
        
        function loadGalleryFromLocalStorage() {
            try {
                const userKey = currentUser ? `baz_cover_gallery_${currentUser.wixUserId}` : null;
                const guestKey = 'baz_cover_gallery_guest';
                
                let saved = null;
                if (userKey) {
                    saved = localStorage.getItem(userKey);
                }
                if (!saved) {
                    saved = localStorage.getItem(guestKey);
                }
                
                if (saved) {
                    generatedImages = JSON.parse(saved);
                    if (generatedImages.length > 0) {
                        generatedImageUrl = generatedImages[0].url;
                        document.getElementById('downloadBtn').disabled = false;
                    }
                }
            } catch (e) {
                console.error('Gallery load error:', e);
                generatedImages = [];
            }
            renderGallery();
        }
        
        function loadGalleryFromStorage() {
            // GiriÅŸ yapÄ±lmÄ±ÅŸsa sunucudan, yapÄ±lmamÄ±ÅŸsa localStorage'dan yÃ¼kle
            if (isLoggedIn) {
                loadImagesFromServer();
            } else {
                loadGalleryFromLocalStorage();
            }
        }
        
        // Sunucudan gÃ¶rsel sil
        async function deleteImageFromServer(taskId) {
            if (!isLoggedIn || !authToken) return false;
            
            try {
                const response = await fetch(`/api/delete-image?taskId=${taskId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const data = await response.json();
                return data.success;
            } catch (error) {
                console.error('Delete from server error:', error);
                return false;
            }
        }
        
        function resetGenerateButton() {
            isGenerating = false;
            document.getElementById('generateBtn').disabled = false;
            document.getElementById('generateBtnText').textContent = translations[currentLang].generateBtn;
            
            // Timer'Ä± temizle
            if (window.loadingTimer) {
                clearInterval(window.loadingTimer);
                window.loadingTimer = null;
            }
            
            // Loading overlay'i kaldÄ±r
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) overlay.remove();
            
            // Galeriyi gÃ¼ncelle
            renderGallery();
        }
        
        // ==================== DOWNLOAD ====================
        function downloadImage() {
            if (!generatedImageUrl) return;
            
            const link = document.createElement('a');
            link.href = generatedImageUrl;
            link.download = `baz-design-${Date.now()}.png`;
            link.target = '_blank';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // ==================== FULLSCREEN ====================
        function openFullscreen() {
            if (!generatedImageUrl) return;
            document.getElementById('fullscreenImage').src = generatedImageUrl;
            document.getElementById('fullscreenModal').classList.add('active');
        }
        
        function closeFullscreen() {
            document.getElementById('fullscreenModal').classList.remove('active');
        }
        
        // ==================== KREDÄ° SÄ°STEMÄ° ====================
        let authToken = localStorage.getItem('bazai_token') || null;
        let currentUser = null;
        let userCredits = 0;
        let userPlan = 'none';
        let isLoggedIn = false;
        
        const WIX_SITE_URL = 'https://www.burakayaz.com';
        const WIX_PRICING_URL = WIX_SITE_URL + '/abonelik-sat%C4%B1n-al';
        
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthStatus();
            setLanguage('tr');
            loadGalleryFromStorage(); // Galeriyi yÃ¼kle
        });
        
        async function checkAuthStatus() {
            const urlParams = new URLSearchParams(window.location.search);
            const tokenFromUrl = urlParams.get('token');
            
            if (tokenFromUrl) {
                authToken = tokenFromUrl;
                localStorage.setItem('bazai_token', tokenFromUrl);
                window.history.replaceState({}, document.title, window.location.pathname);
            }
            
            if (authToken) {
                await syncUserData();
            } else {
                showLoggedOutState();
            }
        }
        
        async function syncUserData() {
            try {
                const response = await fetch('/api/auth-sync', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + authToken
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 401) { logout(); return; }
                    throw new Error('Sync failed');
                }
                
                const data = await response.json();
                
                if (data.success && data.user) {
                    currentUser = data.user;
                    userCredits = data.user.credits || 0;
                    userPlan = data.user.plan || 'none';
                    isLoggedIn = true;
                    
                    showLoggedInState();
                    updateCreditDisplay();
                    checkCreditWarning();
                } else {
                    showLoggedOutState();
                }
            } catch (error) {
                console.error('Sync error:', error);
                showLoggedOutState();
            }
        }
        
        function showLoggedInState() {
            document.getElementById('loginBtn').style.display = 'none';
            document.getElementById('creditDisplay').style.display = 'flex';
            document.getElementById('userMenu').style.display = 'block';
            
            if (currentUser) {
                const name = currentUser.displayName || (currentUser.email ? currentUser.email.split('@')[0] : 'KullanÄ±cÄ±');
                document.getElementById('userName').textContent = name;
                document.getElementById('userAvatar').textContent = name.charAt(0).toUpperCase();
                
                // KullanÄ±cÄ± giriÅŸ yaptÄ±ÄŸÄ±nda sunucudan gÃ¶rselleri yÃ¼kle
                loadImagesFromServer();
            }
        }
        
        function showLoggedOutState() {
            isLoggedIn = false;
            document.getElementById('loginBtn').style.display = 'flex';
            document.getElementById('creditDisplay').style.display = 'none';
            document.getElementById('userMenu').style.display = 'none';
            checkCreditWarning();
        }
        
        function updateCreditDisplay() {
            document.getElementById('creditCount').textContent = userCredits;
            
            const planBadge = document.getElementById('planBadge');
            const planName = userPlan.toLowerCase();
            
            const planDisplayNames = { 'temel': 'TEMEL', 'uzman': 'UZMAN', 'pro': 'PRO', 'deneme': 'DENEME', 'none': '-' };
            planBadge.textContent = planDisplayNames[planName] || userPlan.toUpperCase();
            planBadge.className = 'plan-badge ' + planName;
        }
        
        function checkCreditWarning() {
            const warning = document.getElementById('creditWarning');
            const t = translations[currentLang];
            
            if (!isLoggedIn) {
                warning.classList.add('active');
                document.getElementById('creditWarningBtn').onclick = function() { showLoginModal(); return false; };
                document.getElementById('creditWarningBtn').textContent = currentLang === 'tr' ? 'GiriÅŸ Yap â†’' : 'Login â†’';
            } else if (userCredits < 1) {
                warning.classList.add('active');
                document.getElementById('creditWarningBtn').onclick = function() { window.location.href = WIX_PRICING_URL; return false; };
                document.getElementById('creditWarningBtn').textContent = t.creditWarningBtn;
            } else {
                warning.classList.remove('active');
            }
        }
        
        function canProcess() {
            if (!isLoggedIn) {
                showLoginModal();
                return false;
            }
            if (userCredits < 1) {
                showError(currentLang === 'tr' ? 'Yetersiz kredi!' : 'Insufficient credits!');
                return false;
            }
            return true;
        }
        
        async function useCreditsForDesign() {
            if (!authToken) return;
            
            try {
                const response = await fetch('/api/use-credits', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + authToken
                    },
                    body: JSON.stringify({
                        amount: 1,
                        action: currentMode === 'COVER' ? 'cover_design' : 'photo_design'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    userCredits = data.data.remainingCredits;
                    updateCreditDisplay();
                    checkCreditWarning();
                }
            } catch (error) {
                console.error('Credit error:', error);
            }
        }
        
        function handleCreditWarningClick() {
            if (!isLoggedIn) {
                showLoginModal();
            } else {
                window.location.href = WIX_PRICING_URL;
            }
            return false;
        }
        
        // ==================== LOGIN ====================
        function showLoginModal() {
            document.getElementById('loginModal').classList.add('active');
        }
        
        function closeLoginModal() {
            document.getElementById('loginModal').classList.remove('active');
        }
        
        function redirectToWixLogin() {
            const currentUrl = window.location.origin + window.location.pathname;
            const loginUrl = WIX_SITE_URL + '/cover-redirect?redirect=' + encodeURIComponent(currentUrl);
            window.location.href = loginUrl;
        }
        
        function toggleUserDropdown() {
            document.getElementById('userDropdown').classList.toggle('active');
        }
        
        function showAccountInfo() {
            var info = 'Plan: ' + (userPlan || '-').toUpperCase() + '\n';
            info += 'Kredi: ' + userCredits + '\n';
            info += 'Email: ' + (currentUser && currentUser.email ? currentUser.email : '-');
            alert(info);
            document.getElementById('userDropdown').classList.remove('active');
        }
        
        function logout() {
            authToken = null;
            currentUser = null;
            userCredits = 0;
            userPlan = 'none';
            isLoggedIn = false;
            localStorage.removeItem('bazai_token');
            showLoggedOutState();
            document.getElementById('userDropdown').classList.remove('active');
        }
        
        // Close dropdowns on outside click
        window.onclick = function(event) {
            const userMenu = document.getElementById('userMenu');
            const dropdown = document.getElementById('userDropdown');
            if (userMenu && dropdown && !userMenu.contains(event.target)) {
                dropdown.classList.remove('active');
            }
            
            const loginModal = document.getElementById('loginModal');
            if (event.target === loginModal) {
                closeLoginModal();
            }
        };
        
        // ESC key to close fullscreen
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeFullscreen();
                closeLoginModal();
            }
        });
    </script>
</body>
</html>
