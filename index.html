<!DOCTYPE html>
<html lang="tr" data-lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BAZ AI Stem Separator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #000000; --bg-secondary: #0a0a0a; --bg-tertiary: #111111;
            --bg-card: #161616; --bg-input: #1a1a1a; --bg-hover: #222222;
            --text-primary: #ffffff; --text-secondary: #a0a0a0; --text-muted: #555555;
            --accent: #2596be; --accent-light: #3ab4e0; --accent-dark: #1d7a9c;
            --border: #262626; --border-focus: #2596be; --success: #22c55e; --error: #ef4444;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg-primary); color: var(--text-primary); height: 100vh; line-height: 1.4; }
        .header { display: flex; justify-content: flex-end; align-items: center; padding: 8px 20px; background: var(--bg-secondary); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; }
        .header-right { display: flex; align-items: center; gap: 10px; }
        .lang-switcher { display: flex; background: var(--bg-tertiary); border-radius: 6px; padding: 2px; border: 1px solid var(--border); }
        .lang-btn { padding: 4px 10px; border: none; background: transparent; color: var(--text-secondary); cursor: pointer; border-radius: 4px; font-size: 11px; font-weight: 500; transition: all 0.2s; }
        .lang-btn.active { background: var(--accent); color: var(--text-primary); }
        .lang-btn:hover:not(.active) { color: var(--text-primary); }
        .credit-display { display: flex; align-items: center; gap: 12px; padding: 6px 14px; background: linear-gradient(135deg, rgba(37, 150, 190, 0.2), rgba(37, 150, 190, 0.05)); border: 1px solid rgba(37, 150, 190, 0.4); border-radius: 10px; margin-right: 12px; }
        .credit-info { display: flex; align-items: center; gap: 6px; }
        .credit-icon { font-size: 18px; }
        .credit-count { font-size: 20px; font-weight: 700; color: #2596be; min-width: 30px; text-align: center; }
        .credit-details { display: flex; flex-direction: column; align-items: flex-start; gap: 2px; }
        .plan-badge { font-size: 9px; font-weight: 600; padding: 2px 8px; background: #6b7280; color: white; border-radius: 4px; text-transform: uppercase; }
        .plan-badge.temel { background: linear-gradient(135deg, #22c55e, #16a34a); }
        .plan-badge.uzman { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .plan-badge.pro { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .plan-badge.none { background: #4b5563; }
        .days-left { font-size: 9px; color: #6b7280; }
        .days-left.warning { color: #f59e0b; }
        .days-left.danger { color: #ef4444; }
        .user-menu { position: relative; display: flex; align-items: center; gap: 8px; padding: 6px 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; }
        .user-avatar { width: 28px; height: 28px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 12px; }
        .user-name { font-size: 12px; font-weight: 500; }
        .main-container { display: flex; height: calc(100vh - 45px); overflow: hidden; }
        .sidebar { width: 380px; background: var(--bg-secondary); border-right: 1px solid var(--border); padding: 12px 16px; overflow-y: auto; flex-shrink: 0; }
        .results-section { flex: 1; padding: 16px; background: var(--bg-primary); overflow-y: auto; position: relative; }
        @media (max-width: 900px) { .main-container { flex-direction: column; } .sidebar { width: 100%; border-right: none; border-bottom: 1px solid var(--border); max-height: 50vh; } .results-section { max-height: 50vh; } }
        .section-title { font-size: 14px; font-weight: 600; color: var(--accent); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 11px; font-weight: 500; color: var(--text-secondary); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
        .form-select, .form-input { width: 100%; padding: 10px 12px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 13px; font-family: inherit; transition: all 0.2s; }
        .form-select:focus, .form-input:focus { outline: none; border-color: var(--accent); }
        .form-select { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23555555' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 10px center; background-size: 16px; padding-right: 36px; cursor: pointer; }
        .form-hint { font-size: 10px; color: var(--text-muted); margin-top: 4px; }
        .tab-switcher { display: flex; background: var(--bg-tertiary); border-radius: 8px; padding: 3px; border: 1px solid var(--border); margin-bottom: 12px; }
        .tab-btn { flex: 1; padding: 8px 12px; border: none; background: transparent; color: var(--text-secondary); cursor: pointer; border-radius: 6px; font-size: 11px; font-weight: 500; transition: all 0.2s; }
        .tab-btn.active { background: var(--accent); color: var(--text-primary); }
        .tab-btn:hover:not(.active) { color: var(--text-primary); }
        .info-box { padding: 12px; background: rgba(37, 150, 190, 0.1); border: 1px solid rgba(37, 150, 190, 0.3); border-radius: 8px; margin-bottom: 12px; }
        .info-box strong { display: block; font-size: 11px; color: var(--accent); margin-bottom: 4px; }
        .info-box p { font-size: 10px; color: var(--text-secondary); line-height: 1.5; margin: 0; }
        .submit-btn { width: 100%; padding: 12px 16px; background: var(--accent); color: white; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .submit-btn:hover { background: var(--accent-light); }
        .submit-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .results-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .results-title { font-size: 16px; font-weight: 600; color: var(--accent); }
        .results-empty { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 300px; text-align: center; color: var(--text-muted); }
        .results-empty svg { width: 64px; height: 64px; margin-bottom: 16px; opacity: 0.3; color: var(--accent); }
        .results-empty p { font-size: 14px; max-width: 300px; }
        .stems-container { display: flex; flex-direction: column; gap: 12px; }
        .stem-item { display: flex; align-items: center; gap: 12px; padding: 14px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; transition: all 0.2s; }
        .stem-item:hover { border-color: var(--accent); }
        .stem-icon { width: 44px; height: 44px; background: var(--bg-tertiary); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 22px; }
        .stem-info { flex: 1; }
        .stem-name { font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 4px; }
        .stem-audio { width: 100%; height: 36px; margin-top: 6px; }
        .stem-actions { display: flex; gap: 8px; }
        .stem-btn { padding: 8px 14px; border: 1px solid var(--border); background: var(--bg-tertiary); color: var(--text-primary); border-radius: 6px; font-size: 11px; font-weight: 500; cursor: pointer; transition: all 0.2s; text-decoration: none; display: flex; align-items: center; gap: 4px; }
        .stem-btn:hover { background: var(--bg-hover); border-color: var(--accent); }
        .stem-btn.primary { background: var(--accent); border-color: var(--accent); color: white; }
        .stem-btn.primary:hover { background: var(--accent-light); }
        .history-section { margin-top: 24px; border-top: 1px solid var(--border); padding-top: 20px; }
        .history-title { font-size: 14px; font-weight: 600; color: var(--text-secondary); margin-bottom: 12px; }
        .history-item { display: flex; align-items: center; gap: 12px; padding: 10px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; }
        .history-item:hover { border-color: var(--accent); }
        .history-icon { font-size: 18px; }
        .history-info { flex: 1; }
        .history-name { font-size: 12px; font-weight: 500; }
        .history-date { font-size: 10px; color: var(--text-muted); }
        .history-type { font-size: 9px; padding: 2px 6px; background: var(--bg-tertiary); border-radius: 4px; color: var(--text-secondary); }
        .loading-overlay { display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(8px); z-index: 200; align-items: center; justify-content: center; flex-direction: column; }
        .loading-overlay.active { display: flex; }
        .loader { width: 48px; height: 48px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { margin-top: 16px; font-size: 16px; font-weight: 500; }
        .loading-status { margin-top: 8px; font-size: 13px; color: var(--accent); }
        .loading-timer { margin-top: 12px; font-size: 24px; color: var(--accent); font-weight: 600; }
        .loading-avg { margin-top: 8px; font-size: 11px; color: var(--text-muted); }
        .message { padding: 12px 16px; border-radius: 8px; margin-bottom: 12px; font-size: 12px; display: none; }
        .message.error { display: block; background: rgba(239, 68, 68, 0.15); border: 1px solid var(--error); color: #ff6b6b; }
        .message.success { display: block; background: rgba(34, 197, 94, 0.15); border: 1px solid var(--success); color: #4ade80; }
        .track-list { max-height: 200px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 12px; }
        .track-option { display: flex; align-items: center; gap: 10px; padding: 10px 12px; cursor: pointer; transition: all 0.2s; border-bottom: 1px solid var(--border); }
        .track-option:last-child { border-bottom: none; }
        .track-option:hover { background: var(--bg-hover); }
        .track-option.selected { background: rgba(37, 150, 190, 0.2); border-color: var(--accent); }
        .track-option-icon { font-size: 16px; }
        .track-option-info { flex: 1; }
        .track-option-title { font-size: 12px; font-weight: 500; }
        .track-option-meta { font-size: 10px; color: var(--text-muted); }
        .track-option-check { width: 18px; height: 18px; border: 2px solid var(--border); border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .track-option.selected .track-option-check { background: var(--accent); border-color: var(--accent); }
        .track-option.selected .track-option-check::after { content: '‚úì'; color: white; font-size: 10px; }
        .empty-tracks { padding: 24px; text-align: center; color: var(--text-muted); }
        .empty-tracks svg { width: 40px; height: 40px; margin-bottom: 8px; opacity: 0.4; }
        .empty-tracks p { font-size: 12px; }
        .no-login-warning { padding: 16px; background: rgba(37, 150, 190, 0.1); border: 1px solid rgba(37, 150, 190, 0.3); border-radius: 8px; margin-bottom: 12px; text-align: center; }
        .no-login-warning p { font-size: 12px; color: var(--accent); margin-bottom: 8px; }
        .no-login-warning a { display: inline-block; padding: 8px 16px; background: var(--accent); color: white; border: none; border-radius: 6px; font-size: 11px; font-weight: 500; cursor: pointer; text-decoration: none; }
        .no-login-warning a:hover { background: var(--accent-light); }
        .loading-tracks { padding: 20px; text-align: center; color: var(--text-muted); }
        .loading-tracks .spinner { width: 24px; height: 24px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 8px; }
        .credit-badge { display: inline-block; padding: 2px 6px; background: rgba(37, 150, 190, 0.3); color: var(--accent); border-radius: 4px; font-size: 10px; font-weight: 600; margin-left: 6px; }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loader"></div>
        <p class="loading-text" id="loadingText">Stem Ayrƒ±≈ütƒ±rma</p>
        <p class="loading-status" id="loadingStatus">ƒ∞≈üleniyor...</p>
        <p class="loading-timer" id="loadingTimer">00:00</p>
        <p class="loading-avg" id="loadingAvg">Ortalama i≈ülem s√ºresi: 1-3 dk</p>
    </div>
    <header class="header">
        <div class="header-right">
            <div class="credit-display" id="creditDisplay" style="display: none;">
                <div class="credit-info"><span class="credit-icon">‚ö°</span><span class="credit-count" id="creditCount">0</span></div>
                <div class="credit-details"><span class="plan-badge none" id="planBadge">-</span><span class="days-left" id="daysLeft">-</span></div>
            </div>
            <div class="lang-switcher">
                <button class="lang-btn active" id="langTR" onclick="setLanguage('tr')">TR</button>
                <button class="lang-btn" id="langEN" onclick="setLanguage('en')">EN</button>
            </div>
            <div id="userArea"></div>
        </div>
    </header>
    <div class="main-container">
        <div class="sidebar">
            <div class="section-title"><span>üéõÔ∏è</span><span id="sidebarTitle">Stem Ayrƒ±≈ütƒ±rma</span></div>
            <div class="message" id="errorMsg"></div>
            <div class="message" id="successMsg"></div>
            <div class="no-login-warning" id="noLoginWarning" style="display: none;">
                <p id="noLoginText">≈ûarkƒ±larƒ±nƒ±za eri≈ümek i√ßin giri≈ü yapƒ±n</p>
            </div>
            <form id="stemForm">
                <div class="form-group">
                    <label class="form-label" id="labelInputMode">Kaynak Se√ßimi</label>
                    <div class="tab-switcher">
                        <button type="button" class="tab-btn active" id="tabDatabase" onclick="switchInputMode('database')">≈ûarkƒ±larƒ±m</button>
                        <button type="button" class="tab-btn" id="tabManual" onclick="switchInputMode('manual')">Manuel Giri≈ü</button>
                    </div>
                </div>
                <div id="databaseSection">
                    <div class="form-group">
                        <label class="form-label" id="labelSelectTrack">≈ûarkƒ± Se√ßin</label>
                        <div class="track-list" id="trackList">
                            <div class="empty-tracks" id="emptyTracks">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"/></svg>
                                <p id="emptyTracksText">Hen√ºz ≈üarkƒ±nƒ±z yok veya giri≈ü yapmadƒ±nƒ±z</p>
                            </div>
                        </div>
                        <p class="form-hint" id="hintSelectTrack">BAZ AI'da olu≈üturduƒüunuz ≈üarkƒ±lar otomatik y√ºklenir</p>
                    </div>
                </div>
                <div id="manualSection" style="display: none;">
                    <div class="form-group"><label class="form-label">Task ID</label><input type="text" class="form-input" id="manualTaskId" placeholder="√ñrn: abc123..."></div>
                    <div class="form-group"><label class="form-label">Audio ID</label><input type="text" class="form-input" id="manualAudioId" placeholder="√ñrn: xyz789..."></div>
                    <div class="info-box"><strong id="infoManualTitle">Manuel Giri≈ü Nasƒ±l Yapƒ±lƒ±r?</strong><p id="infoManualDesc">BAZ AI'da olu≈üturduƒüunuz ≈üarkƒ±nƒ±n Task ID ve Audio ID bilgilerini girin.</p></div>
                </div>
                <div class="form-group">
                    <label class="form-label" id="labelSeparationType">Ayrƒ±≈ütƒ±rma Tipi</label>
                    <select class="form-select" id="separationType">
                        <option value="separate_vocal">Vokal & Enstr√ºmantal (2 Stem) - 2 Kredi</option>
                        <option value="split_stem">Detaylƒ± Ayrƒ±≈ütƒ±rma (12 Stem) - 5 Kredi</option>
                    </select>
                    <p class="form-hint" id="hintSeparationType">Detaylƒ± ayrƒ±≈ütƒ±rma daha uzun s√ºrer</p>
                </div>
                <div class="info-box"><strong id="infoTitle">Stem Ayrƒ±≈ütƒ±rma Nedir?</strong><p id="infoDesc">≈ûarkƒ±nƒ±zƒ± vokal, bas, davul, gitar gibi ayrƒ± par√ßalara ayƒ±rƒ±r.</p></div>
                <button type="submit" class="submit-btn" id="submitBtn"><span>üéµ</span><span id="submitText">Ayrƒ±≈ütƒ±rmayƒ± Ba≈ülat</span><span class="credit-badge" id="creditCost">2 Kredi</span></button>
            </form>
        </div>
        <div class="results-section">
            <div class="results-header"><h2 class="results-title" id="resultsTitle">Sonu√ßlar</h2></div>
            <div class="results-empty" id="resultsEmpty">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"/></svg>
                <p id="emptyResultsText">Stem ayrƒ±≈ütƒ±rma sonu√ßlarƒ±nƒ±z burada g√∂r√ºnecek.</p>
            </div>
            <div class="stems-container" id="stemsContainer" style="display: none;"></div>
            <div class="history-section" id="historySection" style="display: none;"><h3 class="history-title" id="historyTitle">Ge√ßmi≈ü Ayrƒ±≈ütƒ±rmalar</h3><div id="historyList"></div></div>
        </div>
    </div>
    <script>
        var currentLang = 'tr';
        var currentInputMode = 'database';
        var authToken = null;
        var currentUser = null;
        var userCredits = 0;
        var userPlan = 'none';
        var userTracks = [];
        var selectedTrack = null;
        var stemHistory = [];
        var timerInterval = null;
        var timerSeconds = 0;
        var API_BASE_URL = window.location.origin;
        var MAIN_APP_URL = 'https://baz-v1-studio.vercel.app';
        
        var translations = {
            tr: {
                sidebarTitle: 'Stem Ayrƒ±≈ütƒ±rma', labelInputMode: 'Kaynak Se√ßimi', tabDatabase: '≈ûarkƒ±larƒ±m', tabManual: 'Manuel Giri≈ü',
                labelSelectTrack: '≈ûarkƒ± Se√ßin', emptyTracksText: 'Hen√ºz ≈üarkƒ±nƒ±z yok veya giri≈ü yapmadƒ±nƒ±z',
                hintSelectTrack: 'BAZ AI\'da olu≈üturduƒüunuz ≈üarkƒ±lar otomatik y√ºklenir', infoManualTitle: 'Manuel Giri≈ü Nasƒ±l Yapƒ±lƒ±r?',
                infoManualDesc: 'BAZ AI\'da olu≈üturduƒüunuz ≈üarkƒ±nƒ±n Task ID ve Audio ID bilgilerini girin.',
                labelSeparationType: 'Ayrƒ±≈ütƒ±rma Tipi', optionVocal: 'Vokal & Enstr√ºmantal (2 Stem) - 2 Kredi',
                optionSplit: 'Detaylƒ± Ayrƒ±≈ütƒ±rma (12 Stem) - 5 Kredi', hintSeparationType: 'Detaylƒ± ayrƒ±≈ütƒ±rma daha uzun s√ºrer',
                infoTitle: 'Stem Ayrƒ±≈ütƒ±rma Nedir?', infoDesc: '≈ûarkƒ±nƒ±zƒ± vokal, bas, davul, gitar gibi ayrƒ± par√ßalara ayƒ±rƒ±r.',
                submitText: 'Ayrƒ±≈ütƒ±rmayƒ± Ba≈ülat', resultsTitle: 'Sonu√ßlar',
                emptyResultsText: 'Stem ayrƒ±≈ütƒ±rma sonu√ßlarƒ±nƒ±z burada g√∂r√ºnecek.', historyTitle: 'Ge√ßmi≈ü Ayrƒ±≈ütƒ±rmalar',
                loadingText: 'Stem Ayrƒ±≈ütƒ±rma', loadingStatus: 'ƒ∞≈üleniyor...', loadingAvg: 'Ortalama i≈ülem s√ºresi: 1-3 dk',
                noLoginText: '≈ûarkƒ±larƒ±nƒ±za eri≈ümek i√ßin giri≈ü yapƒ±n',
                btnDownload: 'ƒ∞ndir', stemVocal: 'Vokal', stemInstrumental: 'Enstr√ºmantal', stemDrums: 'Davul', stemBass: 'Bas',
                stemGuitar: 'Gitar', stemKeyboard: 'Klavye', stemStrings: 'Yaylƒ±lar', stemBrass: 'Bakƒ±r √úflemeli',
                stemWoodwinds: 'Tahta √úflemeli', stemPercussion: 'Perk√ºsyon', stemSynth: 'Synth', stemFX: 'Efektler',
                stemBackingVocals: 'Arka Vokal', errorPrefix: 'Hata:', errorNoTrack: 'L√ºtfen bir ≈üarkƒ± se√ßin',
                errorNoIds: 'Task ID ve Audio ID gerekli', successStem: 'Stem ayrƒ±≈ütƒ±rma tamamlandƒ±!', loadingTracks: '≈ûarkƒ±lar y√ºkleniyor...',
                creditCost2: '2 Kredi', creditCost5: '5 Kredi', insufficientCredits: 'Yetersiz kredi'
            },
            en: {
                sidebarTitle: 'Stem Separation', labelInputMode: 'Source Selection', tabDatabase: 'My Songs', tabManual: 'Manual Entry',
                labelSelectTrack: 'Select Song', emptyTracksText: 'No songs yet or not logged in',
                hintSelectTrack: 'Songs created in BAZ AI are loaded automatically', infoManualTitle: 'How to Enter Manually?',
                infoManualDesc: 'Enter the Task ID and Audio ID of your song created in BAZ AI.',
                labelSeparationType: 'Separation Type', optionVocal: 'Vocal & Instrumental (2 Stems) - 2 Credits',
                optionSplit: 'Detailed Separation (12 Stems) - 5 Credits', hintSeparationType: 'Detailed separation takes longer',
                infoTitle: 'What is Stem Separation?', infoDesc: 'Separates your song into individual parts like vocals, bass, drums, guitar.',
                submitText: 'Start Separation', resultsTitle: 'Results',
                emptyResultsText: 'Your stem separation results will appear here.', historyTitle: 'Previous Separations',
                loadingText: 'Stem Separation', loadingStatus: 'Processing...', loadingAvg: 'Average processing time: 1-3 min',
                noLoginText: 'Login to access your songs',
                btnDownload: 'Download', stemVocal: 'Vocal', stemInstrumental: 'Instrumental', stemDrums: 'Drums', stemBass: 'Bass',
                stemGuitar: 'Guitar', stemKeyboard: 'Keyboard', stemStrings: 'Strings', stemBrass: 'Brass',
                stemWoodwinds: 'Woodwinds', stemPercussion: 'Percussion', stemSynth: 'Synth', stemFX: 'Effects',
                stemBackingVocals: 'Backing Vocals', errorPrefix: 'Error:', errorNoTrack: 'Please select a song',
                errorNoIds: 'Task ID and Audio ID required', successStem: 'Stem separation completed!', loadingTracks: 'Loading songs...',
                creditCost2: '2 Credits', creditCost5: '5 Credits', insufficientCredits: 'Insufficient credits'
            }
        };
        
        function updateCreditCost() {
            var t = translations[currentLang];
            var separationType = document.getElementById('separationType').value;
            var creditBadge = document.getElementById('creditCost');
            if (separationType === 'separate_vocal') {
                creditBadge.textContent = t.creditCost2;
            } else {
                creditBadge.textContent = t.creditCost5;
            }
        }
        
        function setLanguage(lang) {
            currentLang = lang;
            var t = translations[lang];
            document.getElementById('langTR').classList.toggle('active', lang === 'tr');
            document.getElementById('langEN').classList.toggle('active', lang === 'en');
            document.getElementById('sidebarTitle').textContent = t.sidebarTitle;
            document.getElementById('labelInputMode').textContent = t.labelInputMode;
            document.getElementById('tabDatabase').textContent = t.tabDatabase;
            document.getElementById('tabManual').textContent = t.tabManual;
            document.getElementById('labelSelectTrack').textContent = t.labelSelectTrack;
            document.getElementById('hintSelectTrack').textContent = t.hintSelectTrack;
            document.getElementById('infoManualTitle').textContent = t.infoManualTitle;
            document.getElementById('infoManualDesc').textContent = t.infoManualDesc;
            document.getElementById('labelSeparationType').textContent = t.labelSeparationType;
            document.getElementById('hintSeparationType').textContent = t.hintSeparationType;
            document.getElementById('infoTitle').textContent = t.infoTitle;
            document.getElementById('infoDesc').textContent = t.infoDesc;
            document.getElementById('submitText').textContent = t.submitText;
            document.getElementById('resultsTitle').textContent = t.resultsTitle;
            document.getElementById('emptyResultsText').textContent = t.emptyResultsText;
            document.getElementById('historyTitle').textContent = t.historyTitle;
            document.getElementById('loadingText').textContent = t.loadingText;
            document.getElementById('loadingStatus').textContent = t.loadingStatus;
            document.getElementById('loadingAvg').textContent = t.loadingAvg;
            document.getElementById('noLoginText').textContent = t.noLoginText;
            var sepType = document.getElementById('separationType');
            sepType.options[0].text = t.optionVocal;
            sepType.options[1].text = t.optionSplit;
            updateCreditCost();
            renderTrackList();
        }
        
        document.getElementById('separationType').addEventListener('change', updateCreditCost);
        
        function switchInputMode(mode) {
            currentInputMode = mode;
            document.getElementById('tabDatabase').classList.toggle('active', mode === 'database');
            document.getElementById('tabManual').classList.toggle('active', mode === 'manual');
            document.getElementById('databaseSection').style.display = mode === 'database' ? 'block' : 'none';
            document.getElementById('manualSection').style.display = mode === 'manual' ? 'block' : 'none';
        }
        
        function getTokenFromURL() {
            var urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('token');
        }
        
        async function checkAuthStatus() {
            var urlToken = getTokenFromURL();
            if (urlToken) {
                authToken = urlToken;
                localStorage.setItem('bazai_stem_token', urlToken);
                window.history.replaceState({}, document.title, window.location.pathname);
            } else {
                authToken = localStorage.getItem('bazai_token') || localStorage.getItem('bazai_auth_token') || localStorage.getItem('bazai_stem_token');
            }
            if (authToken) { await syncUserDataFromMongoDB(); } else { showNoLoginState(); }
        }
        
        async function syncUserDataFromMongoDB() {
            if (!authToken) { showNoLoginState(); return; }
            showLoadingTracks();
            try {
                var response = await fetch(API_BASE_URL + '/api/auth-sync', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken }
                });
                var data = await response.json();
                if (data.success && data.user) {
                    currentUser = data.user;
                    userCredits = data.user.credits || 0;
                    userPlan = data.user.planId || data.user.plan || 'none';
                    localStorage.setItem('bazai_stem_token', authToken);
                    updateUserUI();
                    await loadUserTracksFromMongoDB();
                    await loadStemHistory();
                } else { showNoLoginState(); }
            } catch (error) { console.error('MongoDB sync error:', error); tryLocalStorageSync(); }
        }
        
        async function loadUserTracksFromMongoDB() {
            if (!authToken) { renderTrackList(); return; }
            try {
                var response = await fetch(API_BASE_URL + '/api/user-data', {
                    method: 'GET',
                    headers: { 'Authorization': 'Bearer ' + authToken }
                });
                var data = await response.json();
                if (data.success && data.data) {
                    userTracks = data.data.tracks || [];
                    stemHistory = data.data.stemHistory || [];
                    localStorage.setItem('bazai_tracks', JSON.stringify(userTracks));
                    localStorage.setItem('bazai_stem_history', JSON.stringify(stemHistory));
                    console.log('MongoDB\'den ' + userTracks.length + ' ≈üarkƒ± y√ºklendi');
                } else { userTracks = []; }
                renderTrackList();
                renderHistory();
            } catch (error) { console.error('Load tracks error:', error); tryLoadTracksFromLocalStorage(); }
        }
        
        function showLoadingTracks() {
            var t = translations[currentLang];
            var container = document.getElementById('trackList');
            container.innerHTML = '<div class="loading-tracks"><div class="spinner"></div><p>' + t.loadingTracks + '</p></div>';
        }
        
        function tryLocalStorageSync() {
            try {
                var savedUser = localStorage.getItem('bazai_user');
                var savedTracks = localStorage.getItem('bazai_tracks') || localStorage.getItem('savedTracks');
                if (savedUser) { currentUser = JSON.parse(savedUser); userCredits = currentUser.credits || 0; userPlan = currentUser.planId || currentUser.plan || 'none'; updateUserUI(); }
                if (savedTracks) { userTracks = JSON.parse(savedTracks); renderTrackList(); } else { showNoLoginState(); }
                loadStemHistory();
            } catch (e) { console.error('LocalStorage sync error:', e); showNoLoginState(); }
        }
        
        function updateUserUI() {
            var userArea = document.getElementById('userArea');
            userArea.innerHTML = '<div class="user-menu"><div class="user-avatar">' + (currentUser.displayName ? currentUser.displayName.charAt(0).toUpperCase() : 'U') + '</div><span class="user-name">' + (currentUser.displayName || currentUser.email || 'Kullanƒ±cƒ±') + '</span></div>';
            document.getElementById('creditDisplay').style.display = 'flex';
            document.getElementById('creditCount').textContent = userCredits;
            var planBadge = document.getElementById('planBadge');
            planBadge.textContent = userPlan.charAt(0).toUpperCase() + userPlan.slice(1);
            planBadge.className = 'plan-badge ' + userPlan;
            if (currentUser.daysRemaining !== undefined) {
                var daysLeft = document.getElementById('daysLeft');
                daysLeft.textContent = currentUser.daysRemaining + ' g√ºn kaldƒ±';
                if (currentUser.daysRemaining <= 7) daysLeft.classList.add('danger');
                else if (currentUser.daysRemaining <= 30) daysLeft.classList.add('warning');
            }
            document.getElementById('noLoginWarning').style.display = 'none';
        }
        
        function showNoLoginState() {
            document.getElementById('noLoginWarning').style.display = 'block';
            document.getElementById('creditDisplay').style.display = 'none';
            document.getElementById('userArea').innerHTML = '';
            renderTrackList();
        }
        
        function tryLoadTracksFromLocalStorage() {
            try { var savedTracks = localStorage.getItem('bazai_tracks') || localStorage.getItem('savedTracks'); if (savedTracks) { userTracks = JSON.parse(savedTracks); } else { userTracks = []; } } catch (e) { userTracks = []; }
            renderTrackList();
        }
        
        function renderTrackList() {
            var container = document.getElementById('trackList');
            var t = translations[currentLang];
            if (!userTracks || userTracks.length === 0) {
                container.innerHTML = '<div class="empty-tracks" id="emptyTracks"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"/></svg><p id="emptyTracksText">' + t.emptyTracksText + '</p></div>';
                return;
            }
            var html = '';
            userTracks.forEach(function(track, index) {
                var isSelected = selectedTrack && selectedTrack.id === track.id;
                var date = track.addedAt ? new Date(track.addedAt).toLocaleDateString() : '';
                html += '<div class="track-option ' + (isSelected ? 'selected' : '') + '" onclick="selectTrack(' + index + ')"><span class="track-option-icon">üéµ</span><div class="track-option-info"><div class="track-option-title">' + (track.title || '≈ûarkƒ± ' + (index + 1)) + '</div><div class="track-option-meta">' + (track.style || '') + (date ? ' ‚Ä¢ ' + date : '') + '</div></div><div class="track-option-check"></div></div>';
            });
            container.innerHTML = html;
        }
        
        function selectTrack(index) { selectedTrack = userTracks[index]; renderTrackList(); }
        
        async function loadStemHistory() {
            var saved = localStorage.getItem('bazai_stem_history');
            if (saved) { try { stemHistory = JSON.parse(saved); } catch (e) { stemHistory = []; } }
            renderHistory();
        }
        
        function saveStemToHistory(stemData) {
            var historyItem = { id: Date.now(), trackName: selectedTrack ? selectedTrack.title : 'Manuel Giri≈ü', type: document.getElementById('separationType').value, date: new Date().toISOString(), stems: stemData };
            stemHistory.unshift(historyItem);
            if (stemHistory.length > 20) stemHistory = stemHistory.slice(0, 20);
            localStorage.setItem('bazai_stem_history', JSON.stringify(stemHistory));
            if (authToken) { saveStemHistoryToMongoDB(historyItem); }
            renderHistory();
        }
        
        async function saveStemHistoryToMongoDB(historyItem) {
            try { await fetch(API_BASE_URL + '/api/user-data', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken }, body: JSON.stringify({ action: 'add_stem_history', data: { stemResult: historyItem } }) }); } catch (e) { console.error('Stem history save error:', e); }
        }
        
        function renderHistory() {
            var container = document.getElementById('historyList');
            var section = document.getElementById('historySection');
            if (!stemHistory || stemHistory.length === 0) { section.style.display = 'none'; return; }
            section.style.display = 'block';
            var html = '';
            stemHistory.forEach(function(item, index) {
                var date = new Date(item.date).toLocaleDateString();
                var typeLabel = item.type === 'separate_vocal' ? 'Vokal (2)' : 'Detaylƒ± (12)';
                html += '<div class="history-item" onclick="showHistoryItem(' + index + ')"><span class="history-icon">üéõÔ∏è</span><div class="history-info"><div class="history-name">' + item.trackName + '</div><div class="history-date">' + date + '</div></div><span class="history-type">' + typeLabel + '</span></div>';
            });
            container.innerHTML = html;
        }
        
        function showHistoryItem(index) { var item = stemHistory[index]; if (item && item.stems) { displayStemResults(item.stems, item.type); } }
        function startTimer() { timerSeconds = 0; updateTimerDisplay(); timerInterval = setInterval(function() { timerSeconds++; updateTimerDisplay(); }, 1000); }
        function stopTimer() { if (timerInterval) { clearInterval(timerInterval); timerInterval = null; } }
        function updateTimerDisplay() { var minutes = Math.floor(timerSeconds / 60); var seconds = timerSeconds % 60; document.getElementById('loadingTimer').textContent = String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0'); }
        function showError(message) { var el = document.getElementById('errorMsg'); el.textContent = message; el.classList.add('error'); el.style.display = 'block'; setTimeout(function() { el.style.display = 'none'; el.classList.remove('error'); }, 5000); }
        function showSuccess(message) { var el = document.getElementById('successMsg'); el.textContent = message; el.classList.add('success'); el.style.display = 'block'; setTimeout(function() { el.style.display = 'none'; el.classList.remove('success'); }, 5000); }
        
        async function useCredits(amount, action) {
            if (!authToken) return true;
            try {
                var response = await fetch(API_BASE_URL + '/api/use-credits', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                    body: JSON.stringify({ amount: amount, action: action })
                });
                var data = await response.json();
                if (data.success) {
                    userCredits = data.data.remainingCredits;
                    document.getElementById('creditCount').textContent = userCredits;
                    return true;
                } else {
                    return false;
                }
            } catch (e) { console.error('Use credits error:', e); return true; }
        }
        
        document.getElementById('stemForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            var t = translations[currentLang];
            var taskId, audioId;
            if (currentInputMode === 'database') {
                if (!selectedTrack) { showError(t.errorPrefix + ' ' + t.errorNoTrack); return; }
                taskId = selectedTrack.taskId;
                audioId = selectedTrack.audioId || selectedTrack.id;
            } else {
                taskId = document.getElementById('manualTaskId').value.trim();
                audioId = document.getElementById('manualAudioId').value.trim();
                if (!taskId || !audioId) { showError(t.errorPrefix + ' ' + t.errorNoIds); return; }
            }
            var separationType = document.getElementById('separationType').value;
            var creditCost = separationType === 'separate_vocal' ? 2 : 5;
            
            // Kredi kontrol√º
            if (userCredits < creditCost) {
                showError(t.insufficientCredits + ' (' + userCredits + '/' + creditCost + ')');
                return;
            }
            
            // Krediyi harca
            var creditSuccess = await useCredits(creditCost, separationType);
            if (!creditSuccess) {
                showError(t.insufficientCredits);
                return;
            }
            
            document.getElementById('loadingOverlay').classList.add('active');
            document.getElementById('stemsContainer').style.display = 'none';
            document.getElementById('resultsEmpty').style.display = 'flex';
            startTimer();
            try {
                var headers = { 'Content-Type': 'application/json' };
                if (authToken) { headers['Authorization'] = 'Bearer ' + authToken; }
                var res = await fetch(API_BASE_URL + '/api/stem', { method: 'POST', headers: headers, body: JSON.stringify({ taskId: taskId, audioId: audioId, type: separationType, callBackUrl: API_BASE_URL + '/api/stem-webhook' }) });
                var data = await res.json();
                if (!res.ok || (data.code !== 200 && !data.taskId)) { throw new Error(data.msg || data.error || data.details || 'Hata'); }
                var newTaskId = data.data ? data.data.taskId : data.taskId;
                pollStemStatus(newTaskId, separationType);
            } catch (err) { stopTimer(); document.getElementById('loadingOverlay').classList.remove('active'); showError(t.errorPrefix + ' ' + err.message); }
        });
        
        async function pollStemStatus(taskId, separationType) {
            var t = translations[currentLang];
            var attempts = 0;
            var maxAttempts = 60;
            var interval = setInterval(async function() {
                attempts++;
                document.getElementById('loadingStatus').textContent = t.loadingStatus + ' (' + attempts + ')';
                try {
                    var res = await fetch(API_BASE_URL + '/api/stem-status?taskId=' + taskId);
                    var json = await res.json();
                    if (json.code === 200 && json.data && json.data.vocal_separation_info) {
                        clearInterval(interval);
                        stopTimer();
                        document.getElementById('loadingOverlay').classList.remove('active');
                        var stemInfo = json.data.vocal_separation_info;
                        displayStemResults(stemInfo, separationType);
                        saveStemToHistory(stemInfo);
                        showSuccess(t.successStem);
                    }
                    if (attempts >= maxAttempts) { clearInterval(interval); stopTimer(); document.getElementById('loadingOverlay').classList.remove('active'); showError('Zaman a≈üƒ±mƒ± - l√ºtfen tekrar deneyin'); }
                } catch (e) { console.error('Poll error:', e); }
            }, 5000);
        }
        
        function displayStemResults(info, separationType) {
            var t = translations[currentLang];
            var container = document.getElementById('stemsContainer');
            container.innerHTML = '';
            var stems = [];
            if (separationType === 'separate_vocal') {
                if (info.vocal_url) stems.push({ name: t.stemVocal, url: info.vocal_url, icon: 'üé§' });
                if (info.instrumental_url) stems.push({ name: t.stemInstrumental, url: info.instrumental_url, icon: 'üé∏' });
            } else {
                if (info.vocal_url) stems.push({ name: t.stemVocal, url: info.vocal_url, icon: 'üé§' });
                if (info.backing_vocals_url) stems.push({ name: t.stemBackingVocals, url: info.backing_vocals_url, icon: 'üéôÔ∏è' });
                if (info.drums_url) stems.push({ name: t.stemDrums, url: info.drums_url, icon: 'ü•Å' });
                if (info.bass_url) stems.push({ name: t.stemBass, url: info.bass_url, icon: 'üé∏' });
                if (info.guitar_url) stems.push({ name: t.stemGuitar, url: info.guitar_url, icon: 'üé∏' });
                if (info.keyboard_url) stems.push({ name: t.stemKeyboard, url: info.keyboard_url, icon: 'üéπ' });
                if (info.strings_url) stems.push({ name: t.stemStrings, url: info.strings_url, icon: 'üéª' });
                if (info.brass_url) stems.push({ name: t.stemBrass, url: info.brass_url, icon: 'üé∫' });
                if (info.woodwinds_url) stems.push({ name: t.stemWoodwinds, url: info.woodwinds_url, icon: 'üé∑' });
                if (info.percussion_url) stems.push({ name: t.stemPercussion, url: info.percussion_url, icon: 'ü™ò' });
                if (info.synth_url) stems.push({ name: t.stemSynth, url: info.synth_url, icon: 'üéõÔ∏è' });
                if (info.fx_url) stems.push({ name: t.stemFX, url: info.fx_url, icon: '‚ú®' });
            }
            stems.forEach(function(stem) {
                var html = '<div class="stem-item"><div class="stem-icon">' + stem.icon + '</div><div class="stem-info"><div class="stem-name">' + stem.name + '</div><audio class="stem-audio" controls src="' + stem.url + '"></audio></div><div class="stem-actions"><a href="' + stem.url + '" download class="stem-btn primary">' + t.btnDownload + '</a></div></div>';
                container.innerHTML += html;
            });
            document.getElementById('resultsEmpty').style.display = 'none';
            container.style.display = 'flex';
        }
        
        document.addEventListener('DOMContentLoaded', function() { setLanguage('tr'); checkAuthStatus(); });
    </script>
</body>
</html>
