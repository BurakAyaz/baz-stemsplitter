<!DOCTYPE html>
<html lang="tr" data-lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BAZ AI Stem Separator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #000000; --bg-secondary: #0a0a0a; --bg-tertiary: #111111;
            --bg-card: #161616; --bg-input: #1a1a1a; --bg-hover: #222222;
            --text-primary: #ffffff; --text-secondary: #a0a0a0; --text-muted: #555555;
            --accent: #2596be; --accent-light: #3ab4e0; --accent-dark: #1d7a9c;
            --border: #262626; --border-focus: #2596be; --success: #22c55e; --error: #ef4444;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg-primary); color: var(--text-primary); height: 100vh; line-height: 1.4; }
        
        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; padding: 8px 20px; background: var(--bg-secondary); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; }
        .logo { display: flex; align-items: center; gap: 8px; font-size: 1.2rem; font-weight: 700; color: var(--text-primary); }
        .logo-img { width: 36px; height: 36px; border-radius: 50%; background: var(--accent); display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 700; }
        .header-right { display: flex; align-items: center; gap: 10px; }
        
        /* Kredi ve KullanÄ±cÄ± MenÃ¼sÃ¼ */
        .credit-display { display: flex; align-items: center; gap: 12px; padding: 6px 14px; background: linear-gradient(135deg, rgba(37, 150, 190, 0.2), rgba(37, 150, 190, 0.05)); border: 1px solid rgba(37, 150, 190, 0.4); border-radius: 10px; }
        .credit-info { display: flex; align-items: center; gap: 6px; }
        .credit-count { font-size: 20px; font-weight: 700; color: #2596be; min-width: 30px; text-align: center; }
        .credit-label { font-size: 10px; color: #a0a0a0; text-transform: uppercase; }
        .credit-details { display: flex; flex-direction: column; align-items: flex-start; gap: 2px; }
        .plan-badge { font-size: 9px; font-weight: 600; padding: 2px 8px; background: #6b7280; color: white; border-radius: 4px; text-transform: uppercase; }
        .plan-badge.temel { background: linear-gradient(135deg, #22c55e, #16a34a); }
        .plan-badge.uzman { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .plan-badge.pro { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .days-left { font-size: 9px; color: #6b7280; }

        .login-btn { display: flex; align-items: center; gap: 6px; padding: 8px 16px; background: linear-gradient(135deg, #2596be, #1d7a9c); color: white; border: none; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s; text-decoration: none; }
        .login-btn:hover { background: linear-gradient(135deg, #3ab4e0, #2596be); transform: translateY(-1px); }
        
        .user-menu { position: relative; }
        .user-btn { display: flex; align-items: center; gap: 8px; padding: 6px 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); cursor: pointer; border: none; }
        .user-avatar { width: 28px; height: 28px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; }
        .user-dropdown { position: absolute; top: 100%; right: 0; margin-top: 8px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; min-width: 200px; display: none; z-index: 1000; overflow: hidden; }
        .user-dropdown.active { display: block; }
        .user-dropdown-item { display: flex; align-items: center; gap: 10px; padding: 12px 16px; color: var(--text-primary); text-decoration: none; font-size: 13px; cursor: pointer; border: none; background: none; width: 100%; text-align: left; }
        .user-dropdown-item:hover { background: var(--bg-hover); }

        .lang-switcher { display: flex; background: var(--bg-tertiary); border-radius: 6px; padding: 2px; border: 1px solid var(--border); }
        .lang-btn { padding: 4px 10px; border: none; background: transparent; color: var(--text-secondary); cursor: pointer; border-radius: 4px; font-size: 11px; font-weight: 500; transition: all 0.2s; }
        .lang-btn.active { background: var(--accent); color: var(--text-primary); }
        
        /* Main Layout */
        .main-container { display: flex; height: calc(100vh - 53px); overflow: hidden; }
        .sidebar { width: 380px; background: var(--bg-secondary); border-right: 1px solid var(--border); padding: 12px 16px; overflow-y: auto; flex-shrink: 0; }
        .results-section { flex: 1; padding: 16px; background: var(--bg-primary); overflow-y: auto; position: relative; }
        
        /* UI Components */
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 11px; font-weight: 500; color: var(--text-secondary); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
        .form-select, .form-input { width: 100%; padding: 10px 12px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 13px; font-family: inherit; }
        .submit-btn { width: 100%; padding: 12px 16px; background: var(--accent); color: white; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
        
        .loading-overlay { display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(8px); z-index: 200; align-items: center; justify-content: center; flex-direction: column; }
        .loading-overlay.active { display: flex; }
        .loader { width: 48px; height: 48px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Track List Styles */
        .track-list { max-height: 250px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 12px; }
        .track-option { padding: 10px 12px; cursor: pointer; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; }
        .track-option.selected { background: rgba(37, 150, 190, 0.2); }

        /* Messages */
        .message { padding: 12px 16px; border-radius: 8px; margin-bottom: 12px; font-size: 12px; display: none; }
        .message.error { display: block; background: rgba(239, 68, 68, 0.15); border: 1px solid var(--error); color: #ff6b6b; }
        .message.success { display: block; background: rgba(34, 197, 94, 0.15); border: 1px solid var(--success); color: #4ade80; }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loader"></div>
        <p class="loading-text" id="loadingText">Stem AyrÄ±ÅŸtÄ±rma</p>
        <p class="loading-status" id="loadingStatus">Ä°ÅŸleniyor...</p>
        <p class="loading-timer" id="loadingTimer">00:00</p>
    </div>
    
    <header class="header">
        <div class="logo">
            <div class="logo-img">ðŸŽµ</div>
            <span>BAZ AI</span>
        </div>
        <div class="header-right">
            <div class="credit-display" id="creditDisplay" style="display: none;">
                <div class="credit-info">
                    <span class="credit-count" id="creditCount">0</span>
                    <span class="credit-label">Kredi</span>
                </div>
                <div class="credit-details">
                    <span class="plan-badge" id="planBadge">-</span>
                    <span class="days-left" id="daysLeft"></span>
                </div>
            </div>
            
            <a href="#" class="login-btn" id="loginBtn" onclick="redirectToWixLogin(); return false;">GiriÅŸ Yap</a>
            
            <div class="user-menu" id="userMenu" style="display: none;">
                <button class="user-btn" onclick="toggleUserDropdown()">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <span id="userName">KullanÄ±cÄ±</span>
                </button>
                <div class="user-dropdown" id="userDropdown">
                    <button class="user-dropdown-item" onclick="logout()">Ã‡Ä±kÄ±ÅŸ Yap</button>
                </div>
            </div>

            <div class="lang-switcher">
                <button class="lang-btn active" id="langTR" onclick="setLanguage('tr')">TR</button>
                <button class="lang-btn" id="langEN" onclick="setLanguage('en')">EN</button>
            </div>
        </div>
    </header>
    
    <div class="main-container">
        <div class="sidebar">
            <div class="section-title"><span id="sidebarTitle">Stem AyrÄ±ÅŸtÄ±rma</span></div>
            <div class="message" id="errorMsg"></div>
            <div class="message" id="successMsg"></div>
            
            <form id="stemForm">
                <div class="form-group">
                    <label class="form-label" id="labelSelectTrack">ÅžarkÄ±larÄ±m</label>
                    <div class="track-list" id="trackList"></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" id="labelSeparationType">AyrÄ±ÅŸtÄ±rma Tipi</label>
                    <select class="form-select" id="separationType">
                        <option value="separate_vocal">Vokal & EnstrÃ¼mantal (2 Stem)</option>
                        <option value="split_stem">DetaylÄ± AyrÄ±ÅŸtÄ±rma (12 Stem)</option>
                    </select>
                </div>
                
                <button type="submit" class="submit-btn" id="submitBtn">
                    <span id="submitText">AyrÄ±ÅŸtÄ±rmayÄ± BaÅŸlat</span>
                </button>
            </form>
        </div>
        
        <div class="results-section">
            <div class="results-header"><h2 class="results-title" id="resultsTitle">SonuÃ§lar</h2></div>
            <div id="resultsEmpty" class="results-empty">AyrÄ±ÅŸtÄ±rma sonuÃ§larÄ± burada gÃ¶rÃ¼necek.</div>
            <div class="stems-container" id="stemsContainer" style="display: none;"></div>
        </div>
    </div>

    <script>
        var currentLang = 'tr';
        var authToken = localStorage.getItem('bazai_token') || null;
        var currentUser = null;
        var userCredits = 0;
        var userPlan = 'none';
        var isLoggedIn = false;
        var userTracks = [];
        var selectedTrack = null;

        var API_BASE_URL = window.location.origin;
        var WIX_SITE_URL = 'https://www.burakayaz.com';

        async function checkAuthStatus() {
            var urlParams = new URLSearchParams(window.location.search);
            var tokenFromUrl = urlParams.get('token');
            if (tokenFromUrl) {
                authToken = tokenFromUrl;
                localStorage.setItem('bazai_token', tokenFromUrl);
                window.history.replaceState({}, document.title, window.location.pathname);
            }
            if (authToken) await syncUserData();
            else showLoggedOutState();
        }

        async function syncUserData() {
            try {
                var response = await fetch(API_BASE_URL + '/api/auth-sync', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken }
                });
                var data = await response.json();
                if (data.success && data.user) {
                    currentUser = data.user;
                    userCredits = data.user.credits || 0;
                    userPlan = data.user.plan || 'none';
                    isLoggedIn = true;
                    showLoggedInState();
                    loadUserTracks();
                } else { logout(); }
            } catch (e) { showLoggedOutState(); }
        }

        function showLoggedInState() {
            document.getElementById('loginBtn').style.display = 'none';
            document.getElementById('creditDisplay').style.display = 'flex';
            document.getElementById('userMenu').style.display = 'block';
            document.getElementById('creditCount').textContent = userCredits;
            document.getElementById('planBadge').textContent = userPlan.toUpperCase();
            document.getElementById('userName').textContent = currentUser.displayName || 'KullanÄ±cÄ±';
        }

        function showLoggedOutState() {
            isLoggedIn = false;
            document.getElementById('loginBtn').style.display = 'flex';
            document.getElementById('creditDisplay').style.display = 'none';
            document.getElementById('userMenu').style.display = 'none';
        }

        function redirectToWixLogin() {
            window.location.href = WIX_SITE_URL + '/stem-redirect?returnUrl=' + encodeURIComponent(window.location.href);
        }

        function toggleUserDropdown() { document.getElementById('userDropdown').classList.toggle('active'); }

        function logout() {
            localStorage.removeItem('bazai_token');
            location.reload();
        }

        async function loadUserTracks() {
            try {
                var response = await fetch(API_BASE_URL + '/api/user-data', {
                    headers: { 'Authorization': 'Bearer ' + authToken }
                });
                var data = await response.json();
                if (data.success) {
                    userTracks = data.data.tracks || [];
                    renderTracks();
                }
            } catch (e) { console.error(e); }
        }

        function renderTracks() {
            var html = userTracks.map((t, i) => `
                <div class="track-option" onclick="selectTrack(${i})">
                    ${t.title || 'AdsÄ±z ÅžarkÄ±'}
                </div>
            `).join('');
            document.getElementById('trackList').innerHTML = html;
        }

        function selectTrack(i) {
            selectedTrack = userTracks[i];
            document.querySelectorAll('.track-option').forEach(el => el.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
        }

        function setLanguage(lang) {
            currentLang = lang;
            document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('lang' + lang.toUpperCase()).classList.add('active');
        }

        document.getElementById('stemForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if(!isLoggedIn) return redirectToWixLogin();
            if(!selectedTrack) return alert("LÃ¼tfen ÅŸarkÄ± seÃ§in");

            document.getElementById('loadingOverlay').classList.add('active');
            // AyrÄ±ÅŸtÄ±rma API Ã§aÄŸrÄ±sÄ± ve Polling buraya gelecek...
        });

        document.addEventListener('DOMContentLoaded', checkAuthStatus);
    </script>
</body>
</html>
