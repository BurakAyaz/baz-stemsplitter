<!DOCTYPE html>
<html lang="tr" data-lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BAZ AI Stem Separator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #000000; --bg-secondary: #0a0a0a; --bg-tertiary: #111111;
            --bg-card: #161616; --bg-input: #1a1a1a; --bg-hover: #222222;
            --text-primary: #ffffff; --text-secondary: #a0a0a0; --text-muted: #555555;
            --accent: #2596be; --accent-light: #3ab4e0; --accent-dark: #1d7a9c;
            --border: #262626; --border-focus: #2596be; --success: #22c55e; --error: #ef4444;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-primary); color: var(--text-primary); height: 100vh; overflow: hidden; }
        
        .header { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background: var(--bg-secondary); border-bottom: 1px solid var(--border); }
        .logo { display: flex; align-items: center; gap: 10px; font-weight: 700; font-size: 1.2rem; }
        .logo-img { width: 32px; height: 32px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        
        .main-container { display: flex; height: calc(100vh - 53px); }
        .sidebar { width: 380px; background: var(--bg-secondary); border-right: 1px solid var(--border); padding: 20px; overflow-y: auto; }
        .results-section { flex: 1; padding: 30px; overflow-y: auto; background: var(--bg-primary); }

        .track-list { border: 1px solid var(--border); border-radius: 8px; max-height: 200px; overflow-y: auto; margin-bottom: 15px; background: var(--bg-input); }
        .track-option { padding: 12px; cursor: pointer; border-bottom: 1px solid var(--border); transition: 0.2s; display: flex; align-items: center; gap: 10px; }
        .track-option:hover { background: var(--bg-hover); }
        .track-option.selected { background: rgba(37, 150, 190, 0.15); border-left: 4px solid var(--accent); }

        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-size: 13px; color: var(--text-secondary); }
        .form-select { width: 100%; padding: 12px; background: var(--bg-input); border: 1px solid var(--border); color: white; border-radius: 8px; outline: none; }
        
        .submit-btn { width: 100%; padding: 14px; background: var(--accent); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .submit-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .stem-item { display: flex; align-items: center; gap: 15px; padding: 15px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 12px; }
        .stem-icon { width: 45px; height: 45px; background: var(--bg-tertiary); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .stem-info { flex: 1; }
        .stem-audio { width: 100%; height: 35px; margin-top: 10px; filter: invert(1); }
        .stem-btn { padding: 8px 16px; background: var(--accent); color: white; border-radius: 6px; text-decoration: none; font-size: 12px; font-weight: 600; }

        .loading-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; flex-direction: column; align-items: center; justify-content: center; }
        .loading-overlay.active { display: flex; }
        .loader { width: 50px; height: 50px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .history-item { padding: 12px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 10px; cursor: pointer; display: flex; justify-content: space-between; }
        .history-item:hover { border-color: var(--accent); }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loader"></div>
        <p style="margin-top: 20px; font-weight: 600;" id="loadingText">ƒ∞≈ülem Ba≈ülatƒ±lƒ±yor...</p>
        <p id="loadingTimer" style="font-size: 24px; margin-top: 10px;">00:00</p>
    </div>

    <header class="header">
        <div class="logo"><div class="logo-img">BA</div> BAZ AI Stem Separator</div>
        <div id="authArea">
            <button onclick="login()" id="loginBtn" style="padding: 8px 16px; background: var(--accent); border: none; color: white; border-radius: 6px; cursor: pointer;">Giri≈ü Yap</button>
            <span id="userInfo" style="display:none;"><span id="userName"></span> (<span id="userCredits">0</span> Kredi)</span>
        </div>
    </header>

    <div class="main-container">
        <aside class="sidebar">
            <div class="form-group">
                <label class="form-label">≈ûarkƒ± Se√ßin</label>
                <div class="track-list" id="trackList">
                    <div style="padding:20px; text-align:center; color:var(--text-muted);">Y√ºkleniyor...</div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Ayrƒ±≈ütƒ±rma Tipi</label>
                <select class="form-select" id="separationType">
                    <option value="separate_vocal">Vokal & Enstr√ºmantal (2 Kredi)</option>
                    <option value="split_stem">T√ºm Enstr√ºmanlar (5 Kredi)</option>
                </select>
            </div>

            <button class="submit-btn" id="submitBtn" onclick="startSeparation()">
                <span>Ayrƒ±≈ütƒ±rmayƒ± Ba≈ülat</span>
                <span id="costDisplay">2 Kredi</span>
            </button>

            <div id="historyArea" style="margin-top: 30px; display:none;">
                <h4 style="margin-bottom:15px; font-size:14px; color:var(--text-secondary);">GE√áMƒ∞≈û</h4>
                <div id="historyList"></div>
            </div>
        </aside>

        <main class="results-section">
            <h2 id="resultsTitle" style="margin-bottom: 20px;">Sonu√ßlar</h2>
            <div id="resultsEmpty" style="text-align: center; padding-top: 100px; color: var(--text-muted);">
                Ayrƒ±≈ütƒ±rƒ±lan par√ßalar burada g√∂r√ºnecek.
            </div>
            <div id="stemsContainer" style="display: none; flex-direction: column;"></div>
        </main>
    </div>

    <script>
        const API_BASE_URL = window.location.origin;
        let authToken = localStorage.getItem('bazai_token');
        let currentUser = null;
        let selectedTrack = null;
        let timerInterval;

        // Sayfa Y√ºklendiƒüinde
        window.onload = async () => {
            if (authToken) await syncUser();
            
            document.getElementById('separationType').onchange = (e) => {
                document.getElementById('costDisplay').innerText = e.target.value === 'separate_vocal' ? '2 Kredi' : '5 Kredi';
            };
        };

        async function syncUser() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/auth-sync`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await res.json();
                if (data.success) {
                    currentUser = data.user;
                    document.getElementById('loginBtn').style.display = 'none';
                    document.getElementById('userInfo').style.display = 'inline';
                    document.getElementById('userName').innerText = currentUser.displayName;
                    document.getElementById('userCredits').innerText = currentUser.credits;
                    loadUserData();
                }
            } catch (e) { console.error("Sync hatasƒ±", e); }
        }

        async function loadUserData() {
            const res = await fetch(`${API_BASE_URL}/api/user-data`, {
                headers: { 'Authorization': `Bearer ${authToken}` }
            });
            const json = await res.json();
            if (json.success) {
                renderTracks(json.data.tracks);
                renderHistory(json.data.stemHistory);
            }
        }

        function renderTracks(tracks) {
            const list = document.getElementById('trackList');
            list.innerHTML = '';
            tracks.forEach(t => {
                const div = document.createElement('div');
                div.className = 'track-option';
                div.innerHTML = `üéµ <span>${t.title || 'Adsƒ±z ≈ûarkƒ±'}</span>`;
                div.onclick = () => {
                    selectedTrack = t;
                    document.querySelectorAll('.track-option').forEach(el => el.classList.remove('selected'));
                    div.classList.add('selected');
                };
                list.appendChild(div);
            });
        }

        async function startSeparation() {
            if (!selectedTrack) return alert("L√ºtfen bir ≈üarkƒ± se√ßin.");
            
            const type = document.getElementById('separationType').value;
            const cost = type === 'separate_vocal' ? 2 : 5;

            if (currentUser.credits < cost) return alert("Yetersiz kredi.");

            // 1. Kredi D√º≈ü
            const creditRes = await fetch(`${API_BASE_URL}/api/use-credits`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                body: JSON.stringify({ amount: cost, action: type })
            });

            if (!creditRes.ok) return alert("Kredi i≈ülemi ba≈üarƒ±sƒ±z.");

            // 2. ƒ∞≈ülemi Ba≈ülat
            showLoading(true);
            try {
                const res = await fetch(`${API_BASE_URL}/api/stem`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                    body: JSON.stringify({ 
                        taskId: selectedTrack.taskId, 
                        audioId: selectedTrack.id, 
                        type: type 
                    })
                });
                const data = await res.json();
                const newTaskId = data.data?.taskId || data.taskId;
                
                if (newTaskId) pollStatus(newTaskId, type);
                else throw new Error("Task olu≈üturulamadƒ±");
                
            } catch (err) {
                alert("Hata: " + err.message);
                showLoading(false);
            }
        }

        async function pollStatus(tid, type) {
            const timer = setInterval(async () => {
                try {
                    const res = await fetch(`${API_BASE_URL}/api/stem-status?taskId=${tid}&wixUserId=${currentUser.wixUserId}`);
                    const json = await res.json();
                    
                    if (json.data?.status === 'success') {
                        clearInterval(timer);
                        showLoading(false);
                        displayResults(json.data.vocal_separation_info);
                        syncUser(); // Krediyi g√ºncelle
                    }
                } catch (e) { console.error("Polling error", e); }
            }, 5000);
        }

        function displayResults(stems) {
            const container = document.getElementById('stemsContainer');
            container.innerHTML = '';
            
            const mapping = [
                { key: 'vocal_url', label: 'Vokal', icon: 'üé§' },
                { key: 'instrumental_url', label: 'Enstr√ºmantal', icon: 'üé∏' },
                { key: 'drums_url', label: 'Davul', icon: 'ü•Å' },
                { key: 'bass_url', label: 'Bas', icon: 'üé∏' },
                { key: 'guitar_url', label: 'Gitar', icon: 'üé∏' },
                { key: 'piano_url', label: 'Piyano', icon: 'üéπ' }
            ];

            mapping.forEach(item => {
                if (stems[item.key]) {
                    container.innerHTML += `
                        <div class="stem-item">
                            <div class="stem-icon">${item.icon}</div>
                            <div class="stem-info">
                                <strong>${item.label}</strong>
                                <audio class="stem-audio" controls src="${stems[item.key]}"></audio>
                            </div>
                            <a href="${stems[item.key]}" target="_blank" download class="stem-btn">ƒ∞NDƒ∞R</a>
                        </div>`;
                }
            });

            document.getElementById('resultsEmpty').style.display = 'none';
            container.style.display = 'flex';
        }

        function renderHistory(history) {
            if (!history || history.length === 0) return;
            const area = document.getElementById('historyArea');
            const list = document.getElementById('historyList');
            area.style.display = 'block';
            list.innerHTML = '';
            
            history.slice(0, 10).forEach(h => {
                const item = document.createElement('div');
                item.className = 'history-item';
                item.innerHTML = `<span>üéõÔ∏è ${h.type === 'split_stem' ? 'Full' : '2-Way'}</span> <small>${new Date(h.createdAt).toLocaleDateString()}</small>`;
                item.onclick = () => displayResults(h.stems);
                list.appendChild(item);
            });
        }

        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.classList.add('active');
                let sec = 0;
                timerInterval = setInterval(() => {
                    sec++;
                    const m = Math.floor(sec/60).toString().padStart(2,'0');
                    const s = (sec%60).toString().padStart(2,'0');
                    document.getElementById('loadingTimer').innerText = `${m}:${s}`;
                }, 1000);
            } else {
                overlay.classList.remove('active');
                clearInterval(timerInterval);
                document.getElementById('loadingTimer').innerText = "00:00";
            }
        }

        function login() { window.location.href = "https://www.burakayaz.com/stem-redirect?returnUrl=" + encodeURIComponent(window.location.href); }
    </script>
</body>
</html>
