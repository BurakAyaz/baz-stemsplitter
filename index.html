<!DOCTYPE html>
<html lang="tr" data-lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BAZ AI Stem Separator</title>
    <link rel="icon" type="image/png" href="/baz-logo.png">
    <link rel="apple-touch-icon" href="/baz-logo.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #000000; --bg-secondary: #0a0a0a; --bg-tertiary: #111111;
            --bg-card: #161616; --bg-input: #1a1a1a; --bg-hover: #222222;
            --text-primary: #ffffff; --text-secondary: #a0a0a0; --text-muted: #555555;
            --accent: #2596be; --accent-light: #3ab4e0; --accent-dark: #1d7a9c;
            --border: #262626; --border-focus: #2596be; --success: #22c55e; --error: #ef4444;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg-primary); color: var(--text-primary); height: 100vh; line-height: 1.4; display: flex; flex-direction: column; }
        
        .header { display: flex; justify-content: space-between; align-items: center; padding: 8px 20px; background: var(--bg-secondary); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; }
        .logo { display: flex; align-items: center; gap: 8px; font-size: 1.2rem; font-weight: 700; color: var(--text-primary); }
        .logo-icon { width: 28px; height: 28px; background: var(--accent); border-radius: 6px; display: flex; align-items: center; justify-content: center; }
        .header-right { display: flex; align-items: center; gap: 10px; }
        .lang-switcher { display: flex; background: var(--bg-tertiary); border-radius: 6px; padding: 2px; border: 1px solid var(--border); }
        .lang-btn { padding: 4px 10px; border: none; background: transparent; color: var(--text-secondary); cursor: pointer; border-radius: 4px; font-size: 11px; font-weight: 500; transition: all 0.2s; }
        .lang-btn.active { background: var(--accent); color: var(--text-primary); }
        .lang-btn:hover:not(.active) { color: var(--text-primary); }
        
        /* ==================== KREDƒ∞ Sƒ∞STEMƒ∞ STƒ∞LLERƒ∞ ==================== */
        .credit-display {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 6px 14px;
            background: linear-gradient(135deg, rgba(37, 150, 190, 0.2), rgba(37, 150, 190, 0.05));
            border: 1px solid rgba(37, 150, 190, 0.4);
            border-radius: 10px;
            margin-right: 12px;
        }
        .credit-info { display: flex; align-items: center; gap: 6px; }
        .credit-icon { font-size: 18px; }
        .credit-count { font-size: 20px; font-weight: 700; color: #2596be; min-width: 30px; text-align: center; }
        .credit-label { font-size: 10px; color: #a0a0a0; text-transform: uppercase; }
        .credit-details { display: flex; flex-direction: column; align-items: flex-start; gap: 2px; }
        .plan-badge { font-size: 9px; font-weight: 600; padding: 2px 8px; background: #6b7280; color: white; border-radius: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
        .plan-badge.temel { background: linear-gradient(135deg, #22c55e, #16a34a); }
        .plan-badge.uzman { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .plan-badge.pro { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .plan-badge.deneme { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .plan-badge.test { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .plan-badge.none { background: #4b5563; }
        .days-left { font-size: 9px; color: #6b7280; }
        .days-left.warning { color: #f59e0b; }
        .days-left.danger { color: #ef4444; }
        .change-plan-btn { display: flex; align-items: center; gap: 4px; padding: 6px 10px; background: rgba(37, 150, 190, 0.2); border: 1px solid rgba(37, 150, 190, 0.4); color: #2596be; border-radius: 6px; font-size: 10px; font-weight: 500; text-decoration: none; transition: all 0.2s; margin-left: 8px; }
        .change-plan-btn:hover { background: #2596be; color: white; }
        .login-btn { display: flex; align-items: center; gap: 6px; padding: 8px 16px; background: linear-gradient(135deg, #2596be, #1d7a9c); color: white; border: none; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s; margin-right: 10px; }
        .login-btn:hover { background: linear-gradient(135deg, #3ab4e0, #2596be); transform: translateY(-1px); }
        .user-menu { position: relative; }
        .user-btn { display: flex; align-items: center; gap: 8px; padding: 6px 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); cursor: pointer; transition: all 0.2s; }
        .user-btn:hover { background: var(--bg-hover); }
        .user-avatar { width: 28px; height: 28px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; }
        .user-dropdown { position: absolute; top: 100%; right: 0; margin-top: 8px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; min-width: 200px; display: none; z-index: 1000; overflow: hidden; }
        .user-dropdown.active { display: block; }
        .user-dropdown-item { display: flex; align-items: center; gap: 10px; padding: 12px 16px; color: var(--text-primary); text-decoration: none; font-size: 13px; transition: background 0.2s; cursor: pointer; border: none; background: none; width: 100%; text-align: left; }
        .user-dropdown-item:hover { background: var(--bg-hover); }
        .user-dropdown-divider { height: 1px; background: var(--border); margin: 4px 0; }
        .login-modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(10px); z-index: 5000; align-items: center; justify-content: center; }
        .login-modal-overlay.active { display: flex; }
        .login-modal { background: var(--bg-card); border: 1px solid var(--border); border-radius: 20px; padding: 40px; max-width: 420px; width: 90%; text-align: center; }
        .login-modal h2 { font-size: 24px; font-weight: 700; margin-bottom: 8px; background: linear-gradient(135deg, #2596be, #3ab4e0); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .login-modal p { color: var(--text-secondary); margin-bottom: 24px; font-size: 14px; line-height: 1.5; }
        .login-modal-btn { width: 100%; padding: 14px 24px; background: linear-gradient(135deg, #2596be, #1d7a9c); color: white; border: none; border-radius: 10px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s; margin-bottom: 12px; }
        .login-modal-btn:hover { background: linear-gradient(135deg, #3ab4e0, #2596be); transform: translateY(-2px); }
        .login-modal-close { background: transparent; border: 1px solid var(--border); color: var(--text-secondary); padding: 10px 24px; border-radius: 8px; cursor: pointer; font-size: 13px; transition: all 0.2s; }
        .login-modal-close:hover { background: var(--bg-hover); color: var(--text-primary); }
        /* ==================== KREDƒ∞ Sƒ∞STEMƒ∞ STƒ∞LLERƒ∞ Bƒ∞Tƒ∞≈û ==================== */
        
        .main-container { flex: 1; display: flex; justify-content: center; align-items: flex-start; padding: 40px 20px; overflow-y: auto; }
        .content-box { width: 100%; max-width: 500px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 16px; padding: 30px; }
        
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 11px; font-weight: 500; color: var(--text-secondary); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
        .form-select, .form-input { width: 100%; padding: 12px 14px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 10px; color: var(--text-primary); font-size: 14px; font-family: inherit; transition: all 0.2s; }
        .form-select:focus, .form-input:focus { outline: none; border-color: var(--accent); }
        .form-select { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23555555' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 10px center; background-size: 16px; padding-right: 36px; cursor: pointer; }
        .form-hint { font-size: 11px; color: var(--text-muted); margin-top: 4px; }
        
        .credit-cost-badge { display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px; background: rgba(37, 150, 190, 0.2); border: 1px solid rgba(37, 150, 190, 0.4); color: var(--accent-light); border-radius: 6px; font-size: 11px; font-weight: 600; margin-left: 8px; }
        
        .submit-btn { width: 100%; padding: 14px 20px; background: var(--accent); color: white; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 24px; }
        .submit-btn:hover { background: var(--accent-light); }
        .submit-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-credit-info { font-size: 10px; opacity: 0.8; margin-left: 6px; padding: 2px 6px; background: rgba(255,255,255,0.2); border-radius: 4px; }
        
        /* Credit Warning */
        .credit-warning { background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(239, 68, 68, 0.05)); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 10px; padding: 14px; margin-bottom: 20px; display: none; }
        .credit-warning.active { display: block; }
        .credit-warning-content { display: flex; align-items: center; gap: 10px; }
        .credit-warning-icon { font-size: 24px; }
        .credit-warning-text h4 { color: #ef4444; font-size: 13px; font-weight: 600; margin-bottom: 4px; }
        .credit-warning-text p { color: #a0a0a0; font-size: 11px; }
        .credit-warning-btn { display: inline-block; margin-top: 10px; padding: 8px 16px; background: #ef4444; color: white; text-decoration: none; border-radius: 6px; font-size: 12px; font-weight: 500; transition: background 0.2s; }
        .credit-warning-btn:hover { background: #dc2626; }
        
        /* Results Section */
        .results-section { margin-top: 24px; display: none; }
        .results-section.active { display: block; }
        .results-title { font-size: 1rem; font-weight: 600; color: var(--accent); margin-bottom: 16px; text-align: center; }
        
        .stem-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 10px; margin-bottom: 10px; }
        .stem-icon { width: 40px; height: 40px; background: var(--bg-input); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .stem-info { flex: 1; }
        .stem-name { font-size: 13px; font-weight: 600; color: var(--text-primary); }
        .stem-actions { display: flex; gap: 8px; }
        .stem-btn { padding: 8px 12px; border: 1px solid var(--border); background: var(--bg-input); color: var(--text-primary); border-radius: 6px; font-size: 11px; font-weight: 500; cursor: pointer; transition: all 0.2s; text-decoration: none; }
        .stem-btn:hover { background: var(--bg-hover); border-color: var(--accent); }
        .stem-btn.primary { background: var(--accent); border-color: var(--accent); }
        .stem-btn.primary:hover { background: var(--accent-light); }
        
        /* Loading */
        .loading-overlay { display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(8px); z-index: 100; align-items: center; justify-content: center; flex-direction: column; }
        .loading-overlay.active { display: flex; }
        .loader { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { margin-top: 16px; font-size: 16px; font-weight: 500; }
        .loading-status { margin-top: 6px; font-size: 13px; color: var(--accent); }
        .loading-timer { margin-top: 10px; font-size: 18px; color: var(--accent); font-weight: 600; }
        .loading-avg { margin-top: 8px; font-size: 11px; color: var(--text-muted); }
        
        /* Messages */
        .message { padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; font-size: 13px; display: none; }
        .message.error { display: block; background: rgba(239, 68, 68, 0.15); border: 1px solid var(--error); color: #ff6b6b; }
        .message.success { display: block; background: rgba(34, 197, 94, 0.15); border: 1px solid var(--success); color: #4ade80; }
        
        /* Info Box */
        .info-box { margin-top: 12px; padding: 14px; background: rgba(37, 150, 190, 0.1); border: 1px solid rgba(37, 150, 190, 0.3); border-radius: 8px; }
        .info-box strong { display: block; font-size: 12px; color: var(--accent); margin-bottom: 6px; }
        .info-box p { font-size: 11px; color: var(--text-secondary); line-height: 1.5; margin: 0; }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent); }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loader"></div>
        <p class="loading-text" id="loadingText">Stem Ayrƒ±≈ütƒ±rma</p>
        <p class="loading-status" id="loadingStatus">ƒ∞≈üleniyor...</p>
        <p class="loading-timer" id="loadingTimer">00:00</p>
        <p class="loading-avg" id="loadingAvg">Ortalama i≈ülem s√ºresi: 1-3 dk</p>
    </div>

    <header class="header">
        <div class="logo">
            <div class="logo-icon">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M12 6v12M6 12h12"/>
                </svg>
            </div>
            BAZ AI Stem Separator
        </div>
        <div class="header-right">
            <!-- Kredi G√∂stergesi -->
            <div class="credit-display" id="creditDisplay" style="display: none;">
                <div class="credit-info">
                    <span class="credit-icon">üíé</span>
                    <span class="credit-count" id="creditCount">0</span>
                    <span class="credit-label">Kredi</span>
                </div>
                <div class="credit-details">
                    <span class="plan-badge" id="planBadge">-</span>
                    <span class="days-left" id="daysLeft"></span>
                </div>
                <a href="https://www.burakayaz.com/abonelik-sat%C4%B1n-al" class="change-plan-btn" id="changePlanBtn" title="Planƒ± Deƒüi≈ütir">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                        <path d="M2 17l10 5 10-5"/>
                        <path d="M2 12l10 5 10-5"/>
                    </svg>
                    Planƒ± Deƒüi≈ütir
                </a>
            </div>
            
            <!-- Login Butonu -->
            <button class="login-btn" id="loginBtn" onclick="showLoginModal()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                </svg>
                <span id="loginBtnText">Giri≈ü Yap</span>
            </button>
            
            <!-- Kullanƒ±cƒ± Men√ºs√º -->
            <div class="user-menu" id="userMenu" style="display: none;">
                <button class="user-btn" onclick="toggleUserDropdown()">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <span id="userName">Kullanƒ±cƒ±</span>
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                </button>
                <div class="user-dropdown" id="userDropdown">
                    <a class="user-dropdown-item" href="https://baz-test-six.vercel.app">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
                        AI Music Studio
                    </a>
                    <div class="user-dropdown-divider"></div>
                    <button class="user-dropdown-item" onclick="logout()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                        √áƒ±kƒ±≈ü Yap
                    </button>
                </div>
            </div>
            
            <div class="lang-switcher">
                <button class="lang-btn active" id="langTR" onclick="setLanguage('tr')">TR</button>
                <button class="lang-btn" id="langEN" onclick="setLanguage('en')">EN</button>
            </div>
        </div>
    </header>

    <div class="main-container">
        <div class="content-box">
            <!-- Kredi Uyarƒ±sƒ± -->
            <div class="credit-warning" id="creditWarning">
                <div class="credit-warning-content">
                    <span class="credit-warning-icon">‚ö†Ô∏è</span>
                    <div class="credit-warning-text">
                        <h4 id="creditWarningTitle">Krediniz Yetersiz</h4>
                        <p id="creditWarningMsg">Stem ayƒ±rmak i√ßin giri≈ü yapƒ±n veya paket satƒ±n alƒ±n.</p>
                    </div>
                </div>
                <a href="#" id="creditWarningBtn" class="credit-warning-btn" onclick="handleCreditWarningClick()">
                    Paket Satƒ±n Al ‚Üí
                </a>
            </div>
            
            <div class="message" id="errorMsg"></div>
            <div class="message" id="successMsg"></div>
            
            <form id="stemForm">
                <div class="form-group">
                    <label class="form-label" id="labelAudioSource">Kaynak ≈ûarkƒ±</label>
                    <select class="form-select" id="audioSource">
                        <option value="">-- ≈ûarkƒ± Se√ßin --</option>
                    </select>
                    <p class="form-hint" id="hintAudioSource">Daha √∂nce olu≈üturduƒüunuz ≈üarkƒ±lardan birini se√ßin</p>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <span id="labelSeparationType">Ayrƒ±≈ütƒ±rma Tipi</span>
                    </label>
                    <select class="form-select" id="separationType" onchange="updateCreditCost()">
                        <option value="separate_vocal">Vokal + Enstr√ºman (2 par√ßa)</option>
                        <option value="split_stem">12 Enstr√ºman (Detaylƒ±)</option>
                    </select>
                    <div class="info-box" id="separationInfo">
                        <strong id="infoTitle">Vokal + Enstr√ºman</strong>
                        <p id="infoDesc">≈ûarkƒ±nƒ±z vokal ve enstr√ºmantal olarak 2 par√ßaya ayrƒ±lƒ±r.</p>
                    </div>
                </div>
                
                <button type="submit" class="submit-btn" id="submitBtn">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 6v12M6 12h12"/>
                    </svg>
                    <span id="submitBtnText">Stem Ayƒ±r</span>
                    <span class="btn-credit-info" id="btnCreditInfo">2 Kredi</span>
                </button>
            </form>
            
            <div class="results-section" id="resultsSection">
                <h3 class="results-title" id="resultsTitle">Ayrƒ±≈ütƒ±rƒ±lan Par√ßalar</h3>
                <div id="stemsContainer"></div>
            </div>
        </div>
    </div>
    
    <!-- Login Modal -->
    <div class="login-modal-overlay" id="loginModal">
        <div class="login-modal">
            <img src="/baz-logo.png" alt="BAZ" style="width: 80px; height: 80px; border-radius: 50%; margin-bottom: 16px;">
            <h2>BAZ AI Stem Separator</h2>
            <p id="loginModalText">Stem ayƒ±rmak i√ßin hesabƒ±nƒ±za giri≈ü yapmanƒ±z gerekiyor.</p>
            <button class="login-modal-btn" onclick="redirectToWixLogin()">
                <span id="loginModalBtnText">Giri≈ü Yap / Kayƒ±t Ol</span>
            </button>
            <button class="login-modal-close" onclick="closeLoginModal()">
                <span id="loginModalCloseText">Kapat</span>
            </button>
        </div>
    </div>

    <script>
        // ==================== √áEVƒ∞Rƒ∞ Sƒ∞STEMƒ∞ ====================
        var currentLang = 'tr';
        
        var translations = {
            tr: {
                pageTitle: 'Vokal & Enstr√ºman Ayƒ±rƒ±cƒ±',
                labelAudioSource: 'Kaynak ≈ûarkƒ±',
                hintAudioSource: 'Daha √∂nce olu≈üturduƒüunuz ≈üarkƒ±lardan birini se√ßin',
                selectTrack: '-- ≈ûarkƒ± Se√ßin --',
                labelSeparationType: 'Ayrƒ±≈ütƒ±rma Tipi',
                typeVocalInst: 'Vokal + Enstr√ºman (2 par√ßa)',
                type12Stem: '12 Enstr√ºman (Detaylƒ±)',
                infoTitleVocal: 'Vokal + Enstr√ºman',
                infoDescVocal: '≈ûarkƒ±nƒ±z vokal ve enstr√ºmantal olarak 2 par√ßaya ayrƒ±lƒ±r.',
                infoTitle12: '12 Enstr√ºman',
                infoDesc12: 'Vokal, backing vocals, davul, bas, gitar, klavye, yaylƒ±lar, nefesli sazlar, vurmalƒ±lar, synth ve FX olarak ayrƒ±lƒ±r.',
                submitBtn: 'Stem Ayƒ±r',
                resultsTitle: 'Ayrƒ±≈ütƒ±rƒ±lan Par√ßalar',
                btnDownload: 'ƒ∞ndir',
                loadingText: 'Stem Ayrƒ±≈ütƒ±rma',
                loadingStatus: 'ƒ∞≈üleniyor...',
                loadingAvg: 'Ortalama i≈ülem s√ºresi: 1-3 dk',
                errorPrefix: 'Hata:',
                errorNoTrack: 'L√ºtfen bir ≈üarkƒ± se√ßin.',
                stemVocal: 'Vokal',
                stemInstrumental: 'Enstr√ºmantal',
                stemBackingVocals: 'Backing Vocals',
                stemDrums: 'Davul',
                stemBass: 'Bas',
                stemGuitar: 'Gitar',
                stemKeyboard: 'Klavye',
                stemStrings: 'Yaylƒ±lar',
                stemBrass: 'Nefesli Bakƒ±r',
                stemWoodwinds: 'Nefesli Tahta',
                stemPercussion: 'Perk√ºsyon',
                stemSynth: 'Synthesizer',
                stemFX: 'Efektler',
                creditWarningTitle: 'Krediniz Yetersiz',
                creditWarningMsg: 'Stem ayƒ±rmak i√ßin giri≈ü yapƒ±n veya paket satƒ±n alƒ±n.',
                creditWarningBtn: 'Paket Satƒ±n Al ‚Üí',
                loginModalText: 'Stem ayƒ±rmak i√ßin hesabƒ±nƒ±za giri≈ü yapmanƒ±z gerekiyor.',
                loginModalBtn: 'Giri≈ü Yap / Kayƒ±t Ol',
                loginModalClose: 'Kapat',
                loginBtn: 'Giri≈ü Yap'
            },
            en: {
                pageTitle: 'Vocal & Instrument Separator',
                labelAudioSource: 'Source Track',
                hintAudioSource: 'Select one of your previously created tracks',
                selectTrack: '-- Select Track --',
                labelSeparationType: 'Separation Type',
                typeVocalInst: 'Vocal + Instrumental (2 stems)',
                type12Stem: '12 Instruments (Detailed)',
                infoTitleVocal: 'Vocal + Instrumental',
                infoDescVocal: 'Your track will be separated into vocal and instrumental stems.',
                infoTitle12: '12 Instruments',
                infoDesc12: 'Separated into vocal, backing vocals, drums, bass, guitar, keyboard, strings, brass, woodwinds, percussion, synth and FX.',
                submitBtn: 'Separate Stems',
                resultsTitle: 'Separated Stems',
                btnDownload: 'Download',
                loadingText: 'Stem Separation',
                loadingStatus: 'Processing...',
                loadingAvg: 'Average processing time: 1-3 min',
                errorPrefix: 'Error:',
                errorNoTrack: 'Please select a track.',
                stemVocal: 'Vocal',
                stemInstrumental: 'Instrumental',
                stemBackingVocals: 'Backing Vocals',
                stemDrums: 'Drums',
                stemBass: 'Bass',
                stemGuitar: 'Guitar',
                stemKeyboard: 'Keyboard',
                stemStrings: 'Strings',
                stemBrass: 'Brass',
                stemWoodwinds: 'Woodwinds',
                stemPercussion: 'Percussion',
                stemSynth: 'Synthesizer',
                stemFX: 'Effects',
                creditWarningTitle: 'Insufficient Credits',
                creditWarningMsg: 'Please login or purchase a package to separate stems.',
                creditWarningBtn: 'Buy Package ‚Üí',
                loginModalText: 'You need to login to your account to separate stems.',
                loginModalBtn: 'Login / Register',
                loginModalClose: 'Close',
                loginBtn: 'Login'
            }
        };
        
        function setLanguage(lang) {
            currentLang = lang;
            var t = translations[lang];
            
            document.getElementById('langTR').classList.toggle('active', lang === 'tr');
            document.getElementById('langEN').classList.toggle('active', lang === 'en');
            document.documentElement.setAttribute('data-lang', lang);
            
            document.getElementById('labelAudioSource').textContent = t.labelAudioSource;
            document.getElementById('hintAudioSource').textContent = t.hintAudioSource;
            document.getElementById('labelSeparationType').textContent = t.labelSeparationType;
            document.getElementById('submitBtnText').textContent = t.submitBtn;
            document.getElementById('resultsTitle').textContent = t.resultsTitle;
            document.getElementById('loadingText').textContent = t.loadingText;
            document.getElementById('loadingStatus').textContent = t.loadingStatus;
            document.getElementById('loadingAvg').textContent = t.loadingAvg;
            document.getElementById('creditWarningTitle').textContent = t.creditWarningTitle;
            document.getElementById('creditWarningMsg').textContent = t.creditWarningMsg;
            document.getElementById('creditWarningBtn').textContent = t.creditWarningBtn;
            document.getElementById('loginModalText').textContent = t.loginModalText;
            document.getElementById('loginModalBtnText').textContent = t.loginModalBtn;
            document.getElementById('loginModalCloseText').textContent = t.loginModalClose;
            document.getElementById('loginBtnText').textContent = t.loginBtn;
            
            // Update dropdown options
            var sepType = document.getElementById('separationType');
            sepType.options[0].text = t.typeVocalInst;
            sepType.options[1].text = t.type12Stem;
            
            updateSeparationInfo();
            updateTrackDropdown();
        }
        
        function updateSeparationInfo() {
            var t = translations[currentLang];
            var type = document.getElementById('separationType').value;
            var infoTitle = document.getElementById('infoTitle');
            var infoDesc = document.getElementById('infoDesc');
            
            if (type === 'separate_vocal') {
                infoTitle.textContent = t.infoTitleVocal;
                infoDesc.textContent = t.infoDescVocal;
            } else {
                infoTitle.textContent = t.infoTitle12;
                infoDesc.textContent = t.infoDesc12;
            }
        }
        
        // ==================== TIMER ====================
        var timerInterval = null;
        var timerSeconds = 0;
        
        function startTimer() {
            timerSeconds = 0;
            document.getElementById('loadingTimer').textContent = '00:00';
            timerInterval = setInterval(function() {
                timerSeconds++;
                var mins = Math.floor(timerSeconds / 60);
                var secs = timerSeconds % 60;
                document.getElementById('loadingTimer').textContent = 
                    String(mins).padStart(2, '0') + ':' + String(secs).padStart(2, '0');
            }, 1000);
        }
        
        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }
        
        // ==================== MESAJLAR ====================
        function showError(msg) {
            var el = document.getElementById('errorMsg');
            el.textContent = msg;
            el.classList.add('error');
            setTimeout(function() { el.classList.remove('error'); el.textContent = ''; }, 5000);
        }
        
        function showSuccess(msg) {
            var el = document.getElementById('successMsg');
            el.textContent = msg;
            el.classList.add('success');
            setTimeout(function() { el.classList.remove('success'); el.textContent = ''; }, 3000);
        }
        
        // ==================== TRACK DROPDOWN ====================
        function updateTrackDropdown() {
            var t = translations[currentLang];
            var select = document.getElementById('audioSource');
            var savedTracks = JSON.parse(localStorage.getItem('bazai_tracks') || '[]');
            
            select.innerHTML = '<option value="">' + t.selectTrack + '</option>';
            
            savedTracks.forEach(function(track) {
                var opt = document.createElement('option');
                opt.value = JSON.stringify({ taskId: track.taskId, audioId: track.audioId });
                opt.textContent = track.title || 'Track';
                select.appendChild(opt);
            });
        }
        
        // ==================== KREDƒ∞ MALƒ∞YETƒ∞ ====================
        function getCreditCost() {
            var type = document.getElementById('separationType').value;
            return type === 'separate_vocal' ? 2 : 5;
        }
        
        function updateCreditCost() {
            var cost = getCreditCost();
            document.getElementById('btnCreditInfo').textContent = cost + ' Kredi';
            updateSeparationInfo();
            checkCreditWarning();
        }
        
        // ==================== KREDƒ∞ Sƒ∞STEMƒ∞ ====================
        let authToken = localStorage.getItem('bazai_token') || null;
        let currentUser = null;
        let userCredits = 0;
        let userPlan = 'none';
        let isLoggedIn = false;
        
        const WIX_SITE_URL = 'https://www.burakayaz.com';
        const WIX_LOGIN_URL = WIX_SITE_URL + '/baz-redirect';
        const WIX_PRICING_URL = WIX_SITE_URL + '/abonelik-sat%C4%B1n-al';
        
        let creditCheckInterval = null;
        const CREDIT_CHECK_INTERVAL = 30000;
        
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthStatus();
            startCreditCheck();
            updateCreditCost();
        });
        
        function startCreditCheck() {
            if (creditCheckInterval) clearInterval(creditCheckInterval);
            creditCheckInterval = setInterval(function() {
                if (isLoggedIn && authToken) refreshCredits();
            }, CREDIT_CHECK_INTERVAL);
        }
        
        async function refreshCredits() {
            try {
                var response = await fetch('/api/auth-sync', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + authToken
                    }
                });
                
                if (response.ok) {
                    var data = await response.json();
                    if (data.success && data.user) {
                        var newCredits = data.user.credits || data.user.available || 0;
                        var newPlan = data.user.plan || data.user.planId || 'none';
                        
                        if (newCredits !== userCredits || newPlan !== userPlan) {
                            userCredits = newCredits;
                            userPlan = newPlan;
                            currentUser = data.user;
                            updateCreditDisplay();
                            checkCreditWarning();
                        }
                    }
                }
            } catch (error) {
                console.log('Kredi yenileme hatasƒ±:', error);
            }
        }
        
        async function checkAuthStatus() {
            var urlParams = new URLSearchParams(window.location.search);
            var tokenFromUrl = urlParams.get('token');
            
            if (tokenFromUrl) {
                authToken = tokenFromUrl;
                localStorage.setItem('bazai_token', tokenFromUrl);
                window.history.replaceState({}, document.title, window.location.pathname);
            }
            
            if (authToken) {
                await syncUserData();
            } else {
                showLoggedOutState();
            }
            
            updateTrackDropdown();
        }
        
        async function syncUserData() {
            try {
                var response = await fetch('/api/auth-sync', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + authToken
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        logout();
                        return;
                    }
                    throw new Error('Sync failed');
                }
                
                var data = await response.json();
                
                if (data.success && data.user) {
                    currentUser = data.user;
                    userCredits = data.user.credits || data.user.available || 0;
                    userPlan = data.user.plan || data.user.planId || 'none';
                    isLoggedIn = true;
                    
                    showLoggedInState();
                    updateCreditDisplay();
                    checkCreditWarning();
                } else {
                    showLoggedOutState();
                }
            } catch (error) {
                console.error('User sync error:', error);
                showLoggedOutState();
            }
        }
        
        function showLoggedInState() {
            document.getElementById('loginBtn').style.display = 'none';
            document.getElementById('creditDisplay').style.display = 'flex';
            document.getElementById('userMenu').style.display = 'block';
            
            if (currentUser) {
                var name = currentUser.displayName || (currentUser.email ? currentUser.email.split('@')[0] : 'Kullanƒ±cƒ±');
                document.getElementById('userName').textContent = name;
                document.getElementById('userAvatar').textContent = name.charAt(0).toUpperCase();
            }
        }
        
        function showLoggedOutState() {
            isLoggedIn = false;
            document.getElementById('loginBtn').style.display = 'flex';
            document.getElementById('creditDisplay').style.display = 'none';
            document.getElementById('userMenu').style.display = 'none';
            checkCreditWarning();
        }
        
        function updateCreditDisplay() {
            document.getElementById('creditCount').textContent = userCredits;
            
            var planBadge = document.getElementById('planBadge');
            var planName = userPlan.toLowerCase();
            
            var planDisplayNames = {
                'temel': 'TEMEL',
                'uzman': 'UZMAN',
                'pro': 'PRO',
                'deneme': 'DENEME',
                'test': 'TEST',
                'none': '-'
            };
            
            planBadge.textContent = planDisplayNames[planName] || userPlan.toUpperCase();
            planBadge.className = 'plan-badge ' + planName;
            
            if (currentUser && currentUser.planExpiry) {
                var expiry = new Date(currentUser.planExpiry);
                var now = new Date();
                var daysLeft = Math.ceil((expiry - now) / (1000 * 60 * 60 * 24));
                
                var daysLeftEl = document.getElementById('daysLeft');
                if (daysLeft > 0) {
                    daysLeftEl.textContent = daysLeft + ' g√ºn kaldƒ±';
                    daysLeftEl.className = 'days-left' + (daysLeft <= 3 ? ' danger' : daysLeft <= 7 ? ' warning' : '');
                } else {
                    daysLeftEl.textContent = 'S√ºre doldu';
                    daysLeftEl.className = 'days-left danger';
                }
            }
        }
        
        function checkCreditWarning() {
            var warning = document.getElementById('creditWarning');
            var cost = getCreditCost();
            
            if (!isLoggedIn) {
                warning.classList.add('active');
                document.getElementById('creditWarningBtn').onclick = function() { showLoginModal(); return false; };
                document.getElementById('creditWarningBtn').textContent = currentLang === 'tr' ? 'Giri≈ü Yap ‚Üí' : 'Login ‚Üí';
            } else if (userCredits < cost) {
                warning.classList.add('active');
                document.getElementById('creditWarningBtn').onclick = function() { window.location.href = WIX_PRICING_URL; return false; };
                document.getElementById('creditWarningBtn').textContent = translations[currentLang].creditWarningBtn;
            } else {
                warning.classList.remove('active');
            }
        }
        
        function handleCreditWarningClick() {
            if (!isLoggedIn) {
                showLoginModal();
            } else {
                window.location.href = WIX_PRICING_URL;
            }
            return false;
        }
        
        function canProcess() {
            var cost = getCreditCost();
            if (!isLoggedIn) {
                showLoginModal();
                return false;
            }
            if (userCredits < cost) {
                showError(currentLang === 'tr' ? 'Yetersiz kredi! (' + cost + ' kredi gerekli)' : 'Insufficient credits! (' + cost + ' credits required)');
                return false;
            }
            return true;
        }
        
        async function useCreditsForStem(amount, actionType) {
            if (authToken) {
                try {
                    var response = await fetch('/api/use-credits', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + authToken
                        },
                        body: JSON.stringify({
                            amount: amount,
                            action: actionType
                        })
                    });
                    
                    var data = await response.json();
                    
                    if (data.success) {
                        userCredits = data.data.remainingCredits;
                        console.log('Kredi harcandƒ± (' + actionType + '). Kalan:', userCredits);
                    } else {
                        console.error('Kredi kaydetme hatasƒ±:', data.error);
                        userCredits = Math.max(0, userCredits - amount);
                    }
                } catch (error) {
                    console.error('Kredi API hatasƒ±:', error);
                    userCredits = Math.max(0, userCredits - amount);
                }
            } else {
                userCredits = Math.max(0, userCredits - amount);
            }
            
            updateCreditDisplay();
            checkCreditWarning();
        }
        
        // ==================== LOGIN MODAL ====================
        function showLoginModal() {
            document.getElementById('loginModal').classList.add('active');
        }
        
        function closeLoginModal() {
            document.getElementById('loginModal').classList.remove('active');
        }
        
        function redirectToWixLogin() {
            var currentUrl = window.location.origin + window.location.pathname;
            var loginUrl = WIX_LOGIN_URL + '?redirect=' + encodeURIComponent(currentUrl);
            window.location.href = loginUrl;
        }
        
        function toggleUserDropdown() {
            document.getElementById('userDropdown').classList.toggle('active');
        }
        
        function logout() {
            authToken = null;
            currentUser = null;
            userCredits = 0;
            userPlan = 'none';
            isLoggedIn = false;
            localStorage.removeItem('bazai_token');
            showLoggedOutState();
            document.getElementById('userDropdown').classList.remove('active');
        }
        
        // Close dropdown on outside click
        window.onclick = function(event) {
            var userMenu = document.getElementById('userMenu');
            var dropdown = document.getElementById('userDropdown');
            if (userMenu && dropdown && !userMenu.contains(event.target)) {
                dropdown.classList.remove('active');
            }
            
            var loginModal = document.getElementById('loginModal');
            if (event.target === loginModal) {
                closeLoginModal();
            }
        }
        
        // ==================== FORM SUBMIT ====================
        document.getElementById('stemForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            var t = translations[currentLang];
            
            // Kredi kontrol√º
            if (!canProcess()) return;
            
            var audioSourceValue = document.getElementById('audioSource').value;
            if (!audioSourceValue) {
                showError(t.errorPrefix + ' ' + t.errorNoTrack);
                return;
            }
            
            var audioData = JSON.parse(audioSourceValue);
            var taskId = audioData.taskId;
            var audioId = audioData.audioId;
            var separationType = document.getElementById('separationType').value;
            var creditCost = getCreditCost();
            
            document.getElementById('loadingOverlay').classList.add('active');
            document.getElementById('resultsSection').classList.remove('active');
            startTimer();
            
            try {
                var res = await fetch('/api/stem', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        taskId: taskId,
                        audioId: audioId,
                        type: separationType,
                        callBackUrl: 'https://google.com'
                    })
                });
                
                var data = await res.json();
                if (!res.ok || (data.code !== 200 && !data.taskId)) {
                    throw new Error(data.msg || data.error || data.details || 'Hata');
                }
                
                var newTaskId = data.data ? data.data.taskId : data.taskId;
                
                // Kredi harcama
                var actionType = separationType === 'separate_vocal' ? 'stem_vocal' : 'stem_12';
                await useCreditsForStem(creditCost, actionType);
                
                pollStemStatus(newTaskId, separationType);
                
            } catch (err) {
                stopTimer();
                document.getElementById('loadingOverlay').classList.remove('active');
                showError(t.errorPrefix + ' ' + err.message);
            }
        });
        
        async function pollStemStatus(taskId, separationType) {
            var t = translations[currentLang];
            var attempts = 0;
            
            var interval = setInterval(async function() {
                attempts++;
                document.getElementById('loadingStatus').textContent = t.loadingStatus + ' (' + attempts + ')';
                
                try {
                    var res = await fetch('/api/stem-status?taskId=' + taskId);
                    var json = await res.json();
                    
                    if (json.code === 200 && json.data && json.data.vocal_separation_info) {
                        clearInterval(interval);
                        stopTimer();
                        document.getElementById('loadingOverlay').classList.remove('active');
                        displayStemResults(json.data.vocal_separation_info, separationType);
                    }
                } catch (e) {
                    console.error('Poll error:', e);
                }
            }, 5000);
        }
        
        function displayStemResults(info, separationType) {
            var t = translations[currentLang];
            var container = document.getElementById('stemsContainer');
            container.innerHTML = '';
            
            var stems = [];
            
            if (separationType === 'separate_vocal') {
                if (info.vocal_url) stems.push({ name: t.stemVocal, url: info.vocal_url, icon: 'üé§' });
                if (info.instrumental_url) stems.push({ name: t.stemInstrumental, url: info.instrumental_url, icon: 'üé∏' });
            } else {
                if (info.vocal_url) stems.push({ name: t.stemVocal, url: info.vocal_url, icon: 'üé§' });
                if (info.backing_vocals_url) stems.push({ name: t.stemBackingVocals, url: info.backing_vocals_url, icon: 'üéôÔ∏è' });
                if (info.drums_url) stems.push({ name: t.stemDrums, url: info.drums_url, icon: 'ü•Å' });
                if (info.bass_url) stems.push({ name: t.stemBass, url: info.bass_url, icon: 'üé∏' });
                if (info.guitar_url) stems.push({ name: t.stemGuitar, url: info.guitar_url, icon: 'üé∏' });
                if (info.keyboard_url) stems.push({ name: t.stemKeyboard, url: info.keyboard_url, icon: 'üéπ' });
                if (info.strings_url) stems.push({ name: t.stemStrings, url: info.strings_url, icon: 'üéª' });
                if (info.brass_url) stems.push({ name: t.stemBrass, url: info.brass_url, icon: 'üé∫' });
                if (info.woodwinds_url) stems.push({ name: t.stemWoodwinds, url: info.woodwinds_url, icon: 'üé∑' });
                if (info.percussion_url) stems.push({ name: t.stemPercussion, url: info.percussion_url, icon: 'ü™ò' });
                if (info.synth_url) stems.push({ name: t.stemSynth, url: info.synth_url, icon: 'üéõÔ∏è' });
                if (info.fx_url) stems.push({ name: t.stemFX, url: info.fx_url, icon: '‚ú®' });
            }
            
            stems.forEach(function(stem) {
                var html = '<div class="stem-item">' +
                    '<div class="stem-icon">' + stem.icon + '</div>' +
                    '<div class="stem-info">' +
                        '<div class="stem-name">' + stem.name + '</div>' +
                        '<audio controls src="' + stem.url + '" style="width:100%; height:32px; margin-top:6px;"></audio>' +
                    '</div>' +
                    '<div class="stem-actions">' +
                        '<a href="' + stem.url + '" download class="stem-btn primary">' + t.btnDownload + '</a>' +
                    '</div>' +
                '</div>';
                container.innerHTML += html;
            });
            
            document.getElementById('resultsSection').classList.add('active');
        }
        
        // Initialize
        setLanguage('tr');
    </script>
</body>
</html>
