<!DOCTYPE html>
<html lang="tr" data-lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BAZ AI Stem Separator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #000000; --bg-secondary: #0a0a0a; --bg-tertiary: #111111;
            --bg-card: #161616; --bg-input: #1a1a1a; --bg-hover: #222222;
            --text-primary: #ffffff; --text-secondary: #a0a0a0; --text-muted: #555555;
            --accent: #2596be; --accent-light: #3ab4e0; --accent-dark: #1d7a9c;
            --border: #262626; --border-focus: #2596be; --success: #22c55e; --error: #ef4444;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-primary); color: var(--text-primary); height: 100vh; display: flex; flex-direction: column; }
        
        /* Header & Auth Styles */
        .header { display: flex; justify-content: space-between; align-items: center; padding: 12px 24px; background: var(--bg-secondary); border-bottom: 1px solid var(--border); }
        .header-right { display: flex; align-items: center; gap: 15px; }
        .credit-display { display: flex; align-items: center; gap: 10px; padding: 6px 12px; background: rgba(37, 150, 190, 0.1); border: 1px solid var(--accent); border-radius: 8px; }
        .credit-count { font-size: 18px; font-weight: 700; color: var(--accent); }
        .plan-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; font-weight: 700; background: #4b5563; }
        .plan-badge.pro { background: #8b5cf6; }
        .plan-badge.uzman { background: #3b82f6; }

        .user-menu { position: relative; }
        .user-btn { background: var(--bg-tertiary); border: 1px solid var(--border); color: white; padding: 6px 12px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .user-dropdown { position: absolute; top: 100%; right: 0; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; margin-top: 10px; display: none; z-index: 1000; min-width: 150px; }
        .user-dropdown.active { display: block; }
        .user-dropdown button { width: 100%; padding: 10px; background: none; border: none; color: white; cursor: pointer; text-align: left; }
        .user-dropdown button:hover { background: var(--bg-hover); }

        /* Main Content */
        .main-container { flex: 1; display: flex; justify-content: center; padding: 40px 20px; overflow-y: auto; }
        .content-box { width: 100%; max-width: 600px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 16px; padding: 30px; }
        
        /* Tabs */
        .tab-switcher { display: flex; background: var(--bg-tertiary); border-radius: 8px; padding: 4px; border: 1px solid var(--border); margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 10px; border: none; background: transparent; color: var(--text-secondary); cursor: pointer; border-radius: 6px; transition: 0.2s; }
        .tab-btn.active { background: var(--accent); color: white; }

        /* Forms */
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 8px; text-transform: uppercase; }
        .form-select, .form-input { width: 100%; padding: 12px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 10px; color: white; }
        .submit-btn { width: 100%; padding: 15px; background: var(--accent); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 700; margin-top: 10px; }
        
        /* Results */
        .stem-item { display: flex; align-items: center; gap: 15px; padding: 15px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 10px; }
        .stem-icon { font-size: 24px; }
        .stem-info { flex: 1; }
        .stem-btn { padding: 8px 15px; background: var(--accent); color: white; border-radius: 6px; text-decoration: none; font-size: 12px; }

        /* Loading Overlay */
        .loading-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; align-items: center; justify-content: center; flex-direction: column; }
        .loading-overlay.active { display: flex; }
        .loader { width: 50px; height: 50px; border: 4px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loader"></div>
        <p style="margin-top: 20px; font-size: 18px;" id="loadingStatus">Ä°ÅŸlem HazÄ±rlanÄ±yor...</p>
        <p id="loadingTimer" style="font-size: 24px; color: var(--accent); font-weight: 700; margin-top: 10px;">00:00</p>
    </div>

    <header class="header">
        <div class="logo">BAZ AI Stem Separator</div>
        <div class="header-right">
            <div class="credit-display" id="creditDisplay" style="display: none;">
                <span class="credit-count" id="creditCount">0</span>
                <span style="font-size: 10px; color: var(--text-secondary);">KREDÄ°</span>
                <span class="plan-badge" id="planBadge">-</span>
            </div>
            <button class="user-btn" id="loginBtn" onclick="redirectToWixLogin()">GiriÅŸ Yap</button>
            <div class="user-menu" id="userMenu" style="display: none;">
                <button class="user-btn" onclick="toggleUserDropdown()">
                    <span id="userName">KullanÄ±cÄ±</span>
                </button>
                <div class="user-dropdown" id="userDropdown">
                    <button onclick="logout()">Ã‡Ä±kÄ±ÅŸ Yap</button>
                </div>
            </div>
        </div>
    </header>

    <div class="main-container">
        <div class="content-box">
            <h2 style="text-align: center; margin-bottom: 20px;">Vokal & EnstrÃ¼man AyÄ±rÄ±cÄ±</h2>
            
            <div class="message" id="errorMsg" style="color: var(--error); margin-bottom: 10px; display: none;"></div>

            <form id="stemForm">
                <div class="form-group">
                    <label class="form-label">Kaynak SeÃ§imi</label>
                    <div class="tab-switcher">
                        <button type="button" class="tab-btn active" onclick="switchInputMode('saved', this)">KayÄ±tlÄ± ÅžarkÄ±lar</button>
                        <button type="button" class="tab-btn" onclick="switchInputMode('manual', this)">Manuel GiriÅŸ</button>
                    </div>
                </div>

                <div id="savedInputSection">
                    <div class="form-group">
                        <label class="form-label">ÅžarkÄ± SeÃ§in</label>
                        <select class="form-select" id="audioSource">
                            <option value="">-- ÅžarkÄ± SeÃ§in --</option>
                        </select>
                    </div>
                </div>

                <div id="manualInputSection" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Task ID</label>
                        <input type="text" class="form-input" id="manualTaskId" placeholder="Ã–rn: 5c79...">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Audio ID</label>
                        <input type="text" class="form-input" id="manualAudioId" placeholder="Ã–rn: e231...">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">AyÄ±rma TÃ¼rÃ¼</label>
                    <select class="form-select" id="separationType">
                        <option value="separate_vocal">Vokal + EnstrÃ¼mantal (2 ParÃ§a)</option>
                        <option value="split_stem">DetaylÄ± AyrÄ±ÅŸtÄ±rma (12 ParÃ§a)</option>
                    </select>
                </div>

                <button type="submit" class="submit-btn" id="submitBtn">AYRIÅžTIRMAYI BAÅžLAT (1 Kredi)</button>
            </form>

            <div id="resultsSection" style="margin-top: 30px; display: none;">
                <h3 style="color: var(--accent); margin-bottom: 15px;">SonuÃ§lar</h3>
                <div id="stemsContainer"></div>
            </div>
        </div>
    </div>

    <script>
        // --- AUTH & STATE ---
        let authToken = localStorage.getItem('bazai_token') || null;
        let currentUser = null;
        let userCredits = 0;
        let isLoggedIn = false;
        let timerInterval = null;

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            checkAuthStatus();
            loadTracksFromLocal();
        });

        async function checkAuthStatus() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            if (token) {
                authToken = token;
                localStorage.setItem('bazai_token', token);
                window.history.replaceState({}, document.title, window.location.pathname);
            }
            if (authToken) await syncUser();
        }

        async function syncUser() {
            try {
                const res = await fetch('/api/auth-sync', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` }
                });
                const data = await res.json();
                if (data.success) {
                    currentUser = data.user;
                    userCredits = data.user.credits || 0;
                    isLoggedIn = true;
                    updateUI();
                }
            } catch (e) { console.error("Sync Error", e); }
        }

        function updateUI() {
            document.getElementById('loginBtn').style.display = 'none';
            document.getElementById('userMenu').style.display = 'block';
            document.getElementById('creditDisplay').style.display = 'flex';
            document.getElementById('creditCount').textContent = userCredits;
            document.getElementById('planBadge').textContent = currentUser.plan.toUpperCase();
            document.getElementById('planBadge').className = 'plan-badge ' + currentUser.plan.toLowerCase();
            document.getElementById('userName').textContent = currentUser.displayName || 'KullanÄ±cÄ±';
        }

        function redirectToWixLogin() {
            window.location.href = 'https://www.burakayaz.com/kapak-redirect?redirect=' + encodeURIComponent(window.location.href);
        }

        function logout() { localStorage.removeItem('bazai_token'); location.reload(); }
        function toggleUserDropdown() { document.getElementById('userDropdown').classList.toggle('active'); }

        // --- CORE FEATURES ---
        function switchInputMode(mode, btn) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('savedInputSection').style.display = mode === 'saved' ? 'block' : 'none';
            document.getElementById('manualInputSection').style.display = mode === 'manual' ? 'block' : 'none';
        }

        function loadTracksFromLocal() {
            const tracks = JSON.parse(localStorage.getItem('bazai_tracks') || '[]');
            const select = document.getElementById('audioSource');
            tracks.filter(t => t.taskId && t.audioId).forEach(track => {
                const opt = document.createElement('option');
                opt.value = JSON.stringify({ t: track.taskId, a: track.audioId });
                opt.textContent = track.title || "AdsÄ±z ÅžarkÄ±";
                select.appendChild(opt);
            });
        }

        // --- SUBMISSION & POLLING ---
        document.getElementById('stemForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isLoggedIn) return redirectToWixLogin();
            if (userCredits < 1) return alert("Yetersiz Kredi!");

            let taskId, audioId;
            const mode = document.querySelector('.tab-btn.active').textContent;

            if (mode === 'KayÄ±tlÄ± ÅžarkÄ±lar') {
                const val = document.getElementById('audioSource').value;
                if (!val) return alert("ÅžarkÄ± seÃ§in!");
                const parsed = JSON.parse(val);
                taskId = parsed.t; audioId = parsed.a;
            } else {
                taskId = document.getElementById('manualTaskId').value;
                audioId = document.getElementById('manualAudioId').value;
                if (!taskId || !audioId) return alert("ID'leri girin!");
            }

            document.getElementById('loadingOverlay').classList.add('active');
            startTimer();

            try {
                // Kredi dÃ¼ÅŸ
                await fetch('/api/use-credits', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                    body: JSON.stringify({ amount: 1, action: 'stem_separation' })
                });

                const res = await fetch('/api/stem', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ taskId, audioId, type: document.getElementById('separationType').value })
                });
                const data = await res.json();
                pollStatus(data.taskId || data.data.taskId);
            } catch (err) { alert("Hata oluÅŸtu!"); resetUI(); }
        });

        async function pollStatus(id) {
            const interval = setInterval(async () => {
                const res = await fetch(`/api/stem-status?taskId=${id}`);
                const data = await res.json();
                if (data.code === 200 && data.data.vocal_separation_info) {
                    clearInterval(interval);
                    stopTimer();
                    displayResults(data.data.vocal_separation_info);
                }
            }, 5000);
        }

        function displayResults(info) {
            const container = document.getElementById('stemsContainer');
            container.innerHTML = '';
            document.getElementById('loadingOverlay').classList.remove('active');
            document.getElementById('resultsSection').style.display = 'block';

            const stems = [
                { n: 'Vokal', u: info.vocal_url, i: 'ðŸŽ¤' },
                { n: 'EnstrÃ¼mantal', u: info.instrumental_url, i: 'ðŸŽ¸' },
                { n: 'Davul', u: info.drums_url, i: 'ðŸ¥' },
                { n: 'Bas', u: info.bass_url, i: 'ðŸŽ¸' }
            ].filter(s => s.u);

            stems.forEach(s => {
                container.innerHTML += `
                    <div class="stem-item">
                        <span class="stem-icon">${s.i}</span>
                        <div class="stem-info">
                            <div style="font-weight:700;">${s.n}</div>
                            <audio controls src="${s.u}" style="width:100%; height:30px; margin-top:5px;"></audio>
                        </div>
                        <a href="${s.u}" download class="stem-btn">Ä°NDÄ°R</a>
                    </div>
                `;
            });
        }

        function startTimer() {
            let sec = 0;
            timerInterval = setInterval(() => {
                sec++;
                const m = Math.floor(sec / 60).toString().padStart(2, '0');
                const s = (sec % 60).toString().padStart(2, '0');
                document.getElementById('loadingTimer').textContent = `${m}:${s}`;
            }, 1000);
        }
        function stopTimer() { clearInterval(timerInterval); }
        function resetUI() { document.getElementById('loadingOverlay').classList.remove('active'); stopTimer(); }
    </script>
</body>
</html>
