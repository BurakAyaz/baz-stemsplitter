<!DOCTYPE html>
<html lang="tr" data-lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BAZ AI Stem Separator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --bg-primary: #000000; --bg-secondary: #0a0a0a; --bg-tertiary: #111111;
            --bg-card: #161616; --bg-input: #1a1a1a; --bg-hover: #222222;
            --text-primary: #ffffff; --text-secondary: #a0a0a0; --text-muted: #555555;
            --accent: #2596be; --accent-light: #3ab4e0; --accent-dark: #1d7a9c;
            --border: #262626; --border-focus: #2596be; --success: #22c55e; --error: #ef4444;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; line-height: 1.4; }
        
        /* Header - Sabit */
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 8px 16px; 
            background: var(--bg-secondary); 
            border-bottom: 1px solid var(--border); 
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            min-height: 52px;
        }
        .logo { display: flex; align-items: center; gap: 8px; font-size: 1.1rem; font-weight: 700; color: var(--text-primary); }
        .logo-img { width: 32px; height: 32px; border-radius: 50%; background: var(--accent); display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 700; }
        .header-right { display: flex; align-items: center; gap: 8px; }
        .lang-switcher { display: flex; background: var(--bg-tertiary); border-radius: 6px; padding: 2px; border: 1px solid var(--border); }
        .lang-btn { padding: 4px 8px; border: none; background: transparent; color: var(--text-secondary); cursor: pointer; border-radius: 4px; font-size: 10px; font-weight: 500; transition: all 0.2s; }
        .lang-btn.active { background: var(--accent); color: var(--text-primary); }
        .lang-btn:hover:not(.active) { color: var(--text-primary); }
        
        /* Kredi Sistemi - Kompakt */
        .credit-display { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            padding: 4px 10px; 
            background: linear-gradient(135deg, rgba(37, 150, 190, 0.2), rgba(37, 150, 190, 0.05)); 
            border: 1px solid rgba(37, 150, 190, 0.4); 
            border-radius: 8px;
        }
        .credit-info { display: flex; align-items: center; gap: 4px; }
        .credit-icon { font-size: 12px; font-weight: 700; color: var(--accent); }
        .credit-count { font-size: 16px; font-weight: 700; color: #2596be; min-width: 24px; text-align: center; }
        .credit-label { font-size: 9px; color: #a0a0a0; text-transform: uppercase; display: none; }
        .credit-details { display: flex; flex-direction: column; align-items: flex-start; gap: 1px; }
        .plan-badge { font-size: 8px; font-weight: 600; padding: 2px 6px; background: #6b7280; color: white; border-radius: 3px; text-transform: uppercase; }
        .plan-badge.temel { background: linear-gradient(135deg, #22c55e, #16a34a); }
        .plan-badge.uzman { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .plan-badge.pro { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .plan-badge.deneme, .plan-badge.test { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .plan-badge.none { background: #4b5563; }
        .days-left { font-size: 8px; color: #6b7280; }
        .days-left.warning { color: #f59e0b; }
        .days-left.danger { color: #ef4444; }
        .change-plan-btn { display: none; }
        
        /* Login Button */
        .login-btn { 
            display: flex; 
            align-items: center; 
            gap: 5px; 
            padding: 6px 12px; 
            background: linear-gradient(135deg, #2596be, #1d7a9c); 
            color: white; 
            border: none; 
            border-radius: 6px; 
            font-size: 11px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s; 
            text-decoration: none;
            white-space: nowrap;
        }
        .login-btn:hover { background: linear-gradient(135deg, #3ab4e0, #2596be); }
        .login-btn svg { width: 14px; height: 14px; }
        
        /* User Menu */
        .user-menu { position: relative; }
        .user-btn { display: flex; align-items: center; gap: 6px; padding: 4px 8px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); cursor: pointer; transition: all 0.2s; }
        .user-btn:hover { background: var(--bg-hover); }
        .user-avatar { width: 24px; height: 24px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 600; }
        .user-btn span { font-size: 11px; max-width: 80px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .user-dropdown { position: absolute; top: 100%; right: 0; margin-top: 8px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; min-width: 180px; display: none; z-index: 1000; overflow: hidden; }
        .user-dropdown.active { display: block; }
        .user-dropdown-item { display: flex; align-items: center; gap: 10px; padding: 12px 16px; color: var(--text-primary); text-decoration: none; font-size: 13px; transition: background 0.2s; cursor: pointer; border: none; background: none; width: 100%; text-align: left; }
        .user-dropdown-item:hover { background: var(--bg-hover); }
        .user-dropdown-divider { height: 1px; background: var(--border); margin: 4px 0; }
        
        /* Main Layout */
        .main-container { 
            display: flex; 
            margin-top: 52px;
            min-height: calc(100vh - 52px);
        }
        .sidebar { 
            width: 340px; 
            background: var(--bg-secondary); 
            border-right: 1px solid var(--border); 
            padding: 12px 14px; 
            overflow-y: auto; 
            flex-shrink: 0;
            max-height: calc(100vh - 52px);
        }
        .results-section { 
            flex: 1; 
            padding: 16px; 
            background: var(--bg-primary); 
            overflow-y: auto;
            position: relative;
            max-height: calc(100vh - 52px);
        }
        
        /* Form Elements */
        .section-title { font-size: 13px; font-weight: 600; color: var(--accent); margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }
        .form-group { margin-bottom: 14px; }
        .form-label { display: block; font-size: 10px; font-weight: 500; color: var(--text-secondary); margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px; }
        .form-select, .form-input { width: 100%; padding: 9px 11px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 7px; color: var(--text-primary); font-size: 12px; font-family: inherit; transition: all 0.2s; }
        .form-select:focus, .form-input:focus { outline: none; border-color: var(--accent); }
        .form-select { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23555555' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 8px center; background-size: 14px; padding-right: 32px; cursor: pointer; }
        .form-hint { font-size: 9px; color: var(--text-muted); margin-top: 3px; }
        .info-box { padding: 10px; background: rgba(37, 150, 190, 0.1); border: 1px solid rgba(37, 150, 190, 0.3); border-radius: 7px; margin-bottom: 10px; }
        .info-box strong { display: block; font-size: 10px; color: var(--accent); margin-bottom: 3px; }
        .info-box p { font-size: 9px; color: var(--text-secondary); line-height: 1.4; margin: 0; }
        .submit-btn { width: 100%; padding: 11px 14px; background: var(--accent); color: white; border: none; border-radius: 7px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .submit-btn:hover { background: var(--accent-light); }
        .submit-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .credit-badge { display: inline-block; padding: 2px 6px; background: rgba(255, 255, 255, 0.15); color: white; border-radius: 4px; font-size: 10px; font-weight: 700; margin-left: 6px; border: 1px solid rgba(255, 255, 255, 0.2); }
        
        /* Results */
        .results-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; }
        .results-title { font-size: 15px; font-weight: 600; color: var(--accent); }
        .results-empty { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 200px; text-align: center; color: var(--text-muted); }
        .results-empty svg { width: 48px; height: 48px; margin-bottom: 12px; opacity: 0.3; color: var(--accent); }
        .results-empty p { font-size: 12px; max-width: 250px; }
        .stems-container { display: flex; flex-direction: column; gap: 10px; }
        .stem-item { display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; transition: all 0.2s; }
        .stem-item:hover { border-color: var(--accent); }
        .stem-icon { width: 40px; height: 40px; background: var(--bg-tertiary); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; }
        .stem-info { flex: 1; min-width: 0; }
        .stem-name { font-size: 13px; font-weight: 600; color: var(--text-primary); margin-bottom: 3px; }
        .stem-audio { width: 100%; height: 32px; margin-top: 4px; }
        .stem-btn { padding: 6px 10px; border: 1px solid var(--border); background: var(--bg-tertiary); color: var(--text-primary); border-radius: 5px; font-size: 10px; font-weight: 500; cursor: pointer; transition: all 0.2s; text-decoration: none; display: flex; align-items: center; gap: 3px; flex-shrink: 0; }
        .stem-btn:hover { background: var(--bg-hover); border-color: var(--accent); }
        .stem-btn.primary { background: var(--accent); border-color: var(--accent); color: white; }
        .stem-btn.primary:hover { background: var(--accent-light); }
        
        /* History */
        .history-section { margin-top: 20px; border-top: 1px solid var(--border); padding-top: 16px; }
        .history-title { font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: 10px; }
        .history-item { display: flex; align-items: center; gap: 10px; padding: 8px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; margin-bottom: 6px; cursor: pointer; transition: all 0.2s; }
        .history-item:hover { border-color: var(--accent); }
        .history-icon { font-size: 16px; }
        .history-info { flex: 1; min-width: 0; }
        .history-name { font-size: 11px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .history-date { font-size: 9px; color: var(--text-muted); }
        .history-type { font-size: 8px; padding: 2px 5px; background: var(--bg-tertiary); border-radius: 3px; color: var(--text-secondary); flex-shrink: 0; }
        
        /* Download All Button */
        .results-actions { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        .action-btn { 
            display: flex; 
            align-items: center; 
            gap: 6px; 
            padding: 8px 14px; 
            border: 1px solid var(--border);
            border-radius: 6px; 
            font-size: 12px; 
            font-weight: 500; 
            cursor: pointer; 
            transition: all 0.2s;
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        .action-btn:hover { 
            border-color: var(--accent);
            background: var(--bg-hover);
        }
        .action-btn.primary { 
            background: var(--accent); 
            border-color: var(--accent);
            color: white;
        }
        .action-btn.primary:hover { 
            background: var(--accent-light);
        }
        .action-btn.secondary { 
            background: var(--bg-tertiary);
        }
        .action-btn.downloading { 
            opacity: 0.7;
            cursor: wait;
        }
        .action-btn svg { flex-shrink: 0; }
        
        /* Current Stem Name Display */
        .current-stem-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--accent);
            margin-top: 6px;
            padding: 6px 10px;
            background: rgba(37, 150, 190, 0.1);
            border: 1px solid rgba(37, 150, 190, 0.2);
            border-radius: 5px;
            display: inline-block;
        }
        
        /* Mobile optimizations */
        @media (max-width: 480px) {
            .results-actions { 
                justify-content: stretch;
            }
            .action-btn {
                flex: 1;
                justify-content: center;
                padding: 10px 12px;
                font-size: 11px;
            }
            .current-stem-name {
                font-size: 12px;
                padding: 5px 8px;
            }
        }
        
        /* Loading - Inline (Sadece Sonu√ßlar B√∂l√ºm√ºnde) */
        .loading-inline { 
            display: none; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            padding: 40px 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            text-align: center;
        }
        .loading-inline.active { display: flex; }
        .loading-inline .loader { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-inline .loading-text { margin-top: 14px; font-size: 14px; font-weight: 500; }
        .loading-inline .loading-status { margin-top: 6px; font-size: 12px; color: var(--accent); }
        .loading-inline .loading-timer { margin-top: 10px; font-size: 20px; color: var(--accent); font-weight: 600; }
        .loading-inline .loading-avg { margin-top: 6px; font-size: 10px; color: var(--text-muted); }
        
        /* Messages */
        .message { padding: 10px 14px; border-radius: 7px; margin-bottom: 10px; font-size: 11px; display: none; }
        .message.error { display: block; background: rgba(239, 68, 68, 0.15); border: 1px solid var(--error); color: #ff6b6b; }
        .message.success { display: block; background: rgba(34, 197, 94, 0.15); border: 1px solid var(--success); color: #4ade80; }
        
        /* Track List */
        .track-list { max-height: 180px; overflow-y: auto; border: 1px solid var(--border); border-radius: 7px; margin-bottom: 10px; }
        .track-option { display: flex; align-items: center; gap: 8px; padding: 8px 10px; cursor: pointer; transition: all 0.2s; border-bottom: 1px solid var(--border); }
        .track-option:last-child { border-bottom: none; }
        .track-option:hover { background: var(--bg-hover); }
        .track-option.selected { background: rgba(37, 150, 190, 0.2); border-color: var(--accent); }
        .track-option-icon { font-size: 14px; }
        .track-option-info { flex: 1; min-width: 0; }
        .track-option-title { font-size: 11px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .track-option-meta { font-size: 9px; color: var(--text-muted); }
        .track-option-check { width: 16px; height: 16px; border: 2px solid var(--border); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .track-option.selected .track-option-check { background: var(--accent); border-color: var(--accent); }
        .track-option.selected .track-option-check::after { content: '‚úì'; color: white; font-size: 9px; }
        .empty-tracks { padding: 20px; text-align: center; color: var(--text-muted); }
        .empty-tracks svg { width: 32px; height: 32px; margin-bottom: 6px; opacity: 0.4; }
        .empty-tracks p { font-size: 11px; }
        .loading-tracks { padding: 16px; text-align: center; color: var(--text-muted); }
        .loading-tracks .spinner { width: 20px; height: 20px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 6px; }
        
        /* Credit Warning */
        .credit-warning { background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(239, 68, 68, 0.05)); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; padding: 12px; margin-bottom: 12px; display: none; }
        .credit-warning.active { display: block; }
        .credit-warning-content { display: flex; align-items: center; gap: 8px; }
        .credit-warning-icon { font-size: 20px; }
        .credit-warning-text h4 { color: #ef4444; font-size: 12px; font-weight: 600; margin-bottom: 2px; }
        .credit-warning-text p { color: #a0a0a0; font-size: 10px; }
        .credit-warning-btn { display: inline-block; margin-top: 8px; padding: 6px 12px; background: #ef4444; color: white; text-decoration: none; border-radius: 5px; font-size: 11px; font-weight: 500; transition: background 0.2s; border: none; cursor: pointer; }
        .credit-warning-btn:hover { background: #dc2626; }
        
        /* Mobile Styles */
        @media (max-width: 768px) {
            .header { padding: 6px 10px; min-height: 48px; }
            .logo { font-size: 1rem; }
            .logo-img { width: 28px; height: 28px; font-size: 14px; }
            .header-right { gap: 6px; }
            
            .credit-display { padding: 3px 8px; gap: 6px; }
            .credit-count { font-size: 14px; min-width: 20px; }
            .plan-badge { font-size: 7px; padding: 1px 4px; }
            .days-left { font-size: 7px; }
            
            .login-btn { padding: 5px 10px; font-size: 10px; gap: 4px; }
            .login-btn svg { width: 12px; height: 12px; }
            
            .user-btn { padding: 3px 6px; gap: 4px; }
            .user-avatar { width: 22px; height: 22px; font-size: 9px; }
            .user-btn span { font-size: 10px; max-width: 60px; }
            .user-btn svg { width: 10px; height: 10px; }
            
            .lang-btn { padding: 3px 6px; font-size: 9px; }
            
            .main-container { 
                flex-direction: column; 
                margin-top: 48px;
                min-height: calc(100vh - 48px);
            }
            .sidebar { 
                width: 100%; 
                border-right: none; 
                border-bottom: 1px solid var(--border); 
                max-height: none;
                overflow-y: visible;
                padding: 10px 12px;
            }
            .results-section { 
                max-height: none;
                padding: 12px;
                min-height: 300px;
            }
            
            .section-title { font-size: 12px; }
            .form-label { font-size: 9px; }
            .form-select, .form-input { padding: 8px 10px; font-size: 11px; }
            .submit-btn { padding: 10px 12px; font-size: 11px; }
            .credit-badge { font-size: 9px; padding: 2px 5px; }
            
            .track-list { max-height: 150px; }
            .track-option { padding: 7px 8px; gap: 6px; }
            .track-option-title { font-size: 10px; }
            .track-option-check { width: 14px; height: 14px; }
            
            .results-title { font-size: 13px; }
            .stem-item { padding: 10px; gap: 8px; }
            .stem-icon { width: 36px; height: 36px; font-size: 16px; }
            .stem-name { font-size: 12px; }
            .stem-audio { height: 28px; }
            .stem-btn { padding: 5px 8px; font-size: 9px; }
            
            .loading-inline { padding: 30px 15px; }
            .loading-inline .loader { width: 32px; height: 32px; }
            .loading-inline .loading-text { font-size: 12px; }
            .loading-inline .loading-timer { font-size: 18px; }
        }
        
        @media (max-width: 400px) {
            .login-btn span { display: none; }
            .user-btn span { display: none; }
            .credit-display { padding: 2px 6px; }
            .credit-count { font-size: 12px; }
            .plan-badge { display: none; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="logo">
            <div class="logo-img">üéµ</div>
        </div>
        <div class="header-right">
            <!-- Kredi G√∂stergesi -->
            <div class="credit-display" id="creditDisplay" style="display: none;">
                <div class="credit-info">
                    <span class="credit-icon">K</span>
                    <span class="credit-count" id="creditCount">0</span>
                    <span class="credit-label">Kredi</span>
                </div>
                <div class="credit-details">
                    <span class="plan-badge" id="planBadge">-</span>
                    <span class="days-left" id="daysLeft"></span>
                </div>
                <a href="https://pricing.burakayaz.com" class="change-plan-btn" id="changePlanBtn" title="Planƒ± Deƒüi≈ütir" target="_blank">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                        <path d="M2 17l10 5 10-5"/>
                        <path d="M2 12l10 5 10-5"/>
                    </svg>
                    Planƒ± Deƒüi≈ütir
                </a>
            </div>
            
            <!-- Login Butonu - Direkt Wix'e y√∂nlendirir -->
            <a href="#" class="login-btn" id="loginBtn" onclick="redirectToWixLogin(); return false;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                </svg>
                <span id="loginBtnText">Ba≈ülat</span>
            </a>
            
            <!-- Kullanƒ±cƒ± Men√ºs√º -->
            <div class="user-menu" id="userMenu" style="display: none;">
                <button class="user-btn" onclick="toggleUserDropdown()">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <span id="userName">Kullanƒ±cƒ±</span>
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                </button>
                <div class="user-dropdown" id="userDropdown">
                    <button class="user-dropdown-item" onclick="showAccountInfo()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg>
                        Hesap Bilgileri
                    </button>
                    <div class="user-dropdown-divider"></div>
                    <button class="user-dropdown-item" onclick="logout()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                        √áƒ±kƒ±≈ü Yap
                    </button>
                </div>
            </div>
            
            <div class="lang-switcher">
                <button class="lang-btn active" id="langTR" onclick="setLanguage('tr')">TR</button>
                <button class="lang-btn" id="langEN" onclick="setLanguage('en')">EN</button>
            </div>
        </div>
    </header>
    
    <!-- Main Container -->
    <div class="main-container">
        <div class="sidebar">
            <div class="section-title"><span>üéõÔ∏è</span><span id="sidebarTitle">Stem Ayrƒ±≈ütƒ±rma</span></div>
            
            <!-- Kredi Uyarƒ±sƒ± -->
            <div class="credit-warning" id="creditWarning">
                <div class="credit-warning-content">
                    <span class="credit-warning-icon">‚ö†Ô∏è</span>
                    <div class="credit-warning-text">
                        <h4 id="creditWarningTitle">Ba≈ülatmak ƒ∞√ßin Giri≈ü Yapƒ±n</h4>
                        <p id="creditWarningMsg">Stem ayrƒ±≈ütƒ±rma i√ßin giri≈ü yapmanƒ±z gerekiyor.</p>
                    </div>
                </div>
                <button id="creditWarningBtn" class="credit-warning-btn" onclick="handleCreditWarningClick()">Ba≈ülat ‚Üí</button>
            </div>
            
            <div class="message" id="errorMsg"></div>
            <div class="message" id="successMsg"></div>
            
            <form id="stemForm">
                <div class="form-group">
                    <label class="form-label" id="labelSelectTrack">≈ûarkƒ±larƒ±m</label>
                    <div class="track-list" id="trackList">
                        <div class="empty-tracks" id="emptyTracks">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"/></svg>
                            <p id="emptyTracksText">Hen√ºz ≈üarkƒ±nƒ±z yok veya giri≈ü yapmadƒ±nƒ±z</p>
                        </div>
                    </div>
                    <p class="form-hint" id="hintSelectTrack">BAZ AI'da olu≈üturduƒüunuz ≈üarkƒ±lar otomatik y√ºklenir</p>
                </div>
                
                <div class="form-group">
                    <label class="form-label" id="labelSeparationType">Ayrƒ±≈ütƒ±rma Tipi</label>
                    <select class="form-select" id="separationType">
                        <option value="separate_vocal">Vokal & Enstr√ºmantal (2 Stem) - 2 Kredi</option>
                        <option value="split_stem">Detaylƒ± Ayrƒ±≈ütƒ±rma (12 Stem) - 5 Kredi</option>
                    </select>
                    <p class="form-hint" id="hintSeparationType">Detaylƒ± ayrƒ±≈ütƒ±rma daha uzun s√ºrer</p>
                </div>
                
                <div class="form-group">
                    <label class="form-label" id="labelStemName">Ayrƒ±≈ütƒ±rma ƒ∞smi (Opsiyonel)</label>
                    <input type="text" class="form-input" id="stemName" placeholder="√ñrn: ≈ûarkƒ±m - Remix" maxlength="50">
                    <p class="form-hint" id="hintStemName">Ge√ßmi≈ü ayrƒ±≈ütƒ±rmalarda bu isimle g√∂r√ºn√ºr</p>
                </div>
                
                <div class="info-box"><strong id="infoTitle">Stem Ayrƒ±≈ütƒ±rma Nedir?</strong><p id="infoDesc">≈ûarkƒ±nƒ±zƒ± vokal, bas, davul, gitar gibi ayrƒ± par√ßalara ayƒ±rƒ±r.</p></div>
<button type="submit" class="submit-btn" id="submitBtn">
    <span>üéµ</span>
    <span id="submitText">Ayrƒ±≈ütƒ±rmayƒ± Ba≈ülat</span>
    <span class="credit-badge" id="creditCost">2 Kredi</span> 
</button>            </form>
        </div>
        <div class="results-section">
            <div class="results-header">
                <h2 class="results-title" id="resultsTitle">Sonu√ßlar</h2>
                <div class="current-stem-name" id="currentStemName" style="display: none;"></div>
            </div>
            
            <!-- Inline Loading (Sadece sonu√ßlar b√∂l√ºm√ºnde) -->
            <div class="loading-inline" id="loadingInline">
                <div class="loader"></div>
                <p class="loading-text" id="loadingText">Stem Ayrƒ±≈ütƒ±rma</p>
                <p class="loading-status" id="loadingStatus">ƒ∞≈üleniyor...</p>
                <p class="loading-timer" id="loadingTimer">00:00</p>
                <p class="loading-avg" id="loadingAvg">Ortalama i≈ülem s√ºresi: 1-3 dk</p>
            </div>
            
            <div class="results-empty" id="resultsEmpty">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"/></svg>
                <p id="emptyResultsText">Stem ayrƒ±≈ütƒ±rma sonu√ßlarƒ±nƒ±z burada g√∂r√ºnecek.</p>
            </div>
            
            <!-- Toplu ƒ∞ndir ve Kapat Butonlarƒ± -->
            <div class="results-actions" id="resultsActions" style="display: none;">
                <button class="action-btn primary" id="downloadAllBtn" onclick="downloadAllAsZip()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    <span id="downloadAllText">ZIP ƒ∞ndir</span>
                </button>
                <button class="action-btn secondary" onclick="closeResults()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                    <span id="closeResultsText">Kapat</span>
                </button>
            </div>
            
            <div class="stems-container" id="stemsContainer" style="display: none;"></div>
            <div class="history-section" id="historySection" style="display: none;"><h3 class="history-title" id="historyTitle">Ge√ßmi≈ü Ayrƒ±≈ütƒ±rmalar</h3><div id="historyList"></div></div>
        </div>
    </div>
    <script>
        // ==================== GLOBAL DEƒûƒ∞≈ûKENLER ====================
        var currentLang = 'tr';
        var authToken = localStorage.getItem('bazai_token') || null;
        var currentUser = null;
        var userCredits = 0;
        var userPlan = 'none';
        var isLoggedIn = false;
        var userTracks = [];
        var selectedTrack = null;
        var stemHistory = [];
        var timerInterval = null;
        var timerSeconds = 0;
        var currentStems = []; // T√ºm√ºn√º indir i√ßin mevcut stemleri tutar
        
        // API ve Wix URL'leri
        var API_BASE_URL = window.location.origin;
        var WIX_SITE_URL = 'https://www.burakayaz.com';
        var WIX_LOGIN_URL = WIX_SITE_URL + '/stem-redirect';
        var WIX_PRICING_URL = 'https://pricing.burakayaz.com';
        
        // ==================== √áEVƒ∞Rƒ∞LER ====================
        var translations = {
            tr: {
                sidebarTitle: 'Stem Ayrƒ±≈ütƒ±rma', labelSelectTrack: '≈ûarkƒ±larƒ±m',
                emptyTracksText: 'Hen√ºz ≈üarkƒ±nƒ±z yok veya giri≈ü yapmadƒ±nƒ±z',
                hintSelectTrack: 'BAZ AI\'da olu≈üturduƒüunuz ≈üarkƒ±lar otomatik y√ºklenir',
                labelSeparationType: 'Ayrƒ±≈ütƒ±rma Tipi', optionVocal: 'Vokal & Enstr√ºmantal (2 Stem) - 2 Kredi',
                optionSplit: 'Detaylƒ± Ayrƒ±≈ütƒ±rma (12 Stem) - 5 Kredi', hintSeparationType: 'Detaylƒ± ayrƒ±≈ütƒ±rma daha uzun s√ºrer',
                infoTitle: 'Stem Ayrƒ±≈ütƒ±rma Nedir?', infoDesc: '≈ûarkƒ±nƒ±zƒ± vokal, bas, davul, gitar gibi ayrƒ± par√ßalara ayƒ±rƒ±r.',
                submitText: 'Ayrƒ±≈ütƒ±rmayƒ± Ba≈ülat', resultsTitle: 'Sonu√ßlar',
                emptyResultsText: 'Stem ayrƒ±≈ütƒ±rma sonu√ßlarƒ±nƒ±z burada g√∂r√ºnecek.', historyTitle: 'Ge√ßmi≈ü Ayrƒ±≈ütƒ±rmalar',
                loadingText: 'Stem Ayrƒ±≈ütƒ±rma', loadingStatus: 'ƒ∞≈üleniyor...', loadingAvg: 'Ortalama i≈ülem s√ºresi: 1-3 dk',
                btnDownload: 'ƒ∞ndir', stemVocal: 'Vokal', stemInstrumental: 'Enstr√ºmantal', stemDrums: 'Davul', stemBass: 'Bas',
                stemGuitar: 'Gitar', stemKeyboard: 'Klavye', stemStrings: 'Yaylƒ±lar', stemBrass: 'Bakƒ±r √úflemeli',
                stemWoodwinds: 'Tahta √úflemeli', stemPercussion: 'Perk√ºsyon', stemSynth: 'Synth', stemFX: 'Efektler',
                stemBackingVocals: 'Arka Vokal', errorPrefix: 'Hata:', errorNoTrack: 'L√ºtfen bir ≈üarkƒ± se√ßin',
                successStem: 'Stem ayrƒ±≈ütƒ±rma tamamlandƒ±!', loadingTracks: '≈ûarkƒ±lar y√ºkleniyor...',
                creditCost2: '2 Kredi', creditCost5: '5 Kredi', insufficientCredits: 'Yetersiz kredi',
                loginBtn: 'Ba≈ülat',
                warningLoginTitle: 'Ba≈ülatmak ƒ∞√ßin Giri≈ü Yapƒ±n', warningLoginMsg: 'Stem ayrƒ±≈ütƒ±rma i√ßin giri≈ü yapmanƒ±z gerekiyor.',
                warningCreditTitle: 'Krediniz Bitti', warningCreditMsg: 'Stem ayrƒ±≈ütƒ±rma i√ßin yeni paket satƒ±n alƒ±n.',
                warningExpiredTitle: 'Paket S√ºresi Doldu', warningExpiredMsg: 'Paket s√ºreniz doldu, yenilemek i√ßin tƒ±klayƒ±n.',
                buyPackage: 'Paket Satƒ±n Al ‚Üí', renewPackage: 'Paketi Yenile ‚Üí',
                stemNameLabel: 'Ayrƒ±≈ütƒ±rma ƒ∞smi', stemNamePlaceholder: '√ñrn: ≈ûarkƒ±m - Remix',
                downloadAll: 'ZIP ƒ∞ndir', downloading: 'ƒ∞ndiriliyor...', closeResults: 'Kapat'
            },
            en: {
                sidebarTitle: 'Stem Separation', labelSelectTrack: 'My Songs',
                emptyTracksText: 'No songs yet or not logged in',
                hintSelectTrack: 'Songs created in BAZ AI are loaded automatically',
                labelSeparationType: 'Separation Type', optionVocal: 'Vocal & Instrumental (2 Stems) - 2 Credits',
                optionSplit: 'Detailed Separation (12 Stems) - 5 Credits', hintSeparationType: 'Detailed separation takes longer',
                infoTitle: 'What is Stem Separation?', infoDesc: 'Separates your song into individual parts like vocals, bass, drums, guitar.',
                submitText: 'Start Separation', resultsTitle: 'Results',
                emptyResultsText: 'Your stem separation results will appear here.', historyTitle: 'Previous Separations',
                loadingText: 'Stem Separation', loadingStatus: 'Processing...', loadingAvg: 'Average processing time: 1-3 min',
                btnDownload: 'Download', stemVocal: 'Vocal', stemInstrumental: 'Instrumental', stemDrums: 'Drums', stemBass: 'Bass',
                stemGuitar: 'Guitar', stemKeyboard: 'Keyboard', stemStrings: 'Strings', stemBrass: 'Brass',
                stemWoodwinds: 'Woodwinds', stemPercussion: 'Percussion', stemSynth: 'Synth', stemFX: 'Effects',
                stemBackingVocals: 'Backing Vocals', errorPrefix: 'Error:', errorNoTrack: 'Please select a song',
                successStem: 'Stem separation completed!', loadingTracks: 'Loading songs...',
                creditCost2: '2 Credits', creditCost5: '5 Credits', insufficientCredits: 'Insufficient credits',
                loginBtn: 'Start',
                warningLoginTitle: 'Login to Start', warningLoginMsg: 'You need to login for stem separation.',
                warningCreditTitle: 'Out of Credits', warningCreditMsg: 'Purchase a package for stem separation.',
                warningExpiredTitle: 'Package Expired', warningExpiredMsg: 'Your package has expired, click to renew.',
                buyPackage: 'Buy Package ‚Üí', renewPackage: 'Renew Package ‚Üí',
                stemNameLabel: 'Separation Name', stemNamePlaceholder: 'E.g: My Song - Remix',
                downloadAll: 'ZIP Download', downloading: 'Downloading...', closeResults: 'Close'
            }
        };
        
        // ==================== AUTH Sƒ∞STEMƒ∞ ====================
        function redirectToWixLogin() {
            var returnUrl = encodeURIComponent(window.location.href);
            window.location.href = WIX_LOGIN_URL + '?returnUrl=' + returnUrl;
        }
        
        async function checkAuthStatus() {
            var urlParams = new URLSearchParams(window.location.search);
            var tokenFromUrl = urlParams.get('token');
            
            if (tokenFromUrl) {
                authToken = tokenFromUrl;
                localStorage.setItem('bazai_token', tokenFromUrl);
                window.history.replaceState({}, document.title, window.location.pathname);
            }
            
            if (authToken) {
                await syncUserData();
            } else {
                showLoggedOutState();
            }
        }
        
        async function syncUserData() {
            try {
                var response = await fetch(API_BASE_URL + '/api/auth-sync', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken }
                });
                
                if (!response.ok) {
                    if (response.status === 401) { logout(); return; }
                    throw new Error('Sync failed');
                }
                
                var data = await response.json();
                
                if (data.success && data.user) {
                    currentUser = data.user;
                    userCredits = data.user.credits || data.user.available || 0;
                    userPlan = data.user.plan || data.user.planId || 'none';
                    isLoggedIn = true;
                    
                    showLoggedInState();
                    updateCreditDisplay();
                    checkCreditWarning();
                    await loadUserTracksFromMongoDB();
                    loadStemHistory();
                } else {
                    showLoggedOutState();
                }
            } catch (error) {
                console.error('User sync error:', error);
                showLoggedOutState();
            }
        }
        
        function showLoggedInState() {
            document.getElementById('loginBtn').style.display = 'none';
            document.getElementById('creditDisplay').style.display = 'flex';
            document.getElementById('userMenu').style.display = 'block';
            
            if (currentUser) {
                var name = currentUser.displayName || (currentUser.email ? currentUser.email.split('@')[0] : 'Kullanƒ±cƒ±');
                document.getElementById('userName').textContent = name;
                document.getElementById('userAvatar').textContent = name.charAt(0).toUpperCase();
            }
        }
        
        function showLoggedOutState() {
            isLoggedIn = false;
            currentUser = null;
            userCredits = 0;
            userPlan = 'none';
            
            document.getElementById('loginBtn').style.display = 'flex';
            document.getElementById('creditDisplay').style.display = 'none';
            document.getElementById('userMenu').style.display = 'none';
            checkCreditWarning();
            renderTrackList();
        }
        
        function updateCreditDisplay() {
            var creditCount = document.getElementById('creditCount');
            var planBadge = document.getElementById('planBadge');
            var daysLeft = document.getElementById('daysLeft');
            
            creditCount.textContent = userCredits;
            
            if (userCredits <= 5) { creditCount.style.color = '#ef4444'; }
            else if (userCredits <= 15) { creditCount.style.color = '#f59e0b'; }
            else { creditCount.style.color = '#2596be'; }
            
            var planNames = { 'none': '√úcretsiz', 'temel': 'Temel', 'uzman': 'Uzman', 'pro': 'Pro', 'deneme': 'Deneme', 'test': 'Test', 'free': '√úcretsiz' };
            planBadge.textContent = planNames[userPlan] || userPlan;
            planBadge.className = 'plan-badge ' + userPlan;
            
            if (currentUser && currentUser.daysRemaining !== undefined) {
                var days = currentUser.daysRemaining;
                if (days > 0) {
                    daysLeft.textContent = days + ' g√ºn kaldƒ±';
                    daysLeft.className = 'days-left' + (days <= 7 ? ' warning' : '');
                } else if (userPlan !== 'none' && userPlan !== 'free') {
                    daysLeft.textContent = 'S√ºre doldu!';
                    daysLeft.className = 'days-left danger';
                } else { daysLeft.textContent = ''; }
            } else { daysLeft.textContent = ''; }
        }
        
        function checkCreditWarning() {
            var t = translations[currentLang];
            var warning = document.getElementById('creditWarning');
            var submitBtn = document.getElementById('submitBtn');
            var warningTitle = document.getElementById('creditWarningTitle');
            var warningMsg = document.getElementById('creditWarningMsg');
            var warningBtn = document.getElementById('creditWarningBtn');
            
            var showWarning = false;
            
            if (!isLoggedIn) {
                showWarning = true;
                warningTitle.textContent = t.warningLoginTitle;
                warningMsg.textContent = t.warningLoginMsg;
                warningBtn.textContent = t.loginBtn + ' ‚Üí';
            } else if (userCredits <= 0) {
                showWarning = true;
                warningTitle.textContent = t.warningCreditTitle;
                warningMsg.textContent = t.warningCreditMsg;
                warningBtn.textContent = t.buyPackage;
            } else if (currentUser && currentUser.daysRemaining !== undefined && currentUser.daysRemaining <= 0 && userPlan !== 'none' && userPlan !== 'free') {
                showWarning = true;
                warningTitle.textContent = t.warningExpiredTitle;
                warningMsg.textContent = t.warningExpiredMsg;
                warningBtn.textContent = t.renewPackage;
            }
            
            if (showWarning) {
                warning.classList.add('active');
                if (submitBtn) submitBtn.disabled = true;
            } else {
                warning.classList.remove('active');
                if (submitBtn) submitBtn.disabled = false;
            }
        }
        
        function handleCreditWarningClick() {
            if (!isLoggedIn) { redirectToWixLogin(); }
            else { window.open(WIX_PRICING_URL, '_blank'); }
            return false;
        }
        
        // User Dropdown
        function toggleUserDropdown() { document.getElementById('userDropdown').classList.toggle('active'); }
        function logout() {
            authToken = null;
            localStorage.removeItem('bazai_token');
            showLoggedOutState();
        }
        function showAccountInfo() {
            var info = 'Plan: ' + (userPlan || '-').toUpperCase() + '\n';
            info += 'Kredi: ' + userCredits + '\n';
            info += 'Email: ' + (currentUser && currentUser.email ? currentUser.email : '-');
            alert(info);
            document.getElementById('userDropdown').classList.remove('active');
        }
        
        // ==================== Dƒ∞L DEƒûƒ∞≈ûTƒ∞RME ====================
    function updateCreditCost() {
    var t = translations[currentLang];
    var separationType = document.getElementById('separationType').value;
    
    // Se√ßilen tipe g√∂re maliyeti belirle
    var costText = separationType === 'separate_vocal' ? t.creditCost2 : t.creditCost5;
    
    // Butonun yanƒ±ndaki badge'i g√ºncelle
    var creditBadge = document.getElementById('creditCost');
    if (creditBadge) {
        creditBadge.textContent = costText;
    }
}
        
        function setLanguage(lang) {
            currentLang = lang;
            var t = translations[lang];
            document.getElementById('langTR').classList.toggle('active', lang === 'tr');
            document.getElementById('langEN').classList.toggle('active', lang === 'en');
            document.getElementById('sidebarTitle').textContent = t.sidebarTitle;
            document.getElementById('labelSelectTrack').textContent = t.labelSelectTrack;
            document.getElementById('hintSelectTrack').textContent = t.hintSelectTrack;
            document.getElementById('labelSeparationType').textContent = t.labelSeparationType;
            document.getElementById('hintSeparationType').textContent = t.hintSeparationType;
            document.getElementById('infoTitle').textContent = t.infoTitle;
            document.getElementById('infoDesc').textContent = t.infoDesc;
            document.getElementById('submitText').textContent = t.submitText;
            document.getElementById('resultsTitle').textContent = t.resultsTitle;
            document.getElementById('emptyResultsText').textContent = t.emptyResultsText;
            document.getElementById('historyTitle').textContent = t.historyTitle;
            document.getElementById('loadingText').textContent = t.loadingText;
            document.getElementById('loadingStatus').textContent = t.loadingStatus;
            document.getElementById('loadingAvg').textContent = t.loadingAvg;
            document.getElementById('loginBtnText').textContent = t.loginBtn;
            var sepType = document.getElementById('separationType');
            sepType.options[0].text = t.optionVocal;
            sepType.options[1].text = t.optionSplit;
            updateCreditCost();
            checkCreditWarning();
            renderTrackList();
        }
        
        document.getElementById('separationType').addEventListener('change', updateCreditCost);
        
        // ==================== ≈ûARKI Y√ñNETƒ∞Mƒ∞ ====================
        async function loadUserTracksFromMongoDB() {
            if (!authToken) { renderTrackList(); return; }
            showLoadingTracks();
            try {
                var response = await fetch(API_BASE_URL + '/api/user-data', {
                    method: 'GET',
                    headers: { 'Authorization': 'Bearer ' + authToken }
                });
                var data = await response.json();
                if (data.success && data.data) {
                    userTracks = data.data.tracks || [];
                    stemHistory = data.data.stemHistory || [];
                    localStorage.setItem('bazai_tracks', JSON.stringify(userTracks));
                } else { userTracks = []; }
                renderTrackList();
                renderHistory();
            } catch (error) { console.error('Load tracks error:', error); userTracks = []; renderTrackList(); }
        }
        
        function showLoadingTracks() {
            var t = translations[currentLang];
            document.getElementById('trackList').innerHTML = '<div class="loading-tracks"><div class="spinner"></div><p>' + t.loadingTracks + '</p></div>';
        }
        
        function renderTrackList() {
            var container = document.getElementById('trackList');
            var t = translations[currentLang];
            if (!userTracks || userTracks.length === 0) {
                container.innerHTML = '<div class="empty-tracks"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"/></svg><p>' + t.emptyTracksText + '</p></div>';
                return;
            }
            var html = '';
            userTracks.forEach(function(track, index) {
                var isSelected = selectedTrack && selectedTrack.id === track.id;
                var date = track.addedAt ? new Date(track.addedAt).toLocaleDateString() : '';
                html += '<div class="track-option ' + (isSelected ? 'selected' : '') + '" onclick="selectTrack(' + index + ')"><span class="track-option-icon">üéµ</span><div class="track-option-info"><div class="track-option-title">' + (track.title || '≈ûarkƒ± ' + (index + 1)) + '</div><div class="track-option-meta">' + (track.style || '') + (date ? ' ‚Ä¢ ' + date : '') + '</div></div><div class="track-option-check"></div></div>';
            });
            container.innerHTML = html;
        }
        
        function selectTrack(index) { selectedTrack = userTracks[index]; renderTrackList(); }
        
        // ==================== STEM GE√áMƒ∞≈ûƒ∞ ====================
        function loadStemHistory() {
            var saved = localStorage.getItem('bazai_stem_history');
            if (saved) { try { stemHistory = JSON.parse(saved); } catch (e) { stemHistory = []; } }
            renderHistory();
        }
        
        function saveStemToHistory(stemData) {
            var historyItem = { id: Date.now(), trackName: selectedTrack ? selectedTrack.title : '≈ûarkƒ±', type: document.getElementById('separationType').value, date: new Date().toISOString(), stems: stemData };
            stemHistory.unshift(historyItem);
            if (stemHistory.length > 20) stemHistory = stemHistory.slice(0, 20);
            localStorage.setItem('bazai_stem_history', JSON.stringify(stemHistory));
            renderHistory();
        }
        
        function renderHistory() {
            var container = document.getElementById('historyList');
            var section = document.getElementById('historySection');
            if (!stemHistory || stemHistory.length === 0) { section.style.display = 'none'; return; }
            section.style.display = 'block';
            var html = '';
            stemHistory.forEach(function(item, index) {
                var date = item.createdAt ? new Date(item.createdAt).toLocaleDateString('tr-TR') : (item.date ? new Date(item.date).toLocaleDateString('tr-TR') : '');
                var typeLabel = item.type === 'separate_vocal' ? 'Vokal (2)' : 'Detaylƒ± (12)';
                var displayName = item.stemName || item.name || item.trackName || 'Stem ' + (index + 1);
                html += '<div class="history-item" onclick="showHistoryItem(' + index + ')"><span class="history-icon">üéõÔ∏è</span><div class="history-info"><div class="history-name">' + displayName + '</div><div class="history-date">' + date + '</div></div><span class="history-type">' + typeLabel + '</span></div>';
            });
            container.innerHTML = html;
        }
        
        // showHistoryItem - Ge√ßmi≈üten se√ßilen √∂ƒüeyi g√∂ster (displayName ile)
        function showHistoryItem(index) {
            var item = stemHistory[index];
            if (item && item.stems) {
                var displayName = item.stemName || item.name || item.trackName || 'Stem ' + (index + 1);
                displayStemResults(item.stems, item.type, displayName);
            }
        }
        
        // ==================== YARDIMCI FONKSƒ∞YONLAR ====================
        function startTimer() { timerSeconds = 0; updateTimerDisplay(); timerInterval = setInterval(function() { timerSeconds++; updateTimerDisplay(); }, 1000); }
        function stopTimer() { if (timerInterval) { clearInterval(timerInterval); timerInterval = null; } }
        function updateTimerDisplay() { var m = Math.floor(timerSeconds / 60); var s = timerSeconds % 60; document.getElementById('loadingTimer').textContent = String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0'); }
        function showError(msg) { var el = document.getElementById('errorMsg'); el.textContent = msg; el.classList.add('error'); el.style.display = 'block'; setTimeout(function() { el.style.display = 'none'; el.classList.remove('error'); }, 5000); }
        function showSuccess(msg) { var el = document.getElementById('successMsg'); el.textContent = msg; el.classList.add('success'); el.style.display = 'block'; setTimeout(function() { el.style.display = 'none'; el.classList.remove('success'); }, 5000); }
        
        async function useCredits(amount, action) {
            if (!authToken) return false;
            try {
                var response = await fetch(API_BASE_URL + '/api/use-credits', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                    body: JSON.stringify({ amount: amount, action: action })
                });
                var data = await response.json();
                if (data.success) { userCredits = data.data.remainingCredits; document.getElementById('creditCount').textContent = userCredits; return true; }
                return false;
            } catch (e) { console.error('Use credits error:', e); return false; }
        }
        
        // ==================== STEM AYRI≈ûTIRMA ====================
        document.getElementById('stemForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            var t = translations[currentLang];
            
            if (!isLoggedIn) { redirectToWixLogin(); return; }
            
            if (!selectedTrack) { showError(t.errorPrefix + ' ' + t.errorNoTrack); return; }
            
            var taskId = selectedTrack.taskId;
            var audioId = selectedTrack.audioId || selectedTrack.id;
            var separationType = document.getElementById('separationType').value;
            var stemName = document.getElementById('stemName').value.trim() || selectedTrack.title || 'Stem ' + new Date().toLocaleDateString('tr-TR');
            var creditCost = separationType === 'separate_vocal' ? 2 : 5;
            
            if (userCredits < creditCost) { showError(t.insufficientCredits + ' (' + userCredits + '/' + creditCost + ')'); return; }
            
            var creditSuccess = await useCredits(creditCost, separationType);
            if (!creditSuccess) { showError(t.insufficientCredits); return; }
            
            // Inline loading g√∂ster
            document.getElementById('loadingInline').classList.add('active');
            document.getElementById('stemsContainer').style.display = 'none';
            document.getElementById('resultsEmpty').style.display = 'none';
            startTimer();
            
            try {
                var res = await fetch(API_BASE_URL + '/api/stem', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                    body: JSON.stringify({ taskId: taskId, audioId: audioId, type: separationType, stemName: stemName })
                });
                var data = await res.json();
                if (!res.ok || (data.code !== 200 && !data.taskId)) { throw new Error(data.msg || data.error || data.details || 'Hata'); }
                var newTaskId = data.data ? data.data.taskId : data.taskId;
                pollStemStatus(newTaskId, separationType, stemName);
                
                // ƒ∞sim alanƒ±nƒ± temizle
                document.getElementById('stemName').value = '';
            } catch (err) { stopTimer(); document.getElementById('loadingInline').classList.remove('active'); document.getElementById('resultsEmpty').style.display = 'flex'; showError(t.errorPrefix + ' ' + err.message); }
        });
        
async function pollStemStatus(tid, type, stemName) {
    let attempts = 0;
    const t = translations[currentLang];
    
    console.log('=== POLLING BA≈ûLADI ===');
    console.log('TaskId:', tid);
    console.log('Type:', type);
    console.log('StemName:', stemName);
    
    const interval = setInterval(async function() {
        attempts++;
        document.getElementById('loadingStatus').innerText = `${t.loadingStatus} (${attempts})`;
        
        try {
            const uId = currentUser ? (currentUser.wixUserId || currentUser.id) : '';
            const url = `${API_BASE_URL}/api/stem-status?taskId=${tid}&wixUserId=${encodeURIComponent(uId)}&stemName=${encodeURIComponent(stemName || '')}`;
            
            console.log('Poll attempt', attempts, '- URL:', url);
            
            const res = await fetch(url);
            const json = await res.json();
            
            console.log('Poll response:', JSON.stringify(json));
            
            // Backend artƒ±k URL'ler dolduƒüunda success d√∂necek
            if (json.code === 200 && json.data && json.data.status === 'success' && json.data.vocal_separation_info) {
                console.log('‚úì STEM HAZIR! Sonu√ßlar g√∂steriliyor...');
                
                clearInterval(interval);
                stopTimer();
                document.getElementById('loadingInline').classList.remove('active');
                
                // Sonu√ßlarƒ± g√∂ster
                const stemInfo = json.data.vocal_separation_info;
                console.log('Stem Info:', JSON.stringify(stemInfo));
                
                displayStemResults(stemInfo, type, stemName);
                showSuccess(t.successStem);
                
                // Ge√ßmi≈ü listesini g√ºncellemek i√ßin verileri tekrar √ßek
                await loadUserData();
                return;
            }
            
            // Hala i≈üleniyor
            console.log('Hen√ºz hazƒ±r deƒüil, status:', json.data?.status || 'unknown');
            
        } catch (e) {
            console.error("Sorgulama hatasƒ±:", e);
        }
        
        if (attempts > 120) { // 10 dakika sƒ±nƒ±rƒ±
            clearInterval(interval);
            stopTimer();
            document.getElementById('loadingInline').classList.remove('active');
            document.getElementById('resultsEmpty').style.display = 'flex';
            showError("ƒ∞≈ülem zaman a≈üƒ±mƒ±na uƒüradƒ±.");
        }
    }, 5000);
}
        
// displayStemResults - Stem sonu√ßlarƒ±nƒ± g√∂ster
function displayStemResults(info, separationType, stemName) {
    console.log('=== displayStemResults √áAƒûRILDI ===');
    console.log('Info:', JSON.stringify(info));
    console.log('Type:', separationType);
    console.log('StemName:', stemName);
    
    // Null/undefined kontrol√º
    if (!info) {
        console.error('Stem info bo≈ü!');
        return;
    }
    
    var t = translations[currentLang];
    var container = document.getElementById('stemsContainer');
    container.innerHTML = '';
    var stems = [];
    var baseName = stemName || 'Stem';

    // Vokal URL'ini kontrol et
    if (info.vocal_url) {
        console.log('Vocal URL bulundu:', info.vocal_url);
        stems.push({ name: t.stemVocal, url: info.vocal_url, icon: 'üé§', filename: baseName + ' - Vokal' });
    }
    
    // Instrumental URL'ini kontrol et
    if (info.instrumental_url) {
        console.log('Instrumental URL bulundu:', info.instrumental_url);
        stems.push({ name: t.stemInstrumental, url: info.instrumental_url, icon: 'üé∏', filename: baseName + ' - Enstr√ºmantal' });
    }
    
    // Split stem i√ßin ek kontroller (12 kanal)
    if (info.drums_url) stems.push({ name: t.stemDrums, url: info.drums_url, icon: 'ü•Å', filename: baseName + ' - Davul' });
    if (info.bass_url) stems.push({ name: t.stemBass, url: info.bass_url, icon: 'üé∏', filename: baseName + ' - Bas' });
    if (info.guitar_url) stems.push({ name: t.stemGuitar, url: info.guitar_url, icon: 'üé∏', filename: baseName + ' - Gitar' });
    if (info.keyboard_url) stems.push({ name: t.stemKeyboard, url: info.keyboard_url, icon: 'üéπ', filename: baseName + ' - Klavye' });
    if (info.strings_url) stems.push({ name: t.stemStrings, url: info.strings_url, icon: 'üéª', filename: baseName + ' - Yaylƒ±lar' });
    if (info.brass_url) stems.push({ name: t.stemBrass, url: info.brass_url, icon: 'üé∫', filename: baseName + ' - Bakƒ±r √úflemeli' });
    if (info.woodwinds_url) stems.push({ name: t.stemWoodwinds, url: info.woodwinds_url, icon: 'üé∑', filename: baseName + ' - Tahta √úflemeli' });
    if (info.percussion_url) stems.push({ name: t.stemPercussion, url: info.percussion_url, icon: 'ü™ò', filename: baseName + ' - Perk√ºsyon' });
    if (info.synth_url) stems.push({ name: t.stemSynth, url: info.synth_url, icon: 'üéõÔ∏è', filename: baseName + ' - Synth' });
    if (info.fx_url) stems.push({ name: t.stemFX, url: info.fx_url, icon: '‚ú®', filename: baseName + ' - Efektler' });
    if (info.backing_vocals_url) stems.push({ name: t.stemBackingVocals, url: info.backing_vocals_url, icon: 'üéôÔ∏è', filename: baseName + ' - Arka Vokal' });

    console.log('Toplam stem sayƒ±sƒ±:', stems.length);

    if (stems.length === 0) {
        container.innerHTML = '<div class="empty-tracks"><p>Sonu√ß bulunamadƒ± - URL\'ler hen√ºz hazƒ±r deƒüil</p></div>';
        document.getElementById('downloadAllContainer').style.display = 'none';
        return;
    }

    // Global deƒüi≈ükene kaydet (T√ºm√ºn√º ƒ∞ndir i√ßin)
    currentStems = stems;

    stems.forEach(function(stem) {
        container.innerHTML += `
            <div class="stem-item">
                <div class="stem-icon">${stem.icon}</div>
                <div class="stem-info">
                    <div class="stem-name">${stem.name}</div>
                    <audio class="stem-audio" controls preload="metadata">
                        <source src="${stem.url}" type="audio/mpeg">
                        Tarayƒ±cƒ±nƒ±z audio elementi desteklemiyor.
                    </audio>
                </div>
                <div class="stem-actions">
                    <button onclick="downloadFile('${stem.url}', '${stem.filename}.mp3')" class="stem-btn primary">
                        ${t.btnDownload}
                    </button>
                </div>
            </div>`;
    });
    
    // ≈ûarkƒ± ismini g√∂ster (her zaman)
    var stemNameDisplay = document.getElementById('currentStemName');
    if (baseName) {
        stemNameDisplay.textContent = 'üéµ ' + baseName;
        stemNameDisplay.style.display = 'block';
    } else {
        stemNameDisplay.style.display = 'none';
    }
    
    // Butonlarƒ± g√∂ster
    document.getElementById('resultsActions').style.display = 'flex';
    document.getElementById('downloadAllText').textContent = t.downloadAll + ' (' + stems.length + ')';
    
    document.getElementById('resultsEmpty').style.display = 'none';
    container.style.display = 'flex';
    console.log('Sonu√ßlar g√∂sterildi!');
}

// Direkt indirme fonksiyonu (tek dosya i√ßin)
async function downloadFile(url, filename) {
    try {
        const response = await fetch(url);
        const blob = await response.blob();
        const blobUrl = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = blobUrl;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(blobUrl);
    } catch (error) {
        console.error('ƒ∞ndirme hatasƒ±:', error);
        window.open(url, '_blank');
    }
}

// T√ºm stemleri ZIP olarak indir
async function downloadAllAsZip() {
    if (!currentStems || currentStems.length === 0) {
        console.log('ƒ∞ndirilecek stem yok');
        return;
    }
    
    var t = translations[currentLang];
    var btn = document.getElementById('downloadAllBtn');
    var btnText = document.getElementById('downloadAllText');
    var originalText = btnText.textContent;
    
    btn.classList.add('downloading');
    btn.disabled = true;
    btnText.textContent = t.downloading;
    
    try {
        var zip = new JSZip();
        var stemName = document.getElementById('currentStemName').textContent.replace('üéµ ', '').trim() || 'Stems';
        
        // Her stem'i indir ve ZIP'e ekle
        for (var i = 0; i < currentStems.length; i++) {
            var stem = currentStems[i];
            btnText.textContent = t.downloading + ' (' + (i + 1) + '/' + currentStems.length + ')';
            
            try {
                var response = await fetch(stem.url);
                var blob = await response.blob();
                zip.file(stem.filename + '.mp3', blob);
            } catch (error) {
                console.error('Stem indirme hatasƒ±:', stem.filename, error);
            }
        }
        
        btnText.textContent = 'ZIP olu≈üturuluyor...';
        
        // ZIP olu≈ütur ve indir
        var zipBlob = await zip.generateAsync({ type: 'blob' });
        var zipUrl = window.URL.createObjectURL(zipBlob);
        var a = document.createElement('a');
        a.href = zipUrl;
        a.download = stemName + '.zip';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(zipUrl);
        
        console.log('ZIP indirme tamamlandƒ±!');
    } catch (error) {
        console.error('ZIP olu≈üturma hatasƒ±:', error);
        showError('ZIP olu≈üturulurken hata olu≈ütu');
    }
    
    btn.classList.remove('downloading');
    btn.disabled = false;
    btnText.textContent = originalText;
}

// Sonu√ßlarƒ± kapat
function closeResults() {
    document.getElementById('stemsContainer').style.display = 'none';
    document.getElementById('stemsContainer').innerHTML = '';
    document.getElementById('resultsActions').style.display = 'none';
    document.getElementById('currentStemName').style.display = 'none';
    document.getElementById('resultsEmpty').style.display = 'flex';
    currentStems = [];
}
        
        // ==================== BA≈ûLATMA ====================
        document.addEventListener('DOMContentLoaded', function() {
            setLanguage('tr');
            checkAuthStatus();
            
            // Sayfa y√ºklendiƒüinde otomatik olarak Ba≈ülat butonuna tƒ±kla (login yoksa)
            setTimeout(function() {
                // Eƒüer kullanƒ±cƒ± giri≈ü yapmamƒ±≈üsa Ba≈ülat butonuna otomatik tƒ±kla
                var loginBtn = document.getElementById('loginBtn');
                if (loginBtn && loginBtn.style.display !== 'none' && !authToken) {
                    console.log('Otomatik Ba≈ülat butonu tetikleniyor...');
                    loginBtn.click();
                }
            }, 500);
            
            // ≈ûarkƒ± listesini y√ºkle
            setTimeout(function() {
                if (typeof loadUserTracksFromMongoDB === 'function') {
                    loadUserTracksFromMongoDB();
                }
            }, 1500);
        });
        
        // Dropdown dƒ±≈üƒ±na tƒ±klanƒ±nca kapat
        document.addEventListener('click', function(e) {
            var dropdown = document.getElementById('userDropdown');
            var userBtn = document.querySelector('.user-btn');
            if (dropdown && userBtn && !userBtn.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.classList.remove('active');
            }
        });
    </script>
</body>
</html>
